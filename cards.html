<!-- cards.html -->
<style>
  .card{background:#000;border-radius:14px;overflow:hidden;position:relative;aspect-ratio:5/7;min-height:320px;
    box-shadow:0 8px 28px rgba(0,0,0,.35)}
  .card img.bg{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;filter:brightness(.9)}
  .grad{position:absolute;left:0;right:0;bottom:0;height:64%;background:linear-gradient(to top,rgba(0,0,0,.98),rgba(0,0,0,.05))}
  .front{position:absolute;inset:0;display:flex;flex-direction:column;justify-content:flex-end;color:#fff;padding:12px}
  .chips{display:flex;gap:6px;margin-bottom:6px}
  .chip{background:rgba(255,255,255,.16);border:1px solid rgba(255,255,255,.25);border-radius:999px;padding:2px 8px;font-size:11px;font-weight:800}
  .name{font-weight:900;font-size:20px;letter-spacing:.02em}
  .team{font-size:13px;opacity:.95}
  .right-badges{position:absolute;right:10px;bottom:10px;display:flex;flex-direction:column;gap:6px;align-items:flex-end}
  .rb{background:rgba(0,0,0,.68);border:1px solid rgba(255,255,255,.2);color:#fff;border-radius:999px;padding:6px 10px;font-size:12px;font-weight:800}

  .profile{background:#0b0f16;border:1px solid #1f2937;border-radius:12px;padding:12px}
  .profile .grid{display:grid;grid-template-columns:1fr 210px;gap:12px}
  .profile .photo{border-radius:12px;overflow:hidden;background:#111}
  .profile .photo img{width:100%;height:auto;display:block}
  .kv12{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-top:10px}
  .kv{background:#0f172a;border:1px solid #1f2937;border-radius:10px;text-align:center;padding:10px}
  .kv .k{font-size:12px;color:#9aa1ab}
  .kv .v{font-weight:800}
  @media (max-width:640px){ .profile .grid{grid-template-columns:1fr} }
</style>

<script>
(function(){
  const SHEET_ID = '1Nll3bRe4Qc726cXeKI5soLT66n7flq31LUMzpKJjsfw';
  const GVIZ = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json`;

  const $ = s=>document.querySelector(s);

  async function fetchSheet(){
    const res = await fetch(GVIZ,{cache:'no-cache'}); const text = await res.text();
    const json = JSON.parse(text.slice(text.indexOf('{'), text.lastIndexOf('}')+1));
    const cols = json.table.cols.map(c=> (c.label||c.id||'').toString().trim());
    const rows = json.table.rows.map(r=> r.c.map(c=> c?.v ?? ''));
    const firstRowIsHeader = rows.length && rows[0].every(v => typeof v === 'string' && v && v.length < 60);
    const headers = firstRowIsHeader ? rows.shift().map(h=>String(h)) : cols;
    return rows.map(r => Object.fromEntries(r.map((v,i)=>[headers[i]||`col${i}`, v])));
  }
  function normKey(s){
    return String(s||'').toLowerCase().trim()
      .replace(/\s+/g,'_').replace(/[^\w_]+/g,'')
      .replace(/class_of|gradclass|graduatingclass/,'grad_class')
      .replace(/level|currentlevel/,'level')
      .replace(/^id$|player_id|vendor_player_id/,'player_id')
      .replace(/team_parent|org|org_team/,'org_team')
      .replace(/team_affiliate|affiliate|affiliate_team/,'affiliate_team')
      .replace(/frontimg|image|img/,'front_img')
      .replace(/hsimg|hs_image|highschoolimg/,'hs_img');
  }
  function mapRow(r){
    const m={}; for(const [k,v] of Object.entries(r)) m[normKey(k)]=v;
    const up=x=>x==null?'':String(x); const upper=x=>up(x).toUpperCase();
    const id = up(m.slug||m.player_id||m.id);
    const aff = up(m.affiliate_team); const org = up(m.org_team);
    const team = aff ? `${aff} — ${org}` : org || aff;

    const batting = (m.avg||m.obp||m.slg||m.ops) ? {avg:up(m.avg),obp:up(m.obp),slg:up(m.slg),ops:up(m.ops),hits:m.h||m.hits,runs:m.r||m.runs,hr:m.hr,rbi:m.rbi,doubles:m.doubles,triples:m.triples,sb:m.sb,bb:m.bb} : undefined;
    const pitching = (!batting&&(m.era||m.whip||m.so||m.ip)) ? {era:up(m.era),whip:up(m.whip),so:m.so,ip:m.ip,oba:m.oba,kbb:m.kbb,fip:m.fip,er:m.er,hr:m.hr,qs:m.qs,w:m.w,sv:m.sv} : undefined;

    const mk3=(s)=>{const parts=String(s||'').split(/\s*[-–—]\s*|,\s*/).filter(Boolean);let date=parts[0]||'',opp=parts[1]||'',line=parts.slice(2).join(', ');if(!line&&parts.length===3)line=parts[2]; return {date:date||'—',opp:opp||'—',line:line||'—'};}
    const l1=mk3(m.last3_1||m.last_1),l2=mk3(m.last3_2||m.last_2),l3=mk3(m.last3_3||m.last_3);
    const nextGame=(m.next_game_date||m.next_game_opp)?{date:up(m.next_game_date),opponent:up(m.next_game_opp),tz:up(m.next_game_tz)}:undefined;
    const letters=up(m.letters).replace(/,/g,'|').split('|').map(x=>parseInt(x.trim(),10)).filter(n=>!isNaN(n));

    return { id,name:upper(m.name||m.full_name||''), graduatingClass:m.grad_class||m.grad||m.class, currentLevel:upper((m.level||'').replace('AAA','TRIPLE-A').replace('AA','DOUBLE-A')), status:upper(m.status||'Active 2025'), position:up(m.position), team, frontImg:up(m.front_img), highSchoolImg:up(m.hs_img||m.front_img), batting, pitching, letterWinnerYears:letters, last3:[l1,l2,l3].filter(x=>x.line!=='—'), nextGame };
  }

  // --------- renderers ----------
  function el(h){ const d=document.createElement('div'); d.innerHTML=h.trim(); return d.firstElementChild; }

  function makeCard(p){
    const img=p.frontImg||'https://images.unsplash.com/photo-1518600506278-4e8ef466b810?q=80&w=1200&auto=format&fit=crop';
    const chips=[]; if(p.currentLevel)chips.push(`<span class="chip">${p.currentLevel}</span>`); if(p.status)chips.push(`<span class="chip">${p.status}</span>`);
    const right=[]; if(p.nextGame?.date||p.nextGame?.opponent){ right.push('<div class="rb">NEXT GAME</div>'); const t=`${p.nextGame.date||''} ${p.nextGame.tz||''}`.trim(); if(t) right.push(`<div class="rb">${t}</div>`); if(p.nextGame.opponent) right.push(`<div class="rb">@ ${p.nextGame.opponent}</div>`); }
    if(p.last3?.length) right.push('<div class="rb">LAST 3 GAMES</div>');

    const node=el(`<article class="card" tabindex="0">
      <img class="bg" src="${img}" alt="${p.name}"><div class="grad"></div>
      <div class="front">
        <div class="chips">${chips.join('')}</div>
        <div><div class="name">${p.name}</div><div class="team">${p.team||''}</div></div>
      </div>
      <div class="right-badges">${right.join('')}</div>
    </article>`);
    node.addEventListener('click',()=>location.href=`profile.html?id=${encodeURIComponent(p.id)}`);
    node.addEventListener('keyup',e=>{if(e.key==='Enter'||e.key===' ')node.click();});
    return node;
  }

  function renderCards(root,list){ root.innerHTML=''; if(!list.length){root.innerHTML='<p style="color:#e11d48">No players found.</p>';return;} list.forEach(p=>root.appendChild(makeCard(p))); }
  function makeKV(k,v){ return `<div class="kv"><div class="k">${k}</div><div class="v">${v??'—'}</div></div>`; }
  function renderProfile(root,p){
    const img=p.highSchoolImg||p.frontImg;
    const stat12 = p.batting ? `
      ${makeKV('AVG',p.batting.avg)} ${makeKV('OBP',p.batting.obp)} ${makeKV('SLG',p.batting.slg)} ${makeKV('OPS',p.batting.ops)}
      ${makeKV('H',p.batting.hits||'—')} ${makeKV('R',p.batting.runs||'—')} ${makeKV('HR',p.batting.hr||'—')} ${makeKV('RBI',p.batting.rbi||'—')}
      ${makeKV('2B',p.batting.doubles||'—')} ${makeKV('3B',p.batting.triples||'—')} ${makeKV('SB',p.batting.sb||'—')} ${makeKV('BB',p.batting.bb||'—')}
    ` : `
      ${makeKV('ERA',p.pitching?.era)} ${makeKV('WHIP',p.pitching?.whip)} ${makeKV('SO',p.pitching?.so)} ${makeKV('IP',p.pitching?.ip)}
      ${makeKV('OBA',p.pitching?.oba||'—')} ${makeKV('K/BB',p.pitching?.kbb||'—')} ${makeKV('FIP',p.pitching?.fip||'—')} ${makeKV('W',p.pitching?.w||'—')}
      ${makeKV('ER',p.pitching?.er||'—')} ${makeKV('HR',p.pitching?.hr||'—')} ${makeKV('QS',p.pitching?.qs||'—')} ${makeKV('SV',p.pitching?.sv||'—')}
    `;
    root.innerHTML=`
      <section class="profile">
        <div class="grid">
          <div>
            <div class="photo"><img src="${img}" alt="${p.name}"></div>
            <div class="kv12">${stat12}</div>
          </div>
          <div>
            <div class="kv">${makeKV('LEVEL',p.currentLevel||'—')}</div>
            <div class="kv" style="margin-top:8px">${makeKV('TEAM',p.team||'—')}</div>
            <div class="kv" style="margin-top:8px">${makeKV('POSITION',p.position||'—')}</div>
            <div class="kv" style="margin-top:8px">${makeKV('STATUS',p.status||'—')}</div>
          </div>
        </div>
      </section>`;
  }

  // filters
  let players=[];
  function playersDefaultView(){ return players.filter(p=>String(p.status||'').includes('ACTIVE')).sort((a,b)=>(+a.graduatingClass||9999)-(+b.graduatingClass||9999)); }
  function applyFilters({level='',class:klass=''}={}){ const root=document.getElementById('grid'); let list=[...players]; if(level)list=list.filter(p=>(p.currentLevel||'').toUpperCase()===level.toUpperCase()); if(klass)list=list.filter(p=>String(p.graduatingClass)===String(klass)); renderCards(root,list); }
  function resetAll(){ document.getElementById('fltLevel')?.value=''; document.getElementById('fltClass')?.value=''; const root=document.getElementById('grid'); renderCards(root,playersDefaultView()); }

  document.addEventListener('DOMContentLoaded', async ()=>{
    try{
      const raw=await fetchSheet(); players=raw.map(mapRow).filter(p=>p.id&&p.name);
    }catch(e){ console.error(e); players=[]; }
    window.YAT=Object.assign(window.YAT||{}, {players,playersDefaultView,renderCards,renderProfile,applyFilters,resetAll});
    const grid=document.getElementById('grid'); if(grid) renderCards(grid,playersDefaultView());
  });
})();
</script>
