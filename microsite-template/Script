<script type="module">  
/* ---- YATSTATS • Hamilton • index – build 5.1.x ---- */  
const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQcWJM6Q6hTdFnES_G5LUy4teCS-sJ5HdAc9F5HSY8DGE9egdGy8yUAe2ShT3tFm-CwUuCYeAYy_YiW/pub?gid=2028135390&output=csv";  

/* === SCHOOL IDENTITY FROM NEON (NEW) === */
const defaultSchool = {
  hsid: 5004,
  hsname: 'HAMILTON HIGH SCHOOL',
  hslocation: 'CHANDLER, AZ',
  logo_url: 'assets/img/schools/hamilton.az.png'
};

async function initSchoolIdentity() {
  const logoEl  = document.getElementById('hamLogo');
  const cityEl  = document.querySelector('.schooltext .small');
  const nameEl  = document.querySelector('.schooltext .big1');
  // .big2 stays "ACTIVE BASEBALL ALUMNI" for all schools

  let school = defaultSchool;

  try {
    const host = window.location.host;
    const res  = await fetch(
      `/api/school/by-domain?host=${encodeURIComponent(host)}`
    );

    if (res.ok) {
      const data = await res.json();

      school = {
        hsid: data.hsid ?? defaultSchool.hsid,
        hsname: (data.hsname || defaultSchool.hsname).toUpperCase(),
        hslocation: (data.hslocation || defaultSchool.hslocation).toUpperCase(),
        logo_url: data.logo_url || defaultSchool.logo_url
      };
    } else {
      console.warn('initSchoolIdentity: backend returned', res.status);
    }
  } catch (err) {
    console.warn('initSchoolIdentity: using default Hamilton school', err);
  }

  if (logoEl)  logoEl.src         = school.logo_url;
  if (cityEl)  cityEl.textContent = school.hslocation;
  if (nameEl)  nameEl.textContent = school.hsname;

  document.title = `WHERE THEY YAT? – ${school.hsname} ACTIVE BASEBALL ALUMNI`;
}
/* === END NEW SCHOOL IDENTITY BLOCK === */

const $ = s => document.querySelector(s);  
const $$ = s => Array.from(document.querySelectorAll(s));  
const debounce = (fn, ms=300)=>{ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),ms); }; };  

const levelOrder = {  
  'MLB':13,'INTERNATIONAL':12,'TRIPLE-A':11,'AAA':11,'DOUBLE-A':10,'AA':10,  
  'HIGH-A':9,'A+':9,'LOW-A':8,'A':8,'ROOKIE':7,'ROK':7,'INDY':6,  
  'NCAA-D1':5,'NCAA-D2':4,'NCAA-D3':3,'NAIA':2,'JUCO':1  
};  

/* DEFAULT STATUS FILTERS FOR INITIAL LOAD & RESET */  
const DEFAULT_STATUSES = ['ACTIVE 2025', 'ACTIVE 2024', 'INJURED', 'FREE AGENT'];  

function setDefaultStatusFilter() {  
  const container = $('#filterStatus');  
  if (!container) return;  

  const allBoxes = Array.from(  
    container.querySelectorAll('input[type="checkbox"]:not(.select-all)')  
  );  

  // Check ONLY the default ones  
  allBoxes.forEach(cb => {  
    cb.checked = DEFAULT_STATUSES.includes(cb.value);  
  });  

  // Make sure the "Select All" checkbox is *not* checked  
  const selectAll = container.querySelector('.select-all');  
  if (selectAll) selectAll.checked = false;  
}  

/* CSV loader */  
async function loadCSV(url){  
  const res = await fetch(url);  
  if(!res.ok) throw new Error(`HTTP ${res.status}`);  
  const text = await res.text();  
  if(!text.trim()) throw new Error('Empty CSV');  

  const rows = text.trim()  
    .split(/\r?\n/)  
    .map(line => line.split(/,(?=(?:[^"]*"[^"]*")*[^"]*$)/).map(c=>c.replace(/^"|"$/g,'')));  

  const header = rows.shift().map(h => h.trim());  
  const idx = name => header.indexOf(name);  

  const statKeys = ['avg','obp','slg','ops','ab','h','r','rbi','2b','3b','hr','sb','bb','era','k/9','k/bb','whip','ip','er','ko','gp','w-l','saves','fip'];  

  return rows.map(r=>{  
    const player = {  
      slug:r[idx('slug')],  
      display_name:r[idx('display_name')],  
      first:r[idx('first')],  
      last:r[idx('last')],  
      grad_class:r[idx('grad_class')],  
      letter_years:r[idx('letter_years')],  
      status:r[idx('status')],  
      level:r[idx('level')],  
      team:r[idx('team')],  
      org:r[idx('org')],  
      position:r[idx('position')],  
      height:r[idx('height')],  
      weight:r[idx('weight')],  
      bats:r[idx('bats')],  
      throws:r[idx('throws')],  
      draft_info:r[idx('Draft_Info')] ?? r[idx('draft_info')],  
      colleges:r[idx('Colleges')] ?? r[idx('colleges')],  
      next_game_date: r[idx('next_game_date')],  
      next_game_time: r[idx('next_game_time')],  
      next_game_opponent: r[idx('next_game_opponent')],  
      next_game_datetime: r[idx('next_game_datetime')],  
      last_game_1:r[idx('last_game_1')],  
      last_game_2:r[idx('last_game_2')],  
      last_game_3:r[idx('last_game_3')],  
      x_handle:r[idx('x_handle')],  
      ig_handle:r[idx('ig_handle')],  
      video_url:r[idx('video_url')],  
      nil_score:r[idx('nil_score')],  
      stats:{}  
    };  

    for(const key of statKeys){  
      const sIdx = idx(key);  
      if (sIdx > -1 && r[sIdx]) player.stats[key.toUpperCase()] = r[sIdx];  
    }  
    return player;  
  });  
}  

/* Helpers */  
function slugOf(p){  
  if (!p) return '';  
  const s=(p.slug||'').trim();  
  if(s) return s;  
  return (p.display_name||'').trim().toLowerCase().replace(/[^a-z0-9]+/g,'-');  
}  
function imageNameOf(p){  
  const statusUpper = (p.status || '').toUpperCase();  
  if ((statusUpper === 'SPONSOR' || statusUpper === 'RETIRED-SPONSOR') && p.slug) {  
    return p.slug.trim().toLowerCase().replace(/\s+/g, '_').replace(/[^a-z0-9_]/g,'');  
  }  
  const first = (p.first || '').toLowerCase().replace(/\s+/g,'_');  
  const last = (p.last || '').toLowerCase().replace(/\s+/g,'_');  
  if (first || last) return [first,last].filter(Boolean).join('_');  
  return (p.slug || p.display_name || '')  
    .toLowerCase()  
    .replace(/\s+/g,'_')  
    .replace(/[^a-z0-9_]/g,'');  
}  
function profileURL(p){ return `./profile.html?player=${slugOf(p)}`; }  

function formatStatValue(key, value){  
  if (!value || value === '--') return '--';  
  const decimalStats=['AVG','OBP','SLG','OPS'];  
  if (decimalStats.includes(key.toUpperCase())){  
    const num=parseFloat(value);  
    if (isNaN(num)) return value;  
    const str=num.toFixed(3);  
    return (num < 1 && num > -1) ? str.substring(1) : str;  
  }  
  return value;  
}  
function formatNextGame(p){  
  const date = (p.next_game_date||'').trim();  
  const time = (p.next_game_time||'').trim();  
  const opp = (p.next_game_opponent||'').trim();  
  if (!date && !time && !opp && p.next_game_datetime) {  
    return p.next_game_datetime;  
  }  
  const when = [date, time].filter(Boolean).join(' ').trim();  
  const parts = [when || 'TBD', opp].filter(Boolean);  
  return parts.join(' ').trim() || 'TBD';  
}  

/* Card HTML */  
function cardHTML(p){  
  const name = p.display_name || 'Player Name';  
  const imageName = imageNameOf(p);  
  const statusUpper = (p.status || '').toUpperCase();  
  const isSponsorImage = (statusUpper === 'SPONSOR' || statusUpper === 'RETIRED-SPONSOR');  

  const nowFolder = isSponsorImage ? 'partners' : 'now_players';  
  const hsFolder = isSponsorImage ? 'partners' : 'hs_players';  
  const nowExt = isSponsorImage ? 'png' : 'jpg';  
  const nowFallbackExt = isSponsorImage ? 'jpg' : 'png';  

  const bg_now = `assets/img/${nowFolder}/${imageName}.${nowExt}`;  
  const bg_now_fallback = `assets/img/${nowFolder}/${imageName}.${nowFallbackExt}`;  
  const bg_hs = `assets/img/${hsFolder}/${imageName}.${nowExt}`;  
  const bg_hs_fallback = `assets/img/${hsFolder}/${imageName}.${nowFallbackExt}`;  

  const klass = p.grad_class || '';  
  const org = p.org ? p.org : (p.conference || '');  
  const playerInfo = JSON.stringify(p).replace(/'/g,"&apos;");  
  const letterYears = (p.letter_years || '').split(',').map(y=>y.trim().slice(-2)).filter(Boolean);  
  const nextGameText = formatNextGame(p);  

  return `  
  <article class="card" aria-label="${name}" data-player-info='${playerInfo}'>  
    <div class="card-inner">  
      <div class="flip">  
        <!-- FRONT -->  
        <div class="face front">  
          <div class="bg" style="background-image:url('${bg_now}')"  
               onerror="this.onerror=null; this.style.backgroundImage='url(${bg_now_fallback})'"></div>  
          <div class="shade"></div>  
          <div class="front-bottom-content">  
            <div class="front-chips-row">  
              ${klass?`<span class="front-chip">CLASS OF ${klass}</span>`:''}  
              ${p.status?`<span class="front-chip">${p.status}</span>`:''}  
              ${p.level?`<span class="front-chip">${p.level}</span>`:''}  
            </div>  
            <div class="front-info-block">  
              <div class="name"><span>${p.first||''}</span><span>${p.last||''}</span></div>  
              <div class="meta-small"><span>${p.team||''} - ${org||''}</span></div>  
              <div class="varsity-dots">  
                ${letterYears.map(y=>`<div class="varsity-dot">${y}</div>`).join('')}  
              </div>  

              <div class="front-game-block">  
                <div class="game-title-pill">LAST 3 GAMES</div>  
                <div class="game-data-text">  
                  <span class="game-log">${p.last_game_1 || '--'}</span>  
                  <span class="game-log">${p.last_game_2 || '--'}</span>  
                  <span class="game-log">${p.last_game_3 || '--'}</span>  
                </div>  
              </div>  

              <div class="front-game-block">  
                <div class="game-title-pill">NEXT GAME</div>  
                <div class="game-data-text">  
                  <span>${nextGameText}</span>  
                  <span style="margin-top:2px;">  
                    <a href="https://yatstats.com/sponsors"  
                       target="_blank"  
                       rel="noopener"  
                       style="color:#fff;text-decoration:underline;font-size:11px;letter-spacing:.06em;text-transform:uppercase;">  
                      WHERE YAT THESE DAYS?  
                    </a>  
                  </span>  
                </div>  
              </div>  

            </div>  
          </div>  
        </div>  

        <!-- BACK -->  
        <div class="face back">  
          <div class="back-top-section">  
            <div class="back-info-left">  
              <div class="back-player-name">${name}</div>  
              <div class="back-player-details">  
                <strong>${p.team || ''}</strong> - ${org||''}<br>  
                ${p.level||''} - ${p.status||''}<br>  
                ${p.position||''} | H: ${p.height||'--'} | W: ${p.weight||'--'} | B/T: ${p.bats||'--'}/${p.throws||'--'}  
              </div>  
              <div class="back-player-details" style="margin-top:8px;">  
                <strong>Draft:</strong> ${p.draft_info || 'N/A'}<br>  
                <strong>Colleges:</strong> ${p.colleges || 'N/A'}  
              </div>  
            </div>  
            <div class="back-photo-right">  
              <a href="${profileURL(p)}">  
                <img src="${bg_hs}" class="back-player-photo" alt="${name}"  
                     onerror="this.onerror=null; this.src='${bg_hs_fallback}'">  
              </a>  
            </div>  
          </div>  

          <nav class="back-nav">  
            <button class="back-nav-link active" data-content="stats">SEASON & CAREER STATISTICS</button>  
            <button class="back-nav-link" data-content="news">NEWS & VIDEO CLIPS</button>  
            <button class="back-nav-link" data-content="social">SOCIAL MEDIA</button>  
            <button class="back-nav-link" data-content="mentor">MENTORSHIP MARKETPLACE</button>  
            <button class="back-nav-link" data-content="pics">TIMELINE GALLERY</button>  
          </nav>  
          <div class="fun-zone">${generateStatsGridHTML(p)}</div>  
        </div>  
      </div>  
    </div>  
  </article>`;  
}  

/* Stats grid – pitcher vs hitter */  
function generateStatsGridHTML(player){  
  const isPitcher = player.stats['ERA'] !== undefined;  
  const batterStats = ['AVG','OBP','SLG','OPS','H','R','HR','RBI','AB','2B','3B','SB'];  
  const pitcherStats = ['ERA','K/9','K/BB','WHIP','IP','ER','KO','BB','GP','W-L','SAVES','FIP'];  
  const statsToShow = isPitcher ? pitcherStats : batterStats;  
  let grid = `<div class="stats-header-bar">${(player.status||'').includes('ACTIVE') ? '2025 SEASON STATS' : 'CAREER STATS'}</div>`;  
  grid += '<div class="stats-grid">';  
  grid += statsToShow.map(stat=>{  
    const v = formatStatValue(stat, player.stats[stat]);  
    return `<div class="stat-item"><div class="stat-label">${stat}</div><div class="stat-value">${v ?? '--'}</div></div>`;  
  }).join('');  
  grid += '</div>';  
  return grid;  
}  

/* Rendering */  
function renderCards(list){  
  const grid = $('#cardGrid'); if(!grid) return;  
  if(!list.length){  
    grid.innerHTML = `<p style="color:var(--muted);grid-column:1 / -1;">No players match the current filters.</p>`;  
    return;  
  }  
  grid.innerHTML = list.map(cardHTML).join('');  
}  

/* Sorting (unchanged) */  
function defaultSort(a,b){  
  const aStatus = (a.status||'').toUpperCase();  
  const bStatus = (b.status||'').toUpperCase();  

  const aIsSponsor = aStatus === 'SPONSOR';  
  const bIsSponsor = bStatus === 'SPONSOR';  
  if (aIsSponsor && !bIsSponsor) return -1;  
  if (!aIsSponsor && bIsSponsor) return 1;  

  const aIsPriority = aStatus.includes('ACTIVE') || aStatus === 'FREE AGENT';  
  const bIsPriority = bStatus.includes('ACTIVE') || bStatus === 'FREE AGENT';  
  if (aIsPriority && !bIsPriority) return -1;  
  if (!aIsPriority && bIsPriority) return 1;  

  if (aIsPriority && bIsPriority){  
    const levelTextA=(a.level||'').toUpperCase().trim(), levelTextB=(b.level||'').toUpperCase().trim();  
    const levelA=levelOrder[levelTextA] ?? -1, levelB=levelOrder[levelTextB] ?? -1;  
    if (levelA !== levelB) return levelB - levelA;  
    const gradA=+a.grad_class||0, gradB=+b.grad_class||0;  
    if (gradA !== gradB) return gradA - gradB;  
    const lettersA=(a.letter_years||'').split(',').filter(Boolean).length;  
    const lettersB=(b.letter_years||'').split(',').filter(Boolean).length;  
    if (lettersA !== lettersB) return lettersB - lettersA;  
    return (a.display_name||'').localeCompare(b.display_name||'');  
  }  

  const cA=+a.grad_class||9999, cB=+b.grad_class||9999;  
  if (cA !== cB) return cA - cB;  
  return (a.display_name||'').localeCompare(b.display_name||'');  
}  

/* FILTER POPULATION */  
function populateFilters(players){  
  const levels = [...new Set(players.map(p=>p.level).filter(Boolean))]  
    .sort((a,b)=>(levelOrder[b?.toUpperCase()]??-1)-(levelOrder[a?.toUpperCase()]??-1));  

  $('#filterLevels').innerHTML =  
    '<label class="select-all-label"><input type="checkbox" class="select-all"> Select All</label>' +  
    levels.map(level=>`<label><input type="checkbox" value="${level}"> ${level}</label>`).join('');  

  const gradClasses = [...new Set(players.map(p=>p.grad_class).filter(Boolean))].sort((a,b)=>b-a);  
  $('#filterGradClass').innerHTML =  
    '<label class="select-all-label"><input type="checkbox" class="select-all"> Select All</label>' +  
    gradClasses.map(y=>`<label><input type="checkbox" value="${y}"> ${y}</label>`).join('');  

  const rosterYears = [...new Set(players  
      .flatMap(p=>(p.letter_years||'').split(','))  
      .map(y=>y.trim())  
      .filter(Boolean))]  
      .sort((a,b)=>b-a);  

  $('#filterRosterYear').innerHTML =  
    '<label class="select-all-label"><input type="checkbox" class="select-all"> Select All</label>' +  
    rosterYears.map(y=>`<label><input type="checkbox" value="${y}"> ${y}</label>`).join('');  
}  

/* Helper: select all in a group */  
function selectAllInGroup(containerSelector){  
  const group = $(containerSelector);  
  if (!group) return;  
  const boxes = Array.from(group.querySelectorAll('input[type="checkbox"]:not(.select-all)'));  
  boxes.forEach(cb => cb.checked = true);  
  const selectAll = group.querySelector('.select-all');  
  if (selectAll) selectAll.checked = true;  
}  

/* READ FILTERS */  
function readFilters(){  
  const name = ($('#filterName')?.value || '').trim().toLowerCase();  

  function readGroup(id){  
    const container = $(id);  
    if (!container) return {active:false, values:[]};  
    const allBoxes = Array.from(container.querySelectorAll('input[type="checkbox"]:not(.select-all)'));  
    const checked = allBoxes.filter(cb=>cb.checked).map(cb=>cb.value);  
    const active = checked.length > 0 && checked.length < allBoxes.length;  
    return {active, values:checked};  
  }  

  const statusGroup = readGroup('#filterStatus');  
  const levelGroup  = readGroup('#filterLevels');  
  const classGroup  = readGroup('#filterGradClass');  
  const rosterGroup = readGroup('#filterRosterYear');  

  return {  
    name,  
    status:statusGroup,  
    levels:levelGroup,  
    classes:classGroup,  
    rosterYears:rosterGroup  
  };  
}  

/* APPLY FILTERS */  
function applyFilters(){  
  if(!window.PLAYERS) return;  
  const F = readFilters();  

  const filtered = window.PLAYERS.filter(p=>{  
    const nm = (p.display_name || '').toLowerCase();  
    const nameOk = !F.name || nm.includes(F.name);  

    const statusOk = !F.status.active || F.status.values.includes(p.status);  
    const levelOk  = !F.levels.active  || F.levels.values.includes(p.level);  
    const classOk  = !F.classes.active || F.classes.values.includes(p.grad_class);  

    const rosterOk = !F.rosterYears.active ||  
      (p.letter_years || '')  
        .split(',')  
        .map(y=>y.trim())  
        .some(y => F.rosterYears.values.includes(y));  

    return nameOk && statusOk && levelOk && classOk && rosterOk;  
  });  

  const sorted = filtered.sort(defaultSort);  
  renderCards(sorted);  
}  

/* RESET FILTERS – back to the "default active" view */  
function resetFilters(){  
  $$('#filters input').forEach(i=>{  
    if(i.type==='checkbox') i.checked=false;  
    if(i.type==='text') i.value='';  
  });  

  setDefaultStatusFilter();  
  selectAllInGroup('#filterLevels');  
  selectAllInGroup('#filterGradClass');  
  selectAllInGroup('#filterRosterYear');  

  applyFilters();  
}  

/* Live search in left drawer */  
function makeHit(p){  
  const el=document.createElement('div'); el.className='live-hit';  
  const imageName=imageNameOf(p);  
  const hsImgJpg=`assets/img/hs_players/${imageName}.jpg`;  
  const hsImgPng=`assets/img/hs_players/${imageName}.png`;  
  el.innerHTML=`<img src="${hsImgJpg}" onerror="this.onerror=null;this.src='${hsImgPng}';">  
                <div><div style="font-weight:700">${p.display_name}</div>  
                <div style="opacity:.7;font-size:.92em">${p.level||''} • Class of ${p.grad_class||''}</div></div>`;  
  el.onclick=()=>window.location.href=profileURL(p);  
  return el;  
}  
function liveSearch(){  
  const q=($('#playerSearch')?.value||'').trim().toLowerCase();  
  const box=$('#liveResults'); if(!box) return;  
  if(!q){ box.innerHTML=''; return; }  
  const hits=(window.PLAYERS||[]).filter(p=>(p.display_name||'').toLowerCase().includes(q)).slice(0,25);  
  box.innerHTML=''; hits.forEach(p=>box.appendChild(makeHit(p)));  
}  

/* Fun zone (back-of-card tabs) */  
async function handleFunZone(button){  
  const card = button.closest('.card') || document.body;  
  const funZone = card.querySelector('.fun-zone');  
  const player = JSON.parse(card.dataset.playerInfo || '{}');  
  const content = button.dataset.content;  

  card.querySelectorAll('.back-nav-link').forEach(btn=>btn.classList.remove('active'));  
  button.classList.add('active');  
  funZone.innerHTML = '<p style="padding:12px;text-align:center;">Loading...</p>';  

  if (content === 'stats'){  
    funZone.innerHTML = generateStatsGridHTML(player);  
    return;  
  }  

  if (content === 'video'){  
    funZone.innerHTML = player.video_url  
      ? `<iframe width="100%" height="215" src="${player.video_url}" title="Video" frameborder="0" allowfullscreen style="border-radius:8px;display:block;"></iframe>`  
      : `<p style="padding:12px;text-align:center;">No video available for ${player.display_name}.</p>`;  
    return;  
  }  

  if (content === 'mentor'){  
    funZone.innerHTML = player.nil_score  
      ? `<div class="stats-header-bar">MENTORSHIP MARKETPLACE</div>  
         <p style="padding:12px;text-align:center;">Upload your baseball video (hitting, throwing, fielding, etc.) and get personalized feedback, coaching, and encouragement from ${player.display_name}!</p>  
         <button style="width:100%;padding:12px;background:var(--fg);color:var(--bg);border:none;border-radius:8px;font-family:'Bebas Neue',sans-serif;font-size:16px;letter-spacing:.08em;cursor:pointer;">SEND ${player.first.toUpperCase()} A VIDEO</button>`  
      : `<p style="padding:12px;text-align:center;">Mentorship not available for ${player.display_name}.</p>`;  
    return;  
  }  

  if (content === 'bio'){  
    const { generateGeminiText } = window.gemini || {};  
    if (typeof generateGeminiText !== 'function'){  
      funZone.innerHTML = `<p style="padding:12px;text-align:center;">AI service unavailable.</p>`;  
      return;  
    }  
    const prompt = `Act as an optimistic but knowledgeable high school baseball scout. Write a brief, 2-3 sentence scouting report for ${player.display_name}. Highlight his journey and potential future in a positive, "YAT-A-BOY!" style.`;  
    try{  
      const text = await generateGeminiText(prompt);  
      funZone.innerHTML = `<div style="padding:12px;line-height:1.4;">${text}</div>`;  
    }catch{  
      funZone.innerHTML = `<p style="padding:12px;text-align:center;">AI service is currently unavailable.</p>`;  
    }  
    return;  
  }  

  if (content === 'social'){  
    let html = '<div style="padding:12px;">';  
    if (player.x_handle) html += `<a href="https://x.com/${player.x_handle}" target="_blank" rel="noopener" style="display:block;margin-bottom:8px;">View on X / Twitter</a>`;  
    if (player.ig_handle) html += `<a href="https://instagram.com/${player.ig_handle}" target="_blank" rel="noopener" style="display:block;margin-bottom:8px;">View on Instagram</a>`;  
    if (!player.x_handle && !player.ig_handle) html += 'No social media links available.';  
    html += '</div>';  
    funZone.innerHTML = html;  
    return;  
  }  

  if (content === 'news'){  
    const cacheRaw = localStorage.getItem('YAT_NEWS_CACHE_V1');  
    let items = [];  
    try{  
      const cache = cacheRaw ? JSON.parse(cacheRaw) : {};  
      items = Array.isArray(cache.items) ? cache.items : [];  
    }catch{ items = []; }  

    const nameLc = (player.display_name||'').toLowerCase();  
    const mine = items  
      .filter(n => (String(n.player_display_name||'').toLowerCase() === nameLc))  
      .sort((a,b)=> new Date(b.publishedAt||0) - new Date(a.publishedAt||0))  
      .slice(0,3);  

    if (!mine.length){  
      funZone.innerHTML = `<div class="stats-header-bar">LATEST HEADLINES</div>  
        <div style="padding:12px;text-align:center;opacity:.8;">No recent headlines yet for ${player.display_name}. Check back soon!</div>`;  
      return;  
    }  

    const cards = mine.map(n=>{  
      const img = n.image || ('https://picsum.photos/seed/' + encodeURIComponent(n.id || n.title || 'news') + '/600/400');  
      const when = n.publishedAt ? new Date(n.publishedAt).toLocaleString() : '';  
      const base = String(n.url || '#');  
      const read = base + (base.includes('?') ? '&' : '?') + 'utm_source=yatstats&utm_medium=funzone';  
      const src = n.source || 'News';  
      const ttl = n.title || 'Read more';  
      return `<a href="${read}" target="_blank" rel="noopener noreferrer"  
                style="display:flex;gap:10px;margin:10px 0;padding:8px;border-radius:10px;border:1px solid var(--line);text-decoration:none;align-items:center;">  
                <div style="width:84px;height:64px;flex:0 0 84px;background:#000;border-radius:8px;background-image:url('${img}');background-size:cover;background-position:center;"></div>  
                <div style="flex:1;min-width:0;">  
                  <div style="font-weight:700;line-height:1.2;">${ttl}</div>  
                  <div style="font-size:12px;opacity:.75;margin-top:4px;">${src} • ${when}</div>  
                </div>  
              </a>`;  
    }).join('');  

    funZone.innerHTML = `<div class="stats-header-bar">LATEST HEADLINES</div><div style="padding:8px 4px;">${cards}</div>`;  
    return;  
  }  

  funZone.innerHTML = `<p style="padding:12px;text-align:center;">Content for ${content} coming soon.</p>`;  
}  

/* Auth UI */  
function setupAuth(){  
  if (!window.firebaseAuth){ console.warn("Firebase auth script not ready yet, skipping auth setup."); return; }  
  const { createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } = window.firebaseAuth;  
  const auth = window.auth;  
  const signInForm=$('#signInForm'), registerForm=$('#registerForm'),  
        signOutBtn=$('#btnSignOut'), authMessage=$('#authMessage');  

  signInForm?.addEventListener('submit', async e=>{  
    e.preventDefault();  
    try{  
      await signInWithEmailAndPassword(auth, $('#signInEmail').value, $('#signInPassword').value);  
      authMessage.textContent='Sign in successful!'; authMessage.className='success';  
      setTimeout(()=>{ closeDrawers(); authMessage.textContent=''; },1500);  
    }catch(err){ authMessage.textContent=err.message; authMessage.className='error'; }  
  });  

  registerForm?.addEventListener('submit', async e=>{  
    e.preventDefault();  
    try{  
      await createUserWithEmailAndPassword(auth, $('#registerEmail').value, $('#registerPassword').value);  
      authMessage.textContent='Registration successful!'; authMessage.className='success';  
      setTimeout(()=>{ closeDrawers(); authMessage.textContent=''; },1500);  
    }catch(err){ authMessage.textContent=err.message; authMessage.className='error'; }  
  });  

  signOutBtn?.addEventListener('click', async ()=>{ await signOut(auth); });  

  document.addEventListener('authStateChanged', ({detail})=>{  
    const { user } = detail;  
    const accountBtn=$('#btnAccount'), soBtn=$('#btnSignOut');  
    if (user && !user.isAnonymous){ accountBtn.style.display='none'; soBtn.style.display='inline-flex'; }  
    else { accountBtn.style.display='inline-flex'; soBtn.style.display='none'; }  
  });  

  $$('.auth-tab').forEach(tab=>{  
    tab.addEventListener('click', ()=>{  
      const target=tab.dataset.tab;  
      $$('.auth-tab').forEach(t=>t.classList.remove('active'));  
      tab.classList.add('active');  
      $$('.auth-form').forEach(form=>form.style.display = (form.id===`${target}Form`) ? 'block' : 'none');  
      authMessage.textContent='';  
    });  
  });  
}  

/* Theme */  
function setupTheme(){  
  const themeToggle=$('#theme-toggle'); if(!themeToggle) return;  
  const body=document.body, icon=themeToggle.querySelector('i');  
  const applyTheme=()=>{  
    const saved=localStorage.getItem('theme');  
    if (saved==='light'){  
      body.classList.add('light-theme');  
      icon?.classList.replace('ri-sun-line','ri-moon-line');  
    } else {  
      body.classList.remove('light-theme');  
      icon?.classList.replace('ri-moon-line','ri-sun-line');  
    }  
  };  
  themeToggle.addEventListener('click', ()=>{  
    body.classList.toggle('light-theme');  
    localStorage.setItem('theme', body.classList.contains('light-theme') ? 'light' : 'dark');  
    applyTheme();  
  });  
  applyTheme();  
}  

/* Drawers & events */  
function closeDrawers(){ document.body.classList.remove('drawer-left-open','drawer-right-open','drawer-open'); }  
function setupEventListeners(){  
  $('#btnMenu')?.addEventListener('click',()=>{ document.body.classList.add('drawer-left-open','drawer-open'); });  
  $('#openSearch')?.addEventListener('click',()=>{ document.body.classList.add('drawer-left-open','drawer-open'); });  
  $('#openFilters')?.addEventListener('click',()=>{  
    $('#drawerFilters').style.display='flex';  
    $('#drawerAccount').style.display='none';  
    document.body.classList.add('drawer-right-open','drawer-open');  
  });  
  $('#btnAccount')?.addEventListener('click',()=>{  
    $('#drawerAccount').style.display='flex';  
    $('#drawerFilters').style.display='none';  
    document.body.classList.add('drawer-right-open','drawer-open');  
  });  

  $$('.close-btn').forEach(b=>b.addEventListener('click',closeDrawers));  
  $('.drawer-mask')?.addEventListener('click',closeDrawers);  

  $('#filtersReset')?.addEventListener('click',resetFilters);  
  $('#filtersReset2')?.addEventListener('click',resetFilters);  

  $('#filterName')?.addEventListener('input',debounce(applyFilters));  
  $('#playerSearch')?.addEventListener('input',debounce(liveSearch));  

  $('#filters')?.addEventListener('change',e=>{  
    if (e.target.classList.contains('select-all')){  
      const on = e.target.checked;  
      e.target.closest('.filter-options')  
        ?.querySelectorAll('input[type="checkbox"]:not(.select-all)')  
        .forEach(cb=>cb.checked=on);  
    }  
    applyFilters();  
  });  

  $('#cardGrid').addEventListener('click', e=>{  
    const card = e.target.closest('.card'); if(!card) return;  
    if (e.target.closest('.back-nav-link')){  
      handleFunZone(e.target.closest('.back-nav-link'));  
      return;  
    }  
    if (e.target.closest('a')) return;  
    card.classList.toggle('is-flipped');  
  });  
}  

/* Gemini stub */  
window.gemini = {  
  async generateGeminiText(prompt) {  
    const apiUrl = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=' + (window.__gemini_api_key || '');  
    const payload = { contents: [{ parts: [{ text: prompt }] }] };  
    try {  
      const resp = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });  
      if (!resp.ok) return `Error: The AI service failed to respond.`;  
      const result = await resp.json();  
      return result.candidates?.[0]?.content?.parts?.[0]?.text || "No response from AI.";  
    } catch (err) {  
      console.error('Gemini API call failed:', err);  
      return 'AI service is currently unavailable.';  
    }  
  }  
};  

/* Boot */  
document.addEventListener('DOMContentLoaded', ()=>{  
  const splash = $('#splashScreen');  
  if (splash){  
    const alreadyShown = sessionStorage.getItem('splashShown') === 'true';  
    if (alreadyShown){  
      splash.classList.add('is-hidden');  
      splash.style.display='none';  
    } else {  
      setTimeout(()=>{  
        splash.classList.add('is-hidden');  
        splash.addEventListener('transitionend', (e)=>{  
          if(e.target===splash) splash.style.display='none';  
        }, {once:true});  
      }, 3000);  
      setTimeout(() => {  
        if (splash.style.display !== 'none') splash.style.display = 'none';  
      }, 6000);  
      sessionStorage.setItem('splashShown','true');  
    }  
  }  

  (async ()=>{  
    try{  
      setupTheme();  
      setupEventListeners();  
      setupAuth();  

      /* NEW: hydrate header from Neon /api/school/by-domain */
      await initSchoolIdentity();

      const data = await loadCSV(CSV_URL);  
      window.PLAYERS = data;  

      populateFilters(data);  

      // DEFAULT VIEW:  
      // Status = ONLY ACTIVE 2025, ACTIVE 2024, INJURED, FREE AGENT  
      setDefaultStatusFilter();  

      // Other groups: no restriction (select all)  
      selectAllInGroup('#filterLevels');  
      selectAllInGroup('#filterGradClass');  
      selectAllInGroup('#filterRosterYear');  

      applyFilters();  
    }catch(err){  
      console.error('Initialization failed', err);  
      $('#cardGrid').innerHTML =  
        `<p style="color:red;grid-column:1 / -1;"><strong>Error:</strong> Could not load page. ${err.message}</p>`;  
    }  
  })();  
});  
</script>
