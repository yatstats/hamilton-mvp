<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>YAT?STATS • HS SEARCH</title>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&family=Bebas+Neue&display=swap" rel="stylesheet">

  <!-- Tailwind via CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    * {
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto,
      "Helvetica Neue", Arial, "Noto Sans", sans-serif;
    }

    /* small header lines (city/state + ACTIVE BASEBALL ALUMNI) */
    .banner-small {
      font-family: Inter, system-ui, sans-serif;
      letter-spacing: 0.18em;
      text-transform: uppercase;
      white-space: nowrap;
    }

    /* big school name */
    .banner-school {
      font-family: "Bebas Neue", system-ui, sans-serif;
      letter-spacing: 0.16em;
      text-transform: uppercase;
      line-height: 1;
    }

    @media (min-width: 768px) {
      .banner-school {
        letter-spacing: 0.18em;
      }
    }
  </style>
</head>
<body class="bg-black text-white">

<!-- Search Section -->
<section id="search-section" class="py-14">
  <div class="max-w-5xl mx-auto px-6 text-center">
    <h2 class="text-3xl md:text-4xl font-extrabold mb-3">
      SEARCH 17,000+<br>HS BASEBALL PROGRAMS
    </h2>

    <!-- Controls -->
    <div class="max-w-3xl mx-auto grid sm:grid-cols-3 gap-3 mt-6">
      <input id="school-search-input"
             class="w-full bg-neutral-900 border border-neutral-700 text-white placeholder-neutral-500 text-base md:text-lg rounded-md p-3 focus:outline-none focus:ring-2 focus:ring-neutral-300"
             placeholder="E.g., YOUR LOCAL SCHOOL" />
      <select id="state-filter"
              class="w-full bg-neutral-900 border border-neutral-700 text-white text-base md:text-lg rounded-md p-3 focus:outline-none focus:ring-2 focus:ring-neutral-300">
        <option value="">All States</option>
      </select>
      <button id="search-button"
              class="bg-neutral-100 text-black font-semibold py-3 px-6 rounded-md text-base md:text-lg hover:bg-white transition">
        Search
      </button>
    </div>

    <!-- Results -->
    <div id="results-container" class="mt-8 max-w-5xl mx-auto text-left hidden">
      <div id="loading" class="py-10 text-center hidden">
        <div class="animate-spin inline-block h-8 w-8 border-4 border-neutral-600 border-t-transparent rounded-full"></div>
        <p class="text-gray-400 mt-4">Loading…</p>
      </div>

      <div id="results-content"></div>

      <div id="pagination" class="flex items-center justify-center gap-4 mt-8 text-sm"></div>
    </div>

    <p id="feedback" class="text-gray-400 mt-6 hidden"></p>
  </div>
</section>

<script>
  /* Where logos live */
  const LOGO_BASE =
    "https://yatstats.github.io/hamilton-mvp/assets/img/schools";
  const LOGO_FALLBACK = LOGO_BASE + "/default.png";

  /* State list for dropdown */
  const STATE_ABBR_TO_NAME = {
    AL:"Alabama", AK:"Alaska", AZ:"Arizona", AR:"Arkansas", CA:"California", CO:"Colorado",
    CT:"Connecticut", DE:"Delaware", FL:"Florida", GA:"Georgia", HI:"Hawaii", ID:"Idaho",
    IL:"Illinois", IN:"Indiana", IA:"Iowa", KS:"Kansas", KY:"Kentucky", LA:"Louisiana",
    ME:"Maine", MD:"Maryland", MA:"Massachusetts", MI:"Michigan", MN:"Minnesota",
    MS:"Mississippi", MO:"Missouri", MT:"Montana", NE:"Nebraska", NV:"Nevada",
    NH:"New Hampshire", NJ:"New Jersey", NM:"New Mexico", NY:"New York",
    NC:"North Carolina", ND:"North Dakota", OH:"Ohio", OK:"Oklahoma", OR:"Oregon",
    PA:"Pennsylvania", RI:"Rhode Island", SC:"South Carolina", SD:"South Dakota",
    TN:"Tennessee", TX:"Texas", UT:"Utah", VT:"Vermont", VA:"Virginia",
    WA:"Washington", WV:"West Virginia", WI:"Wisconsin", WY:"Wyoming", DC:"District of Columbia"
  };

  function fillStateDropdown() {
    const stateEl = document.getElementById("state-filter");
    const frag = document.createDocumentFragment();
    Object.keys(STATE_ABBR_TO_NAME).sort().forEach(abbr => {
      const opt = document.createElement("option");
      opt.value = abbr;                // send 2-letter code to API
      opt.textContent = STATE_ABBR_TO_NAME[abbr];
      frag.appendChild(opt);
    });
    stateEl.appendChild(frag);
  }

  /* Global search state */
  let lastQuery = "";
  let lastState = "";
  let currentPage = 1;
  let totalPages = 1;

  const loadingEl   = document.getElementById("loading");
  const feedbackEl  = document.getElementById("feedback");
  const resultsWrap = document.getElementById("results-container");
  const resultsEl   = document.getElementById("results-content");
  const paginationEl= document.getElementById("pagination");

  function scrollToResultsTop() {
    resultsWrap.scrollIntoView({ behavior: "smooth", block: "start" });
  }

  function getLogoPath(program) {
    const id = program.hsid || program.logoHsid;
    if (!id) return LOGO_FALLBACK;
    return `${LOGO_BASE}/${id}.png`;
  }

  function buildCta(program) {
    // result is one object from programs[]
    const url = program.micrositeUrl || program.stagingUrl || null;
    const ctaText = url
      ? `CLICK TO ENTER THE YAT?STATS GLOBAL NETWORK THROUGH > ${url}`
      : "MICROSITE COMING SOON – STATS PREVIEW ONLY";

    if (url) {
      return `
        <a href="${url}" target="_blank" rel="noopener"
           class="w-full py-3 rounded-md font-semibold border border-neutral-600 bg-neutral-100 text-black hover:bg-white block text-[0.7rem] sm:text-xs md:text-sm break-words text-center">
          ${ctaText}
        </a>
      `;
    } else {
      return `
        <button
           class="w-full py-3 rounded-md font-semibold border border-neutral-600 bg-neutral-800 text-neutral-300 text-[0.7rem] sm:text-xs md:text-sm break-words cursor-default">
          ${ctaText}
        </button>
      `;
    }
  }

  function renderResults(programs) {
    resultsEl.innerHTML = "";

    if (!programs.length) {
      resultsEl.innerHTML =
        `<p class="text-gray-400 text-center py-8">No matches found.</p>`;
      return;
    }

    programs.forEach(program => {
      const logo = getLogoPath(program);

      const city    = (program.city || "").toString();
      const state   = (program.state || "").toString().toUpperCase();
      const cityLine = [city, state].filter(Boolean).join(", ").toUpperCase();

      // Try both camelCase + snake_case / legacy names so we don't break if backend differs a bit
      const natRank   = program.nationalRank || program.yatstats_national_rank || "-";
      const stateRank = program.stateRank    || program.yatstats_state_rank    || "-";

      const active    = program.currentActiveAlumni      || program.current_active_alumni      || 0;
      const majors    = program.mlbPlayersProduced       || program.mlb_players_produced       || 0;
      const alumni    = program.allTimeNextLevelAlumni   || program.all_time_next_level_alumni || 0;
      const draftedHS = program.draftedOutOfHighSchool   || program.drafted_out_of_high_school || 0;
      const draftedTot= program.draftedTotal             || program.drafted                    || 0;

      const ctaHTML = buildCta(program);

      const cardHTML = `
        <div class="mb-10 p-6 md:p-8 bg-[#050505] border border-neutral-800 rounded-xl shadow-lg">
          <div class="flex items-center gap-4 mb-6">
            <img src="${logo}"
                 class="h-20 w-20 object-contain bg-neutral-900 rounded"
                 loading="lazy"
                 onerror="this.onerror=null;this.src='${LOGO_FALLBACK}';">
            <div class="h-20 flex flex-col justify-center gap-1">
              <p class="banner-small text-[0.6rem] md:text-xs text-neutral-400">
                ${cityLine}
              </p>
              <p class="banner-school text-2xl md:text-3xl">
                ${(program.hsname || "").toUpperCase()}
              </p>
              <p class="banner-small text-[0.6rem] md:text-xs text-neutral-300">
                ACTIVE ALUMNI
              </p>
            </div>
          </div>

          <div class="grid grid-cols-2 sm:grid-cols-3 gap-4 mb-6">
            <div class="bg-neutral-900 rounded p-4 text-center">
              <p class="text-2xl font-bold">${active}</p>
              <p class="text-xs text-neutral-400">Current Active Alumni</p>
            </div>
            <div class="bg-neutral-900 rounded p-4 text-center">
              <p class="text-2xl font-bold">${majors}</p>
              <p class="text-xs text-neutral-400">MLB Players Produced</p>
            </div>
            <div class="bg-neutral-900 rounded p-4 text-center">
              <p class="text-2xl font-bold">${natRank}</p>
              <p class="text-xs text-neutral-400">National Rank</p>
            </div>
            <div class="bg-neutral-900 rounded p-4 text-center">
              <p class="text-2xl font-bold">${stateRank}</p>
              <p class="text-xs text-neutral-400">State Rank</p>
            </div>
            <div class="bg-neutral-900 rounded p-4 text-center">
              <p class="text-2xl font-bold">${alumni}</p>
              <p class="text-xs text-neutral-400">All-Time Next Level Alumni</p>
            </div>
            <div class="bg-neutral-900 rounded p-4 text-center">
              <p class="text-2xl font-bold">${draftedHS}/${draftedTot}</p>
              <p class="text-xs text-neutral-400">Drafted HS / Total</p>
            </div>
          </div>

          <div class="mt-2">
            ${ctaHTML}
          </div>
        </div>
      `;

      resultsEl.insertAdjacentHTML("beforeend", cardHTML);
    });
  }

  function renderPagination() {
    paginationEl.innerHTML = "";

    if (totalPages <= 1) return;

    const info = document.createElement("span");
    info.textContent = `Page ${currentPage} of ${totalPages}`;
    info.className = "text-neutral-400";

    const makeBtn = (label, onClick, disabled) => {
      const base = "px-3 py-2 rounded border border-neutral-700";
      const cls = disabled
        ? `${base} text-neutral-500 cursor-not-allowed`
        : `${base} bg-neutral-900 text-neutral-200 hover:bg-neutral-800`;
      const btn = document.createElement("button");
      btn.textContent = label;
      btn.className = cls;
      if (!disabled) btn.addEventListener("click", () => {
        onClick();
        scrollToResultsTop();
      });
      return btn;
    };

    const prevBtn = makeBtn("Prev", () => search(currentPage - 1), currentPage === 1);
    const nextBtn = makeBtn("Next", () => search(currentPage + 1), currentPage === totalPages);

    paginationEl.appendChild(prevBtn);
    paginationEl.appendChild(info);
    paginationEl.appendChild(nextBtn);
  }

  async function search(page = 1) {
    const qInput = document.getElementById("school-search-input");
    const stateSel = document.getElementById("state-filter");

    lastQuery = (qInput.value || "").trim();
    lastState = (stateSel.value || "").trim();

    try {
      loadingEl.classList.remove("hidden");
      resultsWrap.classList.remove("hidden");
      feedbackEl.classList.add("hidden");

      const params = new URLSearchParams();
      if (lastQuery) params.set("q", lastQuery);
      if (lastState) params.set("state", lastState);
      params.set("page", page.toString());

      const res = await fetch(`/api/hs-programs?${params.toString()}`, {
        cache: "no-store"
      });

      if (!res.ok) throw new Error("HTTP " + res.status);

      const data = await res.json();
      const programs   = data.programs || data.results || [];
      currentPage      = data.page || 1;
      totalPages       = data.totalPages || 1;

      renderResults(programs);
      renderPagination();
    } catch (err) {
      console.error(err);
      feedbackEl.textContent =
        "Couldn’t load the HS directory. Check the /api/hs-programs endpoint.";
      feedbackEl.classList.remove("hidden");
    } finally {
      loadingEl.classList.add("hidden");
    }
  }

  /* Wire up events */
  document.getElementById("search-button")
    .addEventListener("click", () => search(1));

  document.getElementById("school-search-input")
    .addEventListener("keydown", (e) => {
      if (e.key === "Enter") search(1);
    });

  document.getElementById("state-filter")
    .addEventListener("change", () => search(1));

  fillStateDropdown();

  // Initial load: show first page of "everything"
  search(1);
</script>

</body>
</html>