<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Active Alumni News • Hamilton YATSTATS</title>
<link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Oswald:wght@300;400&family=Bebas+Neue&display=swap" rel="stylesheet">

<!-- Firebase init (same pattern as index.html) -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, signInWithCustomToken, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
  window.firebaseAuth = { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, signInWithCustomToken, signInAnonymously };
  try {
    const firebaseConfig = JSON.parse(window.__firebase_config || '{}');
    const app = initializeApp(firebaseConfig);
    window.auth = getAuth(app);
    onAuthStateChanged(window.auth, user => { document.dispatchEvent(new CustomEvent('authStateChanged', { detail: { user } })); });
    if (window.__initial_auth_token) { await signInWithCustomToken(window.auth, window.__initial_auth_token); }
    else { await signInAnonymously(window.auth); }
  } catch (e) { console.error("Firebase initialization error:", e); }
</script>

<style>
:root{
  --bg:#0c0c0c; --fg:#f2f2f2; --muted:#c4c4c4; --ink:#e8e8e8; --line:rgba(255,255,255,.08);
  --card-bg:#171717; --header-bg:#000; --drawer-bg:rgba(10,10,10,.65);
  --shade-end:rgba(0,0,0,.95);
  --hamSmall:13px; --hamBig:20px; --hamBigger:24px; --tagGrey:#cfd2d6;
  --crestH:clamp(28px,4.2vw,42px);
  --containerPad:16px; --footerH:clamp(56px,8vh,77px);
}
body.light-theme{
  --bg:#f4f4f4; --fg:#121212; --muted:#555; --ink:#222; --line:rgba(0,0,0,.1);
  --card-bg:#fff; --header-bg:#fff; --drawer-bg:rgba(255,255,255,.65);
}
@font-face{font-family:'Indigo';src:url('assets/fonts/Indigo.otf') format('opentype');font-weight:400;font-style:normal;font-display:swap;}
*{box-sizing:border-box} html,body{margin:0}
body{background:var(--bg);color:var(--fg);font-family:Oswald,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;transition:background-color .3s,color .3s;}
body.drawer-open{overflow:hidden}
a{color:inherit;text-decoration:none}
.container{max-width:1400px;margin:0 auto;padding:0 var(--containerPad)}
.header{position:sticky;top:0;z-index:50;background:var(--header-bg);transition:background-color .3s;}
.topbar{display:flex;align-items:center;justify-content:space-between;padding:8px 0}
.left-icons{display:flex;align-items:center;gap:8px}
.icon-btn{background:none;border:none;color:var(--fg);opacity:.92;display:inline-flex;align-items:center;justify-content:center;padding:0;margin:0 2px;cursor:pointer}
.icon-btn i{font-size:20px}
.topnav{display:flex;gap:18px;align-items:center}
.nav-pair{white-space:nowrap}
.nav-pair .thin{font:300 var(--hamSmall) Oswald,sans-serif;letter-spacing:.02em;color:#cfd2d6;margin-right:2px}
body.light-theme .nav-pair .thin{color:var(--muted)}
.nav-pair .bold{font:400 var(--hamSmall) Indigo,"Bebas Neue",sans-serif}
.wordmark-wrap{display:flex;align-items:center;justify-content:flex-end;min-width:120px}
.wordmark-img{height:clamp(18px,3.2vw,28px);width:auto;display:block}
body.light-theme .wordmark-img{filter:invert(1)}
@media (max-width:1200px){.topnav{display:none !important}}
.hr-y{border-top:1px solid var(--line)}
.schoolrow{display:flex;align-items:center;gap:10px;padding:6px var(--containerPad)}
.ham-logo{height:var(--crestH);width:auto;object-fit:contain;display:block;flex-shrink:0}
.schooltext{line-height:1}
.schooltext .small{font:300 var(--hamSmall)/1 Oswald;letter-spacing:.02em;color:var(--muted)}
.schooltext .big1{font:400 var(--hamBig)/1 "Bebas Neue",sans-serif}
.schooltext .big2{font:400 var(--hamBigger)/1 "Bebas Neue",sans-serif;margin-top:-4px}
.crumbs{font:300 calc(var(--hamSmall)*.5)/1 Oswald;letter-spacing:.02em;color:var(--muted);text-transform:uppercase}
.hero{padding:2px 0}
.hero-grid{display:flex;align-items:center;justify-content:space-between;gap:16px}
.hero-left{display:flex;flex-direction:column;gap:4px}
.hero-crumbs{margin:0;text-align:left;white-space:nowrap}
@media (max-width:768px){.topbar .crumbs{display:block}.hero-left .crumbs{display:none}}
@media (min-width:769px){.topbar .crumbs{display:none}.hero-left .crumbs{display:block}}
.tag-duo{position:relative;height:1.8em}
.tag-swap{position:absolute;left:0;top:0;right:0;opacity:0;animation:swap 6s infinite;white-space:nowrap}
.tag-swap:nth-child(1){animation-delay:0s}
.tag-swap:nth-child(2){animation-delay:3s}
.tag-grey{font:300 1em Oswald,sans-serif;letter-spacing:.02em;color:var(--tagGrey)}
body.light-theme .tag-grey{color:var(--muted)}
.tag-bold{font:400 1em Indigo,"Bebas Neue",sans-serif}
@keyframes swap{0%{opacity:0}5%{opacity:1}45%{opacity:1}50%{opacity:0}100%{opacity:0}}
.hero-right{display:flex;gap:10px}
.hero-icon i{font-size:20px}

.drawer-mask{position:fixed;inset:0;background:rgba(0,0,0,.35);opacity:0;pointer-events:none;transition:opacity .2s;z-index:60}
.drawer{position:fixed;top:0;bottom:0;width:min(360px,82vw);background:var(--drawer-bg);backdrop-filter:blur(4px);color:var(--ink);transform:translateX(-110%);transition:transform .25s,background-color .3s;z-index:70}
.drawer-right{right:0;left:auto;transform:translateX(110%);display:flex;flex-direction:column;height:100%}
.drawer h3{margin:18px 16px 8px;padding-right:30px}
.drawer .pad{padding:10px 16px}
.drawer .close-btn{position:absolute;top:12px;right:12px}
.drawer a{color:var(--ink)}
.drawer a:hover{color:var(--fg)}
body.drawer-left-open .drawer-mask,body.drawer-right-open .drawer-mask{opacity:1;pointer-events:auto}
body.drawer-left-open #drawerLeft{transform:translateX(0)}
body.drawer-right-open .drawer-right{transform:translateX(0)}
.drawer-content{flex-grow:1;overflow-y:auto;padding:10px 16px}
.drawer-footer{flex-shrink:0;padding:12px 16px;border-top:1px solid var(--line);background:rgba(10,10,10,.8);display:flex;gap:10px;align-items:center}
body.light-theme .drawer-footer{background:rgba(255,255,255,.8)}

.filter-group{border-bottom:1px solid var(--line)}
.filter-group:last-of-type{border-bottom:none}
.filter-title{padding:14px 0;cursor:pointer;font-weight:700;font-family:"Bebas Neue",sans-serif;letter-spacing:.05em;list-style:none;display:flex;justify-content:space-between;align-items:center}
.filter-title::-webkit-details-marker{display:none}
.filter-title::after{content:'▸';font-size:1.2em;transition:transform .2s}
details[open]>.filter-title::after{transform:rotate(90deg)}
.filter-options{padding:4px 0 16px 0}
.filter-options label{display:block;margin-bottom:8px;padding-left:4px}
.filter-options input[type=checkbox]{margin-right:8px;transform:scale(1.1)}
.select-all-label{font-weight:700;border-bottom:1px solid var(--line);padding-bottom:8px !important;margin-bottom:12px !important}

#liveResults{margin:10px 4px 18px;max-height:55vh;overflow:auto}
.live-hit{padding:10px 12px;display:flex;align-items:center;gap:10px;border-radius:10px;cursor:pointer}
.live-hit:hover{background:var(--line)}
.live-hit img{width:36px;height:36px;border-radius:6px;object-fit:cover}

.auth-tabs{display:flex;border-bottom:1px solid var(--line)}
.auth-tab{flex:1;text-align:center;padding:10px;cursor:pointer;background:transparent;border:none;color:var(--muted);font-family:"Bebas Neue",sans-serif;font-size:16px;letter-spacing:.05em}
.auth-tab.active{color:var(--fg);border-bottom:2px solid var(--fg)}
.auth-form{display:none}
.auth-form.active{display:block}
.form-field{margin-bottom:15px}
.form-field label{display:block;margin-bottom:5px;font-size:12px}
.form-field input{width:100%;padding:10px;border-radius:8px;border:1px solid var(--line);background:rgba(255,255,255,.06);color:var(--ink)}
body.light-theme .form-field input{background:rgba(0,0,0,.06)}
.auth-btn{width:100%;padding:12px;background:var(--fg);color:var(--bg);border:none;border-radius:8px;font-family:"Bebas Neue",sans-serif;font-size:16px;letter-spacing:.08em;cursor:pointer}
#authMessage{margin-top:15px;text-align:center;font-size:13px}
.error{color:#fca5a5}
.success{color:#86efac}

.main{padding:8px 0 calc(var(--footerH) + 12px)}
/* Layout: 3 columns desktop (Pro, College, Lines); 2 columns tablet (News, Lines); 1 column mobile (News), Lines in drawer */
.page-grid{display:grid;gap:16px;grid-template-columns:2fr 1fr 1fr}
@media (max-width:1100px){ .page-grid{grid-template-columns:2fr 1fr} }
@media (max-width:768px){ .page-grid{grid-template-columns:1fr} }

/* Section shells */
.section{background:var(--card-bg);border:1px solid var(--line);border-radius:12px;overflow:hidden;display:flex;flex-direction:column;min-height:200px}
.section-header{background:rgba(255,255,255,.06);padding:10px 12px;font:700 16px "Bebas Neue",sans-serif;letter-spacing:.06em}
.section-body{padding:10px 12px;display:flex;flex-direction:column;gap:10px}

/* News cards */
.news-card{display:grid;grid-template-columns:100px 1fr;gap:10px;padding:10px;border:1px solid var(--line);border-radius:10px}
.news-thumb{width:100%;aspect-ratio:5/7;border-radius:8px;background:#000 center/cover no-repeat}
.news-title{font:700 16px/1.15 "Bebas Neue",sans-serif;letter-spacing:.03em}
.news-meta{font:300 12px/1 Oswald,sans-serif;opacity:.8;margin-top:3px}
.news-actions{display:flex;gap:8px;margin-top:8px;align-items:center;flex-wrap:wrap}
.news-actions .btn{display:inline-flex;align-items:center;gap:6px;padding:6px 8px;border:1px solid var(--line);border-radius:8px;font:700 11px "Bebas Neue",sans-serif;letter-spacing:.05em;cursor:pointer;background:transparent}
.news-actions a.btn{ text-decoration:none }
.news-actions .btn i{font-size:16px}
.btn.read{margin-left:auto}
.copy-toast{font:300 12px Oswald;opacity:.85}

/* Line scores column (independent scroll) */
.lines-wrap{display:flex;flex-direction:column;height:100%}
.lines-body{padding:10px 12px;overflow:auto;max-height:70vh;display:flex;flex-direction:column;gap:16px;border-top:1px solid var(--line)}
.week-block{border:1px solid var(--line);border-radius:10px;overflow:hidden}
.week-head{background:rgba(255,255,255,.06);padding:8px 10px;font:700 16px "Bebas Neue",sans-serif;letter-spacing:.06em}
.player-block{padding:8px 10px;border-top:1px solid var(--line)}
.player-title{font:700 16px "Bebas Neue",sans-serif;letter-spacing:.06em}
.lines-list{margin-top:4px;display:flex;flex-direction:column;gap:2px}
.line-row{font:300 14px/1.2 Oswald}
.line-row b{font-weight:400}

/* Drawer for mobile line scores */
@media (max-width:768px){
  #drawerLines .drawer-content{padding:0}
  .lines-body{max-height:unset;height:calc(100% - 48px)}
}

/* Light theme tweaks */
body.light-theme .section-header, body.light-theme .week-head{background:rgba(0,0,0,.04)}
/* Ensure IG glyph visible in both themes (inherit currentColor) */
.ri-instagram-line{filter:none}
</style>
</head>

<body>
<header class="header">
  <div class="container topbar">
    <div class="left-icons">
      <button class="icon-btn" id="btnMenu" aria-label="Menu"><i class="ri-menu-line"></i></button>
      <div id="auth-container">
        <button class="icon-btn" id="btnAccount" aria-label="Account"><i class="ri-user-3-line"></i></button>
        <button class="icon-btn" id="btnSignOut" style="display:none;"><i class="ri-logout-box-line"></i></button>
      </div>
      <button class="icon-btn" id="theme-toggle" aria-label="Toggle Theme"><i class="ri-sun-line"></i></button>
    </div>
    <nav class="topnav" aria-label="Top Navigation">
      <a href="index.html" class="nav-pair"><span class="thin">WHERE THEY</span><span class="bold">YAT?</span></a>
      <a href="alumni-news.html" class="nav-pair"><span class="thin">ACTIVE ALUMNI</span><span class="bold">NEWS</span></a>
      <a href="all-time-list.html" class="nav-pair"><span class="thin">NEXT-LEVEL</span><span class="bold">ALL-TIME LIST</span></a>
      <a href="marketplace.html" class="nav-pair"><span class="thin">NIL & YAT-A-BOY</span><span class="bold">MARKETPLACE</span></a>
      <a href="current-team.html" class="nav-pair"><span class="thin">THE</span><span class="bold">CURRENT TEAM</span></a>
      <a href="partner-program.html" class="nav-pair"><span class="thin">PCD ACTION</span><span class="bold">PARTNER PROGRAM</span></a>
      <a href="faq.html" class="nav-pair"><span class="bold">FAQ’S</span></a>
    </nav>
    <div class="wordmark-wrap">
      <img class="wordmark-img" src="assets/img/yatstats-logo.png" alt="YAT?STATS">
    </div>
  </div>
  <div class="hr-y"></div>
  <div class="container schoolrow">
    <img id="hamLogo" class="ham-logo" src="assets/img/hamilton-logo.png" alt="Hamilton H">
    <div class="schooltext">
      <div class="small">CHANDLER, AZ</div>
      <div class="big1">HAMILTON HIGH SCHOOL</div>
      <div class="big2">ACTIVE ALUMNI NEWS</div>
    </div>
  </div>
  <div class="hr-y"></div>
  <section class="hero">
    <div class="container hero-grid">
      <div class="hero-left" aria-live="polite">
        <div class="tag-duo">
          <div class="tag-swap"><span class="tag-grey">ACTIVE ALUMNI</span> <span class="tag-bold">NEWS</span></div>
          <div class="tag-swap"><span class="tag-grey">WEEKLY</span> <span class="tag-bold">LINE SCORES</span></div>
        </div>
        <div class="crumbs hero-crumbs">HAMILTON ▸ ACTIVE ALUMNI NEWS</div>
      </div>
      <div class="hero-right">
        <button id="openSearch" class="hero-icon icon-btn" aria-label="Open search"><i class="ri-search-line"></i></button>
        <button id="openFilters" class="hero-icon icon-btn" aria-label="Open filters"><i class="ri-filter-3-line"></i></button>
        <button id="openLinesMobile" class="hero-icon icon-btn" aria-label="Weekly Line Scores (mobile)"><i class="ri-newspaper-line"></i></button>
      </div>
    </div>
  </section>
</header>

<div class="drawer-mask"></div>

<!-- Left: Navigation & Player Profile Search -->
<aside class="drawer" id="drawerLeft" aria-label="Left drawer">
  <button class="icon-btn close-btn"><i class="ri-close-line"></i></button>
  <div class="drawer-content">
    <h3>PLAYER PROFILE SEARCH</h3>
    <div class="pad">
      <input id="playerSearch" placeholder="Type player, team, org, or college…" style="width:100%;padding:10px;border-radius:10px;border:1px solid var(--line);background:rgba(255,255,255,.06);color:var(--ink)">
      <div id="liveResults"></div>
    </div>
    <h3>NAVIGATION</h3>
    <div class="pad" style="display:flex;flex-direction:column;gap:12px">
      <a href="index.html" class="nav-pair"><span class="thin">WHERE THEY</span><span class="bold">YAT?</span></a>
      <a href="alumni-news.html" class="nav-pair"><span class="thin">ACTIVE ALUMNI</span><span class="bold">NEWS</span></a>
      <a href="all-time-list.html" class="nav-pair"><span class="thin">NEXT-LEVEL</span><span class="bold">ALL-TIME LIST</span></a>
      <a href="marketplace.html" class="nav-pair"><span class="thin">NIL & YAT-A-BOY</span><span class="bold">MARKETPLACE</span></a>
      <a href="current-team.html" class="nav-pair"><span class="thin">THE</span><span class="bold">CURRENT TEAM</span></a>
      <a href="partner-program.html" class="nav-pair"><span class="thin">PCD ACTION</span><span class="bold">PARTNER PROGRAM</span></a>
      <a href="faq.html" class="nav-pair"><span class="bold">FAQ’S</span></a>
    </div>
  </div>
</aside>

<!-- Right: Filters -->
<aside class="drawer drawer-right" id="drawerFilters" style="display:flex;">
  <button class="icon-btn close-btn"><i class="ri-close-line"></i></button>
  <h3>FILTERS</h3>
  <div class="drawer-content" id="filters">
    <details class="filter-group" open>
      <summary class="filter-title">By Name</summary>
      <div class="filter-options">
        <input id="filterName" placeholder="Type a name…" style="width:100%;padding:10px;border-radius:10px;border:1px solid var(--line);background:rgba(255,255,255,.06);color:var(--ink)"/>
      </div>
    </details>

    <details class="filter-group">
      <summary class="filter-title">By Status</summary>
      <div class="filter-options" id="filterStatus">
        <label class="select-all-label"><input type="checkbox" class="select-all"> Select All</label>
        <label><input type="checkbox" value="ACTIVE 2025"> ACTIVE 2025</label>
        <label><input type="checkbox" value="ACTIVE 2024"> ACTIVE 2024</label>
        <label><input type="checkbox" value="FREE AGENT"> FREE AGENT</label>
        <label><input type="checkbox" value="INJURED"> INJURED</label>
        <label><input type="checkbox" value="RETIRED"> RETIRED</label>
        <label><input type="checkbox" value="SPONSOR"> SPONSOR</label>
      </div>
    </details>

    <details class="filter-group">
      <summary class="filter-title">By Level</summary>
      <div class="filter-options" id="filterLevels">
        <label class="select-all-label"><input type="checkbox" class="select-all"> Select All</label>
      </div>
    </details>

    <details class="filter-group">
      <summary class="filter-title">By Graduating Class</summary>
      <div class="filter-options" id="filterGradClass"></div>
    </details>

    <details class="filter-group">
      <summary class="filter-title">By Roster Year</summary>
      <div class="filter-options" id="filterRosterYear"></div>
    </details>

    <details class="filter-group" open>
      <summary class="filter-title">By Date Range (affects News + Line Scores)</summary>
      <div class="filter-options">
        <label>Start Date<br><input type="date" id="dateStart" style="width:100%;padding:10px;border-radius:10px;border:1px solid var(--line);background:rgba(255,255,255,.06);color:var(--ink)"></label>
        <label>End Date<br><input type="date" id="dateEnd" style="width:100%;padding:10px;border-radius:10px;border:1px solid var(--line);background:rgba(255,255,255,.06);color:var(--ink)"></label>
      </div>
    </details>
  </div>
  <div class="drawer-footer">
    <button id="filtersReset" class="icon-btn" style="padding:10px 14px;border:1px solid var(--line);border-radius:12px"><i class="ri-restart-line"></i>&nbsp;Reset Filters</button>
  </div>
</aside>

<!-- Mobile Line Scores Drawer -->
<aside class="drawer drawer-right" id="drawerLines" style="display:none;">
  <button class="icon-btn close-btn"><i class="ri-close-line"></i></button>
  <h3>WEEKLY LINE SCORES</h3>
  <div class="drawer-content">
    <div class="lines-wrap">
      <div class="week-head">Last 4 weeks</div>
      <div id="linesMobile" class="lines-body"><p style="opacity:.8;padding:10px">Loading weekly line scores…</p></div>
    </div>
  </div>
</aside>

<main class="main container">
  <div class="page-grid" aria-live="polite">
    <!-- News (Pros) -->
    <section class="section">
      <div class="section-header">ALUMNI HEADLINES (Pros)</div>
      <div id="newsPros" class="section-body">
        <p style="color:var(--muted)">Loading pro headlines…</p>
      </div>
    </section>

    <!-- News (College) -->
    <section class="section">
      <div class="section-header">ALUMNI HEADLINES (College)</div>
      <div id="newsCollege" class="section-body">
        <p style="color:var(--muted)">Loading college headlines…</p>
      </div>
    </section>

    <!-- Weekly Line Scores (independent scroll) -->
    <section class="section">
      <div class="section-header">WEEKLY LINE SCORES</div>
      <div class="lines-wrap">
        <div id="linesDesktop" class="lines-body">
          <p style="color:var(--muted)">Loading weekly line scores…</p>
        </div>
      </div>
    </section>
  </div>
</main>

<footer class="site-footer">
  <a href="https://no-errors.com/collections/all-webgems" target="_blank" rel="noopener noreferrer">
    <img src="assets/img/partners/no-errors-banner.jpg" alt="Sponsor Banner">
  </a>
</footer>

<script type="module">
/* -------------------- CONFIG -------------------- */
const ROSTER_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQcWJM6Q6hTdFnES_G5LUy4teCS-sJ5HdAc9F5HSY8DGE9egdGy8yUAe2ShT3tFm-CwUuCYeAYy_YiW/pub?gid=2028135390&single=true&output=csv";
const GAMES_CSV_URL  = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQcWJM6Q6hTdFnES_G5LUy4teCS-sJ5HdAc9F5HSY8DGE9egdGy8yUAe2ShT3tFm-CwUuCYeAYy_YiW/gviz/tq?tqx=out:csv&sheet=GAMES";
const NEWS_JSON_URL  = "assets/news/alumni_news.json"; // pre-seeded JSON you maintain
const NEWS_CACHE_KEY = "YAT_NEWS_CACHE_V1";

/* -------------------- UTILS -------------------- */
const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
const debounce = (fn, ms=300)=>{ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),ms); }; };

const levelOrder = {
  'MLB':13,'INTERNATIONAL':12,'TRIPLE-A':11,'AAA':11,'DOUBLE-A':10,'AA':10,'HIGH-A':9,'A+':9,'LOW-A':8,'A':8,'ROOKIE':7,'ROK':7,'INDY':6,
  'NCAA-D1':5,'NCAA-D2':4,'NCAA-D3':3,'NAIA':2,'JUCO':1
};
function slugify(s){ return String(s||'').trim().toLowerCase().replace(/[^a-z0-9]+/g,'-'); }
function imageKey(first,last){ return `${String(first||'').toLowerCase()}_${String(last||'').toLowerCase()}`.replace(/[^a-z0-9_]+/g,''); }
function twoDigit(n){ return n<10 ? '0'+n : ''+n; }
function fmtMD(d){ return `${d.getMonth()+1}/${d.getDate()}`; }

/* Robust date parsing: ISO, locale, mm/dd, and Excel serial fallback */
function parseMaybeDate(v){
  if (!v && v!==0) return null;
  const s = String(v).trim();
  // numeric serial (Google sometimes emits as 45234.5)
  if (/^\d+(\.\d+)?$/.test(s)){
    const serial = parseFloat(s);
    const ms = (serial - 25569) * 86400000; // Excel serial to ms (epoch 1899-12-30)
    if (!isNaN(ms)) return new Date(ms);
  }
  // try native
  const dt = new Date(s);
  if (!isNaN(dt)) return dt;
  // mm/dd or m/d
  const m = s.match(/^(\d{1,2})[\/\-](\d{1,2})(?:[\/\-](\d{2,4}))?(\s+\d{1,2}:\d{2}(\s*[AP]M)?)?$/i);
  if (m){
    const mm = +m[1], dd=+m[2], yy = m[3]? +m[3] : (new Date()).getFullYear();
    const d = new Date(yy<100? (2000+yy):yy, mm-1, dd);
    if (m[4]){ // time too
      const t = m[4].trim().toUpperCase();
      const tm = Date.parse(`${mm}/${dd}/${yy} ${t}`);
      if (!isNaN(tm)) return new Date(tm);
    }
    return d;
  }
  return null;
}

/* Last 4 Sunday-Saturday weeks ending with the last completed Saturday */
function recentWeeks(n=4){
  const today = new Date();
  const dow = today.getDay(); // 0=Sun..6=Sat
  // end on last Saturday (if today is Sat, use today)
  const lastSat = new Date(today); lastSat.setDate(today.getDate() - ((dow+1)%7));
  lastSat.setHours(23,59,59,999);
  const weeks=[];
  for(let i=0;i<n;i++){
    const end = new Date(lastSat); end.setDate(lastSat.getDate() - 7*i);
    const start = new Date(end); start.setDate(end.getDate()-6); start.setHours(0,0,0,0);
    weeks.push({start,end});
  }
  return weeks;
}
function weekLabel({start,end}){
  const opt={month:'long', day:'numeric'};
  return `Week of ${start.toLocaleDateString(undefined,opt)} - ${end.toLocaleDateString(undefined,opt)}`;
}

/* -------------------- LOADERS -------------------- */
async function loadCSV(url){
  const res = await fetch(url, {cache:'no-store'});
  if(!res.ok) throw new Error(`HTTP ${res.status}`);
  const text = await res.text();
  const rows = text.trim().split(/\r?\n/).map(line =>
    line.split(/,(?=(?:[^"]*"[^"]*")*[^"]*$)/).map(c=>c.replace(/^"|"$/g,''))
  );
  const header = rows.shift().map(h=>h.trim());
  const idx = name => header.indexOf(name);
  return { header, idx, rows };
}

/* Roster (for level + grad class + team/org mapping) */
async function loadRoster(){
  const {header, idx, rows} = await loadCSV(ROSTER_CSV_URL);
  const statKeys = ['avg','obp','slg','ops','ab','h','r','rbi','2b','3b','hr','sb','bb','era','k/9','k/bb','whip','ip','er','ko','gp','w-l','saves','fip'];
  const list = rows.map((r,i)=>({
    id: r[idx('id')] || String(i+2),
    display_name:r[idx('display_name')], first:r[idx('first')], last:r[idx('last')],
    grad_class:r[idx('grad_class')], letter_years:r[idx('letter_years')], status:r[idx('status')], level:r[idx('level')],
    team:r[idx('team')], org:r[idx('org')], colleges:r[idx('Colleges')] ?? r[idx('colleges')],
    slug:r[idx('slug')]
  }));
  const byNameUC = new Map(list.map(p=>[String(p.display_name||'').toUpperCase(), p]));
  return { list, byNameUC };
}

/* GAMES (weekly line scores) */
async function loadGames(){
  const {header, idx, rows} = await loadCSV(GAMES_CSV_URL);
  const fi = {
    name: idx('player_name'),
    line: idx('daily_line_score'),
    date: idx('GameDateLocal'),
    opp:  idx('Opponent'),
    ha:   idx('HomeAway')
  };
  if (Object.values(fi).some(v=>v<0)) throw new Error('GAMES header mismatch. Expect columns: player_name, daily_line_score, GameDateLocal, Opponent, HomeAway');

  return rows.map(r=>{
    const name = r[fi.name];
    const line = r[fi.line];
    const when = parseMaybeDate(r[fi.date]);
    const opp  = r[fi.opp];
    const ha   = r[fi.ha]; // H/A or Home/Away
    return { name, line, when, opp, ha, rawDate:r[fi.date] };
  }).filter(g=>g.name && g.when); // keep only rows with a parsable date
}

/* News (from JSON, cached) */
function getNewsCache(){ try{ return JSON.parse(localStorage.getItem(NEWS_CACHE_KEY)||'{}'); }catch{return{};} }
function setNewsCache(items){ localStorage.setItem(NEWS_CACHE_KEY, JSON.stringify({updatedAt:new Date().toISOString(),items})); }
async function ensureNews(){
  const cur = getNewsCache();
  if (Array.isArray(cur.items) && cur.items.length) return cur.items;
  try{
    const res = await fetch(NEWS_JSON_URL, {cache:'no-store'});
    const arr = await res.json();
    setNewsCache(Array.isArray(arr)?arr:[]);
  }catch{ setNewsCache([]); }
  return (getNewsCache().items||[]);
}

/* -------------------- RENDER: NEWS -------------------- */
function isCollegeLevel(level){
  const L = String(level||'').toUpperCase();
  return L.startsWith('NCAA') || L==='NAIA' || L==='JUCO';
}
function buildShare(message, url){
  const encMsg = encodeURIComponent(message);
  const encURL = encodeURIComponent(url);
  return {
    x: `https://twitter.com/intent/tweet?text=${encMsg}%20${encURL}`,
    fb:`https://www.facebook.com/sharer/sharer.php?u=${encURL}&quote=${encMsg}`,
    mail:`mailto:?subject=${encodeURIComponent('I SEE WHERE YAT?!')}&body=${encMsg}%0A%0A${encURL}`
  };
}
function promoMessage(playerName, title){
  const first = String(playerName||'').split(' ')[0].replace(/[^A-Za-z]/g,'');
  const hash = `#YATABOY${first.toUpperCase()}`;
  const slug = String(title||'').replace(/\s+/g,' ').trim();
  return `I SEE WHERE YAT ${playerName}! CHECK OUT “${slug}” on YATSTATS! ${hash}`;
}
function newsCard(n){
  const img = n.image || `https://picsum.photos/seed/${encodeURIComponent(n.id||n.title||'news')}/500/700`;
  const when = n.publishedAt ? new Date(n.publishedAt).toLocaleString() : '';
  const base = String(n.url || '#');
  const read = base + (base.includes('?') ? '&' : '?') + 'utm_source=yatstats&utm_medium=news';
  const msg = promoMessage(n.player_display_name || '', n.title || '');
  const share = buildShare(msg, read);
  return `<div class="news-card">
    <div class="news-thumb" style="background-image:url('${img}')"></div>
    <div>
      <div class="news-title">${n.title||'Read more'}</div>
      <div class="news-meta">${n.source||'News'} • ${when}</div>
      <div class="news-actions">
        <a class="btn" href="${share.x}" target="_blank" rel="noopener"><i class="ri-twitter-x-line"></i> X</a>
        <a class="btn" href="${share.fb}" target="_blank" rel="noopener"><i class="ri-facebook-circle-line"></i> Facebook</a>
        <a class="btn" href="${share.mail}"><i class="ri-mail-line"></i> Email</a>
        <button class="btn btn-ig" data-copy="${msg} ${read}"><i class="ri-instagram-line"></i> Instagram</button>
        <a class="btn" href="marketplace.html" target="_self"><i class="ri-store-2-line"></i> YAT-A-BOY MARKETPLACE</a>
        <a class="btn read" href="${read}" target="_blank" rel="noopener">READ MORE&nbsp;<i class="ri-arrow-right-line"></i></a>
        <span class="copy-toast" hidden>Caption copied!</span>
      </div>
    </div>
  </div>`;
}
function renderNews(allNews, rosterByName){
  // Annotate each news with level from roster
  const withLevel = allNews.map(n=>{
    const key = String(n.player_display_name||'').toUpperCase();
    const ro = rosterByName.get(key);
    return {...n, _level: ro?.level};
  });
  // Date range filter (applies to news too)
  const {start,end} = readDateRange();
  const inRange = n=>{
    if(!n.publishedAt) return true;
    const d = new Date(n.publishedAt);
    if (isNaN(d)) return true;
    if (start && d < start) return false;
    if (end   && d > end)   return false;
    return true;
  };
  const sorted = withLevel.filter(inRange).sort((a,b)=> new Date(b.publishedAt||0) - new Date(a.publishedAt||0));
  const pros = sorted.filter(n=>!isCollegeLevel(n._level)).slice(0,200);
  const colg = sorted.filter(n=> isCollegeLevel(n._level)).slice(0,200);
  $('#newsPros').innerHTML    = pros.length ? pros.map(newsCard).join('') : `<p style="opacity:.8">No pro headlines in this range.</p>`;
  $('#newsCollege').innerHTML = colg.length ? colg.map(newsCard).join('') : `<p style="opacity:.8">No college headlines in this range.</p>`;
  // IG copy handler
  $$('.btn-ig').forEach(btn=>{
    btn.addEventListener('click', async ()=>{
      try{
        await navigator.clipboard.writeText(btn.dataset.copy||'');
        const toast = btn.parentElement.querySelector('.copy-toast');
        if (toast){ toast.hidden=false; setTimeout(()=>toast.hidden=true, 1600); }
      }catch{}
    });
  });
}

/* -------------------- RENDER: WEEKLY LINE SCORES -------------------- */
function haMarker(ha){
  const s = String(ha||'').trim().toUpperCase();
  if (s.startsWith('H')) return 'vs.';
  if (s.startsWith('A')) return '@';
  return '@';
}
function timeIfPresent(dateSrc){
  // try to extract time portion if present in the original cell (like "9/17/2025 7:30 PM")
  const m = String(dateSrc||'').match(/(\d{1,2}:\d{2}\s*[AP]M)/i);
  return m ? m[1].toUpperCase().replace(/\s+/g,' ') : 'TBD';
}
function groupLinesByWeeks(games, rosterByName){
  const now = new Date();
  const weeks = recentWeeks(4);
  const labels = weeks.map(weekLabel);

  // Bucket: weekIndex -> playerName -> [lines...]
  const buckets = weeks.map(()=> new Map());

  for (const g of games){
    const d = g.when; if (!d) continue;
    // apply date range filter
    const {start,end} = readDateRange();
    if (start && d < start) continue;
    if (end   && d > end)   continue;

    // which of our last-4 weeks?
    const wIdx = weeks.findIndex(w => d >= w.start && d <= w.end);
    if (wIdx === -1) continue;

    const isFuture = d > now;
    const mark = haMarker(g.ha);
    let tail = '';
    if (g.line && g.line.trim()){
      tail = g.line.trim();
    }else{
      tail = isFuture ? timeIfPresent(g.rawDate) : 'DNP';
    }
    const row = `${fmtMD(d)} ${mark} ${g.opp} - ${tail}`;

    const name = g.name.trim();
    if (!buckets[wIdx].has(name)) buckets[wIdx].set(name, []);
    buckets[wIdx].get(name).push({date:d, txt:row});
  }

  // Sort lines by date desc, players by level->grad->name
  function playerSort(aName, bName){
    const A = rosterByName.get(String(aName).toUpperCase());
    const B = rosterByName.get(String(bName).toUpperCase());
    const levA = levelOrder[String(A?.level||'').toUpperCase()] ?? -1;
    const levB = levelOrder[String(B?.level||'').toUpperCase()] ?? -1;
    if (levA !== levB) return levB - levA;
    const gA = +(A?.grad_class||0), gB = +(B?.grad_class||0);
    if (gA !== gB) return gA - gB;
    return String(aName).localeCompare(String(bName));
  }

  return { weeks, labels, buckets, playerSort };
}

function renderLines(targetEl, games, rosterByName){
  const {labels, buckets, playerSort} = groupLinesByWeeks(games, rosterByName);

  const blocks = labels.map((label, i)=>{
    const map = buckets[i];
    if (!map || map.size===0) return '';
    const players = Array.from(map.keys()).sort(playerSort);
    const playersHTML = players.map(name=>{
      const lines = map.get(name).sort((a,b)=> b.date - a.date);
      const playerTitle = `<div class="player-title">${String(name||'').toUpperCase()}</div>`;
      const list = `<div class="lines-list">${lines.map(x=>`<div class="line-row">${x.txt}</div>`).join('')}</div>`;
      return `<div class="player-block">${playerTitle}${list}</div>`;
    }).join('');
    return `<div class="week-block"><div class="week-head">${label}</div>${playersHTML}</div>`;
  }).filter(Boolean).join('');

  targetEl.innerHTML = blocks || `<p style="opacity:.8">No line scores match the current date range.</p>`;
}

/* -------------------- FILTERS + SEARCH -------------------- */
function populateFilters(players){
  const levels = [...new Set(players.map(p=>p.level).filter(Boolean))]
    .sort((a,b)=>(levelOrder[b?.toUpperCase()]??-1)-(levelOrder[a?.toUpperCase()]??-1));
  $('#filterLevels').innerHTML =
    '<label class="select-all-label"><input type="checkbox" class="select-all"> Select All</label>' +
    levels.map(level=>`<label><input type="checkbox" value="${level}"> ${level}</label>`).join('');

  const gradClasses = [...new Set(players.map(p=>p.grad_class).filter(Boolean))].sort((a,b)=>b-a);
  $('#filterGradClass').innerHTML =
    '<label class="select-all-label"><input type="checkbox" class="select-all"> Select All</label>' +
    gradClasses.map(y=>`<label><input type="checkbox" value="${y}"> ${y}</label>`).join('');

  const rosterYears = [...new Set(players.flatMap(p=>(p.letter_years||'').split(',')).map(y=>y.trim()).filter(Boolean))].sort((a,b)=>b-a);
  $('#filterRosterYear').innerHTML =
    '<label class="select-all-label"><input type="checkbox" class="select-all"> Select All</label>' +
    rosterYears.map(y=>`<label><input type="checkbox" value="${y}"> ${y}</label>`).join('');
}
function readDateRange(){
  const s = $('#dateStart')?.value;
  const e = $('#dateEnd')?.value;
  const start = s ? new Date(s+'T00:00:00') : null;
  const end   = e ? new Date(e+'T23:59:59') : null;
  return {start,end};
}
function setupFilterEvents(apply){
  $('#filters')?.addEventListener('change',e=>{
    if (e.target.classList.contains('select-all')){
      const on = e.target.checked;
      e.target.closest('.filter-options')?.querySelectorAll('input[type="checkbox"]:not(.select-all)').forEach(cb=>cb.checked=on);
    }
    apply();
  });
  $('#filterName')?.addEventListener('input',debounce(apply,250));
  $('#dateStart')?.addEventListener('change',apply);
  $('#dateEnd')?.addEventListener('change',apply);
  $('#filtersReset')?.addEventListener('click',()=>{
    $$('#filters input').forEach(i=>{
      if(i.type==='checkbox') i.checked=false;
      if(i.type==='text' || i.type==='date') i.value='';
    });
    apply();
  });
}

/* Player search (name, team, org, college) */
function makeHit(p){
  const nm=imageKey(p.first,p.last);
  const hsJ=`assets/img/hs_players/${nm}.jpg`, hsP=`assets/img/hs_players/${nm}.png`;
  const el=document.createElement('div'); el.className='live-hit';
  el.innerHTML=`<img src="${hsJ}" onerror="this.onerror=null;this.src='${hsP}';">
                <div><div style="font-weight:700">${p.display_name}</div>
                <div style="opacity:.7;font-size:.92em">${p.team||''} • ${p.org||p.colleges||''}</div></div>`;
  el.onclick=()=>location.href=`profile.html?player=${p.slug || slugify(p.display_name)}`;
  return el;
}
function liveSearch(players){
  const q=($('#playerSearch')?.value||'').toLowerCase().trim();
  const box=$('#liveResults'); if(!box) return;
  if(!q){ box.innerHTML=''; return; }
  const hits = players.filter(p=>{
    const hay = [p.display_name,p.team,p.org,p.colleges].filter(Boolean).join(' ').toLowerCase();
    return hay.includes(q);
  }).slice(0,25);
  box.innerHTML=''; hits.forEach(p=>box.appendChild(makeHit(p)));
}

/* Theme + drawers + auth */
function setupTheme(){
  const themeToggle=$('#theme-toggle'); if(!themeToggle) return;
  const body=document.body, icon=themeToggle.querySelector('i');
  const applyTheme=()=>{
    const saved=localStorage.getItem('theme');
    if (saved==='light'){ body.classList.add('light-theme'); icon?.classList.replace('ri-sun-line','ri-moon-line'); }
    else { body.classList.remove('light-theme'); icon?.classList.replace('ri-moon-line','ri-sun-line'); }
  };
  themeToggle.addEventListener('click', ()=>{
    body.classList.toggle('light-theme');
    localStorage.setItem('theme', body.classList.contains('light-theme') ? 'light' : 'dark');
    applyTheme();
  });
  applyTheme();
}
function closeDrawers(){ document.body.classList.remove('drawer-left-open','drawer-right-open','drawer-open'); }
function setupDrawers(){
  $('#btnMenu')?.addEventListener('click',()=>{ document.body.classList.add('drawer-left-open','drawer-open'); });
  $('#openSearch')?.addEventListener('click',()=>{ document.body.classList.add('drawer-left-open','drawer-open'); });
  $('#openFilters')?.addEventListener('click',()=>{
    $('#drawerFilters').style.display='flex';
    $('#drawerLines').style.display='none';
    document.body.classList.add('drawer-right-open','drawer-open');
  });
  $('#openLinesMobile')?.addEventListener('click',()=>{
    if (window.innerWidth <= 768){
      $('#drawerLines').style.display='flex';
      $('#drawerFilters').style.display='none';
      document.body.classList.add('drawer-right-open','drawer-open');
    } else {
      // desktop: scroll to the right column
      $('#linesDesktop')?.scrollIntoView({behavior:'smooth', block:'start'});
    }
  });
  $$('.close-btn').forEach(b=>b.addEventListener('click',closeDrawers));
  $('.drawer-mask')?.addEventListener('click',closeDrawers);
}

/* -------------------- BOOT -------------------- */
document.addEventListener('DOMContentLoaded', async ()=>{
  try{
    setupTheme();
    setupDrawers();

    // Auth forms (optional; same as index)
    (function setupAuth(){
      if (!window.firebaseAuth) return;
      const { createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } = window.firebaseAuth;
      const auth = window.auth;
      const signOutBtn=$('#btnSignOut');
      $('#btnAccount')?.addEventListener('click',()=>{
        $('#drawerFilters').style.display='none';
        // Reuse account drawer from index if you later add it here.
      });
      document.addEventListener('authStateChanged', ({detail})=>{
        const { user } = detail;
        const accountBtn=$('#btnAccount');
        if (user && !user.isAnonymous){ accountBtn.style.display='none'; signOutBtn.style.display='inline-flex'; }
        else { accountBtn.style.display='inline-flex'; signOutBtn.style.display='none'; }
      });
      signOutBtn?.addEventListener('click', async ()=>{ await signOut(auth); });
    })();

    // Load roster (for sorting / mapping), news, and games
    const { list: roster, byNameUC } = await loadRoster();
    populateFilters(roster);
    $('#playerSearch')?.addEventListener('input', debounce(()=>liveSearch(roster), 200));

    const allNews = await ensureNews();
    const allGames = await loadGames();

    // One apply() pipeline to redraw everything on filter changes
    function apply(){
      // NEWS: we *ignore* the player filters (name/level/etc.) here by default
      renderNews(allNews, byNameUC);

      // LINES: independent of name/level/status filters — we only use the date range
      const desk = $('#linesDesktop'), mob = $('#linesMobile');
      if (desk) renderLines(desk, allGames, byNameUC);
      if (mob)  renderLines(mob,  allGames, byNameUC);
    }
    setupFilterEvents(apply);
    apply();

  }catch(err){
    console.error(err);
    $('#newsPros').innerHTML    = `<p style="color:#f88">Error loading news: ${err.message}</p>`;
    $('#newsCollege').innerHTML = `<p style="color:#f88">Error loading news: ${err.message}</p>`;
    $('#linesDesktop').innerHTML= `<p style="color:#f88">Error loading line scores: ${err.message}</p>`;
  }
});
</script>
</body>
</html>