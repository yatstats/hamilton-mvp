<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Alumni News • Hamilton YATSTATS</title>

<link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Oswald:wght@300;400&family=Bebas+Neue&display=swap" rel="stylesheet">

<style>
:root{
  --bg:#0c0c0c; --fg:#f2f2f2; --muted:#cfd2d6; --ink:#e8e8e8; --line:rgba(255,255,255,.10);
  --card:#171717; --containerPad:16px;
  --hamSmall:13px; --hamBig:20px; --hamBigger:24px;
  --headline: clamp(18px, 2.2vw, 22px);
  --subtle: 12px;
}
*{box-sizing:border-box}
html,body{margin:0}
body{background:var(--bg);color:var(--fg);font-family:Oswald,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
a{color:inherit;text-decoration:none}
.container{max-width:1400px;margin:0 auto;padding:0 var(--containerPad)}
.header{position:sticky;top:0;z-index:50;background:#000}
.topbar{display:flex;align-items:center;justify-content:space-between;padding:8px 0;gap:10px}
.left-icons,.right-icons{display:flex;align-items:center;gap:8px}
.icon-btn{background:none;border:none;color:var(--fg);opacity:.92;display:inline-flex;align-items:center;justify-content:center;padding:6px;border-radius:8px;cursor:pointer}
.icon-btn i{font-size:20px}
.h1{font:400 var(--hamBigger)/1 "Bebas Neue",sans-serif;letter-spacing:.04em}
.hr-y{border-top:1px solid var(--line)}
/* ---------------- GRID ---------------- */
.page-grid{display:grid; grid-template-columns: 1fr; gap:14px; align-items:start}
.week{background:transparent;border-radius:12px;padding:0}
.week-title{font:700 16px/1 "Bebas Neue",sans-serif;letter-spacing:.08em;background:var(--line);border-radius:10px;padding:10px 12px;margin:8px 0}
.week-grid{display:grid; gap:14px}
.col{display:flex;flex-direction:column;gap:10px}
.section-title{font:700 14px "Bebas Neue",sans-serif;letter-spacing:.08em;opacity:.9;margin:2px 0}
.card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:10px;display:flex;gap:12px;align-items:center}
.thumb{flex:0 0 110px; width:110px; aspect-ratio:5/7; border-radius:10px; background:#000 center/cover no-repeat}
.meta{font:300 var(--subtle)/1 Oswald;color:var(--muted)}
.headline{font:700 var(--headline)/1.05 "Bebas Neue",sans-serif;letter-spacing:.02em;margin:.25rem 0 .35rem}
.byline{font:300 12px Oswald;opacity:.85}
.share{margin-left:auto;opacity:.8}
.share:hover{opacity:1}
.empty{opacity:.7;padding:10px}
.lines-card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:10px}
.player-block{border:1px solid var(--line);border-radius:12px;padding:10px;margin-bottom:8px}
.player-name{font:700 16px "Bebas Neue",sans-serif;letter-spacing:.06em;margin-bottom:6px}
.line{padding:6px 8px;border-radius:8px;border:1px solid var(--line);margin:6px 0}
.line .when{display:inline-block;font:700 12px "Bebas Neue",sans-serif;background:rgba(255,255,255,.08);border-radius:14px;padding:3px 8px;margin-right:8px}
.line .text{font:700 18px/1.2 "Bebas Neue",sans-serif;letter-spacing:.02em}
.controls{display:flex;align-items:center;gap:14px}
.controls .datebox{display:flex;gap:6px;align-items:center}
.controls input[type="date"]{background:transparent;color:var(--fg);border:1px solid var(--line);border-radius:8px;padding:6px 8px}
.drawer-mask{position:fixed;inset:0;background:rgba(0,0,0,.35);opacity:0;pointer-events:none;transition:opacity .2s;z-index:60}
.drawer{position:fixed;top:0;bottom:0;right:0;width:min(360px,86vw);background:rgba(10,10,10,.75);backdrop-filter:blur(6px);color:#e8e8e8;transform:translateX(110%);transition:transform .25s;z-index:70;display:flex;flex-direction:column}
body.drawer-open .drawer-mask{opacity:1;pointer-events:auto}
body.drawer-open .drawer{transform:translateX(0)}
.drawer h3{margin:16px}
.drawer-content{flex:1;overflow:auto;padding:0 16px 16px}
.filter-group{border-bottom:1px solid var(--line);padding:12px 0}
.filter-group:last-child{border-bottom:none}
.filter-title{font:700 16px "Bebas Neue",sans-serif;letter-spacing:.08em;margin-bottom:6px}
.filter-options label{display:block;margin:6px 2px}
.select-all{font-weight:700;border-bottom:1px solid var(--line);padding-bottom:8px;margin-bottom:8px}
.drawer-footer{padding:12px 16px;border-top:1px solid var(--line);display:flex;gap:10px}
.btn{padding:10px 12px;border-radius:10px;border:1px solid var(--line);background:transparent;color:var(--fg);cursor:pointer}
.btn.primary{background:var(--fg);color:#000;border-color:var(--fg)}
/* responsive columns:
   ≥1200px: 3 columns (Pro, College, Line scores)
   900–1199px: 2 columns (News, Line scores)
   <900px: 1 column stacked per week (Pro then College then Line scores) */
@media (min-width:1200px){
  .week-grid{grid-template-columns: 1fr 1fr 1fr}
}
@media (min-width:900px) and (max-width:1199.98px){
  .week-grid{grid-template-columns: 2fr 1fr}
  .col-pro,.col-college{grid-column:1}
  .col-lines{grid-column:2; grid-row:1 / span 2}
}
@media (max-width:899.98px){
  .thumb{width:96px}
  .headline{font-size: clamp(17px, 5vw, 20px)}
}
/* accessibility */
.icon-btn:focus, .btn:focus, input[type="date"]:focus { outline:2px solid var(--fg); outline-offset: 2px; }
</style>
</head>

<body>
<header class="header">
  <div class="container topbar">
    <div class="left-icons">
      <button id="btnMenu" class="icon-btn" aria-label="Menu"><i class="ri-menu-line"></i></button>
      <div class="h1">ALUMNI NEWS</div>
    </div>
    <div class="controls">
      <div class="datebox">
        <label style="font-size:12px;opacity:.85">From</label>
        <input id="dateFrom" type="date">
      </div>
      <div class="datebox">
        <label style="font-size:12px;opacity:.85">To</label>
        <input id="dateTo" type="date">
      </div>
      <button id="btnRefresh" class="icon-btn" title="Refresh"><i class="ri-refresh-line"></i>&nbsp;Refresh</button>
      <button id="btnFilters" class="icon-btn" title="Filters"><i class="ri-filter-3-line"></i></button>
    </div>
  </div>
  <div class="hr-y"></div>
</header>

<main class="container" style="padding:10px 0 80px">
  <div id="page" class="page-grid" aria-live="polite">
    <p style="opacity:.75">Loading headlines…</p>
  </div>
</main>

<div class="drawer-mask"></div>
<aside class="drawer" id="drawer">
  <h3>Filters</h3>
  <div class="drawer-content" id="filters">
    <div class="filter-group">
      <div class="filter-title">By Name</div>
      <input id="filterName" placeholder="Type a player…" style="width:100%;padding:10px;border-radius:10px;border:1px solid var(--line);background:rgba(255,255,255,.06);color:var(--ink)">
    </div>
    <div class="filter-group">
      <div class="filter-title">By Status</div>
      <div class="filter-options" id="filterStatus"></div>
    </div>
    <div class="filter-group">
      <div class="filter-title">By Level</div>
      <div class="filter-options" id="filterLevels"></div>
    </div>
    <div class="filter-group">
      <div class="filter-title">By Graduating Class</div>
      <div class="filter-options" id="filterGrad"></div>
    </div>
  </div>
  <div class="drawer-footer">
    <button id="btnReset" class="btn">Reset</button>
    <button id="btnDone" class="btn primary">Done</button>
  </div>
</aside>

<script type="module">
/* ---------------- CONFIG ---------------- */
const CSV_URL  = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQcWJM6Q6hTdFnES_G5LUy4teCS-sJ5HdAc9F5HSY8DGE9egdGy8yUAe2ShT3tFm-CwUuCYeAYy_YiW/pub?gid=2028135390&single=true&output=csv";
const NEWS_JSON_URL = "assets/news/alumni_news.json";
const CACHE_KEY = "YAT_NEWS_CACHE_V1";

const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));

/* ---------------- DATA LOADERS ---------------- */
async function loadCSV(url){
  const res = await fetch(url, {cache:'no-cache'}); if(!res.ok) throw new Error('CSV '+res.status);
  const text = await res.text();
  const rows = text.trim().split(/\r?\n/).map(l=>l.split(/,(?=(?:[^"]*"[^"]*")*[^"]*$)/).map(c=>c.replace(/^"|"$/g,'')));
  const header = rows.shift().map(h=>h.trim()); const idx=n=>header.indexOf(n);
  const statKeys = ['avg','obp','slg','ops','ab','h','r','rbi','2b','3b','hr','sb','bb','era','k/9','k/bb','whip','ip','er','ko','gp','w-l','saves','fip'];

  return rows.map(r=>{
    const p = {
      slug:r[idx('slug')], display_name:r[idx('display_name')],
      first:r[idx('first')], last:r[idx('last')],
      grad_class:r[idx('grad_class')], letter_years:r[idx('letter_years')],
      status:r[idx('status')], level:r[idx('level')], team:r[idx('team')], org:r[idx('org')],
      last_game_1:r[idx('last_game_1')], last_game_2:r[idx('last_game_2')], last_game_3:r[idx('last_game_3')],
      stats:{}
    };
    for(const k of statKeys){ const i=idx(k); if(i>-1 && r[i]) p.stats[k.toUpperCase()] = r[i]; }
    return p;
  });
}

function getCache(){
  try{ return JSON.parse(localStorage.getItem(CACHE_KEY)||'{}'); }catch{ return {}; }
}
function setCache(items){
  localStorage.setItem(CACHE_KEY, JSON.stringify({updatedAt:new Date().toISOString(), items}));
}
async function ensureNewsCache(){
  const c = getCache();
  if (Array.isArray(c.items) && c.items.length) return c;
  try{
    const res = await fetch(NEWS_JSON_URL, {cache:'no-store'}); if(!res.ok) throw new Error('JSON '+res.status);
    const arr = await res.json();
    setCache(Array.isArray(arr)?arr:[]);
  }catch(e){ console.warn('Failed to seed cache:', e); setCache([]); }
  return getCache();
}

/* ---------------- HELPERS ---------------- */
const proLevels = new Set(['MLB','INTERNATIONAL','TRIPLE-A','AAA','DOUBLE-A','AA','HIGH-A','A+','LOW-A','A','ROOKIE','ROK','INDY']);
const collegeLevels = new Set(['NCAA-D1','NCAA-D2','NCAA-D3','NAIA','JUCO']);

function toDate(d){ const t = new Date(d); return isNaN(+t)? null : t; }
function fmtWeek(date){
  const d = new Date(date); // 0 Sun..6 Sat
  const day = d.getDay();
  const sunday = new Date(d); sunday.setDate(d.getDate()-day);
  return new Date(sunday.getFullYear(), sunday.getMonth(), sunday.getDate()); // 00:00 Sun
}
function fmtWeekTitle(d){
  const opts = {month:'long', day:'numeric', year:'numeric'};
  return `Week of ${d.toLocaleDateString(undefined, opts)}`;
}
function parseLine(line, fallbackYear = (new Date()).getFullYear()){
  if(!line) return null;
  // formats like "9/14 @ BOS - 0-4 | 2K" or "9/14 vs.SAC - 1IP, 1H..."
  const m = String(line).match(/^(\d{1,2})\/(\d{1,2})\s+(.*)$/);
  if(!m) return null;
  const mm = +m[1], dd = +m[2];
  const date = new Date(fallbackYear, mm-1, dd);
  // remove the long dash: " — " or " - "
  const rest = m[3].replace(/\s—\s|\s-\s/g,' ').trim();
  return { date, text: rest };
}
function slugOf(p){
  const s=(p.slug||'').trim(); if(s) return s;
  return String(p.display_name||'').trim().toLowerCase().replace(/[^a-z0-9]+/g,'-');
}

/* ---------------- FILTER UI ---------------- */
function buildFilterOptions(players){
  // Status
  const statuses = [...new Set(players.map(p=>p.status).filter(Boolean))].sort();
  $('#filterStatus').innerHTML =
    `<label class="select-all"><input type="checkbox" data-sel="status"> Select All</label>` +
    statuses.map(s=>`<label><input type="checkbox" name="status" value="${s}"> ${s}</label>`).join('');

  // Levels
  const levels = [...new Set(players.map(p=>p.level).filter(Boolean))].sort();
  $('#filterLevels').innerHTML =
    `<label class="select-all"><input type="checkbox" data-sel="level"> Select All</label>` +
    levels.map(l=>`<label><input type="checkbox" name="level" value="${l}"> ${l}</label>`).join('');

  // Grad class
  const grads = [...new Set(players.map(p=>p.grad_class).filter(Boolean))].sort((a,b)=>b-a);
  $('#filterGrad').innerHTML =
    `<label class="select-all"><input type="checkbox" data-sel="grad"> Select All</label>` +
    grads.map(y=>`<label><input type="checkbox" name="grad" value="${y}"> ${y}</label>`).join('');

  // Select-all behaviour
  $('#filters').addEventListener('change', (e)=>{
    const t = e.target;
    if (t.matches('[data-sel="status"]')){
      $$('input[name="status"]').forEach(cb=>cb.checked = t.checked);
      render();
    }else if (t.matches('[data-sel="level"]')){
      $$('input[name="level"]').forEach(cb=>cb.checked = t.checked);
      render();
    }else if (t.matches('[data-sel="grad"]')){
      $$('input[name="grad"]').forEach(cb=>cb.checked = t.checked);
      render();
    }else if (t.matches('input[name="status"], input[name="level"], input[name="grad"]')){
      render();
    }
  });
  $('#filterName').addEventListener('input', ()=>render());
}
function readFilterState(){
  const name = ($('#filterName').value||'').trim().toLowerCase();
  const levels = $$('input[name="level"]:checked').map(i=>i.value);
  const status = $$('input[name="status"]:checked').map(i=>i.value);
  const grads  = $$('input[name="grad"]:checked').map(i=>i.value);
  // date range
  const dFrom = $('#dateFrom').value ? new Date($('#dateFrom').value) : null;
  const dTo   = $('#dateTo').value ? new Date($('#dateTo').value) : null;
  if (dTo) dTo.setHours(23,59,59,999);
  return { name, levels, status, grads, dFrom, dTo };
}

/* ---------------- RENDER ---------------- */
let PLAYERS = [];
let NEWS = [];

function filterByPlayerTags(p, f){
  if (f.name && !String(p.display_name||'').toLowerCase().includes(f.name)) return false;
  if (f.levels.length && !f.levels.includes(p.level)) return false;
  if (f.status.length && !f.status.includes(p.status)) return false;
  if (f.grads.length  && !f.grads.includes(p.grad_class)) return false;
  return true;
}

function render(){
  const page = $('#page');
  if (!PLAYERS.length) { page.innerHTML = '<p class="empty">No data.</p>'; return; }

  const f = readFilterState();

  // Build a quick name→player map
  const byName = new Map(PLAYERS.map(p=>[String(p.display_name||'').toLowerCase(), p]));

  // Filter news & split Pro/College
  const enriched = NEWS.map(n=>{
    const p = byName.get(String(n.player_display_name||'').toLowerCase()) || {};
    const when = toDate(n.publishedAt);
    return {...n, _when: when, _player: p};
  }).filter(n=> n._when);

  // date range
  const inRange = enriched.filter(n=>{
    if (f.dFrom && n._when < f.dFrom) return false;
    if (f.dTo   && n._when > f.dTo)   return false;
    return true;
  }).filter(n=> filterByPlayerTags(n._player, f));

  const proNews = inRange.filter(n=> proLevels.has((n._player.level||'').toUpperCase()));
  const colNews = inRange.filter(n=> collegeLevels.has((n._player.level||'').toUpperCase()));

  // Line scores from last_game_1..3 (we'll parse date at start of the string)
  const linesRaw = [];
  PLAYERS.forEach(p=>{
    if (!filterByPlayerTags(p, f)) return;
    [p.last_game_1, p.last_game_2, p.last_game_3].forEach(s=>{
      const parsed = parseLine(s);
      if (parsed){
        // apply date range
        if (f.dFrom && parsed.date < f.dFrom) return;
        if (f.dTo   && parsed.date > f.dTo) return;
        linesRaw.push({ player: p, date: parsed.date, text: parsed.text });
      }
    });
  });
  // group by week then by player
  const byWeekNews = new Map(); // weekStart (Date ISO) => {pro:[], college:[], linesByPlayer: Map}
  function bucketFor(date){
    const start = fmtWeek(date); const key = start.toISOString().slice(0,10);
    if (!byWeekNews.has(key)){
      byWeekNews.set(key, { start, pro:[], college:[], linesByPlayer: new Map() });
    }
    return byWeekNews.get(key);
  }

  proNews.forEach(n => bucketFor(n._when).pro.push(n));
  colNews.forEach(n => bucketFor(n._when).college.push(n));
  linesRaw.forEach(row=>{
    const b = bucketFor(row.date);
    const k = String(row.player.display_name||'');
    if (!b.linesByPlayer.has(k)) b.linesByPlayer.set(k, { player: row.player, rows: [] });
    b.linesByPlayer.get(k).rows.push(row);
  });

  // Sort inside buckets
  for (const b of byWeekNews.values()){
    b.pro.sort((a,b)=> b._when - a._when);
    b.college.sort((a,b)=> b._when - a._when);
    // sort each player's lines newest→oldest
    for (const g of b.linesByPlayer.values()){ g.rows.sort((a,b)=> b.date - a.date); }
    // order player groups by most-recent line within the week
    b.linesGrouped = Array.from(b.linesByPlayer.values())
      .sort((A,B)=> (B.rows[0]?.date||0) - (A.rows[0]?.date||0));
  }

  // Sort weeks newest→oldest
  const weeks = Array.from(byWeekNews.values())
    .sort((a,b)=> b.start - a.start);

  // build DOM
  if (!weeks.length){
    page.innerHTML = '<p class="empty">No headlines match the filters.</p>';
    return;
  }

  page.innerHTML = weeks.map(week=>{
    const titlePro = `ALUMNI HEADLINES (Pros) – ${fmtWeekTitle(week.start)}`;
    const titleCol = `ALUMNI HEADLINES (College) – ${fmtWeekTitle(week.start)}`;
    const titleLn  = `ALUMNI LINE SCORES – ${fmtWeekTitle(week.start)}`;

    const proHTML = (week.pro.length? week.pro.map(cardHTML).join(''): `<div class="empty">No pro headlines this week.</div>`);
    const colHTML = (week.college.length? week.college.map(cardHTML).join(''): `<div class="empty">No college headlines this week.</div>`);
    const linesHTML = (week.linesGrouped.length? week.linesGrouped.map(groupHTML).join(''): `<div class="empty">No line scores this week.</div>`);

    return `
      <section class="week">
        <div class="week-grid">
          <div class="col col-pro">
            <div class="week-title">${titlePro}</div>
            ${proHTML}
          </div>
          <div class="col col-college">
            <div class="week-title">${titleCol}</div>
            ${colHTML}
          </div>
          <div class="col col-lines">
            <div class="week-title">${titleLn}</div>
            <div class="lines-card">
              ${linesHTML}
            </div>
          </div>
        </div>
      </section>`;
  }).join('');
}

function cardHTML(n){
  const img = n.image || `https://picsum.photos/seed/${encodeURIComponent(n.id||n.title||'news')}/500/700`;
  const when = n._when ? n._when.toLocaleString() : '';
  const url = (n.url||'#') + ((n.url||'').includes('?')?'&':'?') + 'utm_source=yatstats&utm_medium=newspage';
  const who = n.player_display_name || '';
  return `
    <article class="card">
      <div class="thumb" style="background-image:url('${img}')"></div>
      <div style="min-width:0">
        <div class="meta">${n.source||'News'} • ${when}</div>
        <div class="headline">${n.title||'Read more'}</div>
        <div class="byline">${who}</div>
      </div>
      <a class="share" href="${url}" target="_blank" rel="noopener" title="Open">
        <i class="ri-external-link-line"></i>
      </a>
    </article>`;
}
function groupHTML(g){
  const rows = g.rows.map(r=>{
    const label = r.date.toLocaleDateString(undefined,{month:'numeric',day:'numeric'});
    return `<div class="line"><span class="when">${label}</span><span class="text">${r.text}</span></div>`;
  }).join('');
  return `<div class="player-block">
    <div class="player-name">${g.player.display_name}</div>
    ${rows}
  </div>`;
}

/* ---------------- BOOT ---------------- */
function setDefaultDates(){
  const to = new Date();
  const from = new Date(); from.setDate(to.getDate()-21);
  $('#dateFrom').value = from.toISOString().slice(0,10);
  $('#dateTo').value   = to.toISOString().slice(0,10);
}
$('#btnMenu').addEventListener('click', ()=> document.body.classList.add('drawer-open'));
$('.drawer-mask').addEventListener('click', ()=> document.body.classList.remove('drawer-open'));
$('#btnDone').addEventListener('click', ()=> document.body.classList.remove('drawer-open'));
$('#btnReset').addEventListener('click', ()=>{
  $('#filterName').value = '';
  $$('input[name="status"],input[name="level"],input[name="grad"]').forEach(cb=> cb.checked=false);
  setDefaultDates();
  render();
});
$('#btnFilters').addEventListener('click', ()=> document.body.classList.add('drawer-open'));
$('#btnRefresh').addEventListener('click', async ()=>{
  // force reseed
  try{
    const res=await fetch(NEWS_JSON_URL,{cache:'no-store'}); const arr=await res.json();
    setCache(Array.isArray(arr)?arr:[]);
  }catch{ setCache([]); }
  await boot(); // reload
});

$('#dateFrom').addEventListener('change', ()=>render());
$('#dateTo').addEventListener('change', ()=>render());

async function boot(){
  setDefaultDates();
  const [players] = await Promise.all([ loadCSV(CSV_URL) ]);
  PLAYERS = players;

  buildFilterOptions(players);

  const cache = await ensureNewsCache();
  NEWS = Array.isArray(cache.items)? cache.items : [];

  render();
}

boot().catch(err=>{
  console.error(err);
  $('#page').innerHTML = `<p style="color:#f88">Failed to load page: ${err.message}</p>`;
});
</script>
</body>
</html>