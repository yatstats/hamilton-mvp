<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Active Alumni News â€¢ Hamilton YATSTATS</title>
<link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Oswald:wght@300;400&family=Bebas+Neue&display=swap" rel="stylesheet">

<!-- Firebase init (same as index.html) -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, signInWithCustomToken, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
  window.firebaseAuth = { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, signInWithCustomToken, signInAnonymously };
  try {
    const firebaseConfig = JSON.parse(window.__firebase_config || '{}');
    const app = initializeApp(firebaseConfig);
    window.auth = getAuth(app);
    onAuthStateChanged(window.auth, user => { document.dispatchEvent(new CustomEvent('authStateChanged', { detail: { user } })); });
    if (window.__initial_auth_token) {
      await signInWithCustomToken(window.auth, window.__initial_auth_token);
    } else {
      await signInAnonymously(window.auth);
    }
  } catch (e) {
    console.error("Firebase initialization error:", e);
  }
</script>

<style>
/* ===== GLOBAL (copied from index.html for parity) ===== */
:root{
  --bg:#0c0c0c; --fg:#f2f2f2; --muted:#c4c4c4; --ink:#e8e8e8; --line:rgba(255,255,255,.08);
  --card-bg:#171717; --header-bg:#000; --drawer-bg:rgba(10,10,10,.65);
  --shade-end:rgba(0,0,0,.95);
  --hamSmall:13px; --hamBig:20px; --hamBigger:24px; --tagGrey:#cfd2d6;
  --crestH:clamp(28px,4.2vw,42px);
  --containerPad:16px; --footerH:clamp(56px,8vh,77px);
}
body.light-theme{
  --bg:#f4f4f4; --fg:#121212; --muted:#555; --ink:#222; --line:rgba(0,0,0,.1);
  --card-bg:#fff; --header-bg:#fff; --drawer-bg:rgba(255,255,255,.65);
}
@font-face{font-family:'Indigo';src:url('assets/fonts/Indigo.otf') format('opentype');font-weight:400;font-style:normal;font-display:swap;}
*{box-sizing:border-box} html,body{margin:0}
body{background:var(--bg);color:var(--fg);font-family:Oswald,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;transition:background-color .3s,color .3s;}
body.drawer-open{overflow:hidden}
a{color:inherit;text-decoration:none}

.container{max-width:1400px;margin:0 auto;padding:0 var(--containerPad)}
.header{position:sticky;top:0;z-index:50;background:var(--header-bg);transition:background-color .3s;}
.topbar{display:flex;align-items:center;justify-content:space-between;padding:8px 0}
.left-icons{display:flex;align-items:center;gap:8px}
.icon-btn{background:none;border:none;color:var(--fg);opacity:.92;display:inline-flex;align-items:center;justify-content:center;padding:0;margin:0 2px;cursor:pointer}
.icon-btn i{font-size:20px}
.topnav{display:flex;gap:18px;align-items:center}
.nav-pair{white-space:nowrap}
.nav-pair .thin{font:300 var(--hamSmall) Oswald,sans-serif;letter-spacing:.02em;color:#cfd2d6;margin-right:2px}
body.light-theme .nav-pair .thin{color:var(--muted)}
.nav-pair .bold{font:400 var(--hamSmall) Indigo,"Bebas Neue",sans-serif}
.wordmark-wrap{display:flex;align-items:center;justify-content:flex-end;min-width:120px}
.wordmark-img{height:clamp(18px,3.2vw,28px);width:auto;display:block}
body.light-theme .wordmark-img{filter:invert(1)}
@media (max-width:1200px){.topnav{display:none !important}}
.hr-y{border-top:1px solid var(--line)}
.schoolrow{display:flex;align-items:center;gap:10px;padding:6px var(--containerPad)}
.ham-logo{height:var(--crestH);width:auto;object-fit:contain;display:block;flex-shrink:0}
.schooltext{line-height:1}
.schooltext .small{font:300 var(--hamSmall)/1 Oswald;letter-spacing:.02em;color:var(--muted)}
.schooltext .big1{font:400 var(--hamBig)/1 "Bebas Neue",sans-serif}
.schooltext .big2{font:400 var(--hamBigger)/1 "Bebas Neue",sans-serif;margin-top:-4px}
.crumbs{font:300 calc(var(--hamSmall)*.5)/1 Oswald;letter-spacing:.02em;color:var(--muted);text-transform:uppercase}
.hero{padding:2px 0}
.hero-grid{display:flex;align-items:center;justify-content:space-between;gap:16px}
.hero-left{display:flex;flex-direction:column;gap:4px}
.hero-crumbs{margin:0;text-align:left;white-space:nowrap}
@media (max-width:768px){.topbar .crumbs{display:block}.hero-left .crumbs{display:none}}
@media (min-width:769px){.topbar .crumbs{display:none}.hero-left .crumbs{display:block}}
.tag-duo{position:relative;height:1.8em}
.tag-swap{position:absolute;left:0;top:0;right:0;opacity:0;animation:swap 6s infinite;white-space:nowrap}
.tag-swap:nth-child(1){animation-delay:0s}
.tag-swap:nth-child(2){animation-delay:3s}
.tag-grey{font:300 1em Oswald,sans-serif;letter-spacing:.02em;color:var(--tagGrey)}
body.light-theme .tag-grey{color:var(--muted)}
.tag-bold{font:400 1em Indigo,"Bebas Neue",sans-serif}
@keyframes swap{0%{opacity:0}5%{opacity:1}45%{opacity:1}50%{opacity:0}100%{opacity:0}}
.hero-right{display:flex;gap:10px}
.hero-icon i{font-size:20px}

/* Drawers */
.drawer-mask{position:fixed;inset:0;background:rgba(0,0,0,.35);opacity:0;pointer-events:none;transition:opacity .2s;z-index:60}
.drawer{position:fixed;top:0;bottom:0;width:min(360px,82vw);background:var(--drawer-bg);backdrop-filter:blur(4px);color:var(--ink);transform:translateX(-110%);transition:transform .25s,background-color .3s;z-index:70}
.drawer-right{right:0;left:auto;transform:translateX(110%);display:flex;flex-direction:column;height:100%}
.drawer h3{margin:18px 16px 8px;padding-right:30px}
.drawer .pad{padding:10px 16px}
.drawer .close-btn{position:absolute;top:12px;right:12px}
.drawer a{color:var(--ink)}
.drawer a:hover{color:var(--fg)}
body.drawer-left-open .drawer-mask,body.drawer-right-open .drawer-mask{opacity:1;pointer-events:auto}
body.drawer-left-open #drawerLeft{transform:translateX(0)}
body.drawer-right-open .drawer-right{transform:translateX(0)}
.drawer-content{flex-grow:1;overflow-y:auto;padding:10px 16px}
.drawer-footer{flex-shrink:0;padding:12px 16px;border-top:1px solid var(--line);background:rgba(10,10,10,.8);display:flex;gap:10px;align-items:center}
body.light-theme .drawer-footer{background:rgba(255,255,255,.8)}
.filter-group{border-bottom:1px solid var(--line)}
.filter-group:last-of-type{border-bottom:none}
.filter-title{padding:14px 0;cursor:pointer;font-weight:700;font-family:"Bebas Neue",sans-serif;letter-spacing:.05em;list-style:none;display:flex;justify-content:space-between;align-items:center}
.filter-title::-webkit-details-marker{display:none}
.filter-title::after{content:'â–¸';font-size:1.2em;transition:transform .2s}
details[open]>.filter-title::after{transform:rotate(90deg)}
.filter-options{padding:4px 0 16px 0}
.filter-options label{display:block;margin-bottom:8px;padding-left:4px}
.filter-options input[type=checkbox]{margin-right:8px;transform:scale(1.1)}
.select-all-label{font-weight:700;border-bottom:1px solid var(--line);padding-bottom:8px !important;margin-bottom:12px !important}
#liveResults{margin:10px 4px 18px;max-height:55vh;overflow:auto}
.live-hit{padding:10px 12px;display:flex;align-items:center;gap:10px;border-radius:10px;cursor:pointer}
.live-hit:hover{background:var(--line)}
.live-hit img{width:36px;height:36px;border-radius:6px;object-fit:cover}

/* Footer */
.site-footer{position:fixed;left:0;right:0;bottom:0;height:var(--footerH);background:var(--bg);border-top:1px solid var(--line);z-index:40}
.site-footer a{display:block;height:100%;width:100%}
.site-footer img{height:100%;width:100%;object-fit:contain}

/* ===== PAGE-SPECIFIC ===== */
.main{padding:8px 0 calc(var(--footerH) + 12px)}
.content-grid{display:grid;grid-template-columns:2fr 1fr;gap:14px}
@media (max-width:1100px){.content-grid{grid-template-columns:1.7fr 1fr}}
@media (max-width:768px){.content-grid{grid-template-columns:1fr}}
.section-card{background:var(--card-bg);border-radius:10px;box-shadow:0 4px 8px rgba(0,0,0,.2);padding:10px}
.section-title{font:700 18px "Bebas Neue",sans-serif;letter-spacing:.05em;background:var(--line);padding:10px;border-radius:8px;margin-bottom:8px}
.section-title.big{font-size:22px}

/* NEWS cards */
.news-list{display:flex;flex-direction:column;gap:10px}
.news-card{display:flex;gap:12px;padding:10px;border:1px solid var(--line);border-radius:12px;align-items:center}
.news-thumb{width:110px;aspect-ratio:5/7;border-radius:10px;background:#000 center/cover no-repeat;flex:0 0 110px}
.news-body{flex:1;min-width:0}
.news-title{font:700 18px "Bebas Neue",sans-serif;letter-spacing:.03em;line-height:1.1;margin-bottom:6px}
.news-meta{font:300 12px Oswald, sans-serif;opacity:.8;margin-bottom:4px}
.news-player{font:400 14px Oswald, sans-serif;opacity:.9}
.news-actions{display:flex;gap:10px;align-items:center;margin-top:6px}
.news-actions a{opacity:.85}
.news-actions a:hover{opacity:1}

/* LINE SCORES (independent scroll, sticky) */
.linescores-wrap{position:sticky;top:120px;max-height:calc(100vh - 160px);overflow:auto;border-radius:10px}
.week-group{padding:10px 8px 2px}
.player-block{padding:6px 2px 10px}
.player-name{font:700 20px "Bebas Neue",sans-serif;letter-spacing:.04em;margin:8px 0 4px}
.player-lines{font:400 14px Oswald, sans-serif;line-height:1.35}  /* same size/weight as news player line */

/* MOBILE drawer for line scores */
#drawerLineScores{background:rgba(15,15,15,.75)}
#drawerLineScores .drawer-content{padding-top:4px}
#drawerLineScores .section-title{margin:8px 8px 6px}
@media (min-width:769px){#openLineScores{display:none}}
</style>
</head>

<body>
<!-- Splash (optional) -->
<div id="splashScreen" style="display:none"></div>

<header class="header">
  <div class="container topbar">
    <div class="left-icons">
      <button class="icon-btn" id="btnMenu" aria-label="Menu"><i class="ri-menu-line"></i></button>
      <div id="auth-container">
        <button class="icon-btn" id="btnAccount" aria-label="Account"><i class="ri-user-3-line"></i></button>
        <button class="icon-btn" id="btnSignOut" style="display:none;"><i class="ri-logout-box-line"></i></button>
      </div>
      <button class="icon-btn" id="theme-toggle" aria-label="Toggle Theme"><i class="ri-sun-line"></i></button>
    </div>
    <nav class="topnav" aria-label="Top Navigation">
      <a href="index.html" class="nav-pair"><span class="thin">WHERE THEY</span><span class="bold">YAT?</span></a>
      <a href="alumni-news.html" class="nav-pair"><span class="thin">ACTIVE ALUMNI</span><span class="bold">NEWS</span></a>
      <a href="all-time-list.html" class="nav-pair"><span class="thin">NEXT-LEVEL</span><span class="bold">ALL-TIME LIST</span></a>
      <a href="marketplace.html" class="nav-pair"><span class="thin">NIL & YAT-A-BOY</span><span class="bold">MARKETPLACE</span></a>
      <a href="current-team.html" class="nav-pair"><span class="thin">THE</span><span class="bold">CURRENT TEAM</span></a>
      <a href="partner-program.html" class="nav-pair"><span class="thin">PCD ACTION</span><span class="bold">PARTNER PROGRAM</span></a>
      <a href="faq.html" class="nav-pair"><span class="bold">FAQâ€™S</span></a>
    </nav>
    <div class="wordmark-wrap">
      <img class="wordmark-img" src="assets/img/yatstats-logo.png" alt="YAT?STATS">
    </div>
  </div>
  <div class="hr-y"></div>
  <div class="container schoolrow">
    <img id="hamLogo" class="ham-logo" src="assets/img/hamilton-logo.png" alt="Hamilton H">
    <div class="schooltext">
      <div class="small">CHANDLER, AZ</div>
      <div class="big1">HAMILTON HIGH SCHOOL</div>
      <div class="big2">ACTIVE BASEBALL ALUMNI</div>
    </div>
  </div>
  <div class="hr-y"></div>
  <section class="hero">
    <div class="container hero-grid">
      <div class="hero-left" aria-live="polite">
        <div class="tag-duo">
          <div class="tag-swap"><span class="tag-grey">ACTIVE ALUMNI</span> <span class="tag-bold">NEWS</span></div>
          <div class="tag-swap"><span class="tag-grey">WEEKLY</span> <span class="tag-bold">LINE SCORES</span></div>
        </div>
        <div class="crumbs hero-crumbs">HAMILTON â–¸ ACTIVE ALUMNI NEWS</div>
      </div>
      <div class="hero-right">
        <button id="openSearch" class="hero-icon icon-btn" aria-label="Open search"><i class="ri-search-line"></i></button>
        <button id="openFilters" class="hero-icon icon-btn" aria-label="Open filters"><i class="ri-filter-3-line"></i></button>
        <button id="openLineScores" class="hero-icon icon-btn" aria-label="Open weekly line scores"><i class="ri-list-unordered"></i></button>
        <button id="filtersReset2" class="hero-icon icon-btn" aria-label="Reset"><i class="ri-restart-line"></i></button>
      </div>
    </div>
  </section>
</header>

<div class="drawer-mask"></div>

<!-- Left: search + nav -->
<aside class="drawer" id="drawerLeft" aria-label="Left drawer">
  <button class="icon-btn close-btn"><i class="ri-close-line"></i></button>
  <div class="drawer-content">
    <h3>PLAYER PROFILE SEARCH</h3>
    <div class="pad">
      <input id="playerSearch" placeholder="Type to searchâ€¦" style="width:100%;padding:10px;border-radius:10px;border:1px solid var(--line);background:rgba(255,255,255,.06);color:var(--ink)">
      <div id="liveResults"></div>
    </div>
    <h3>NAVIGATION</h3>
    <div class="pad" style="display:flex;flex-direction:column;gap:12px">
      <a href="index.html" class="nav-pair"><span class="thin">WHERE THEY</span><span class="bold">YAT?</span></a>
      <a href="alumni-news.html" class="nav-pair"><span class="thin">ACTIVE ALUMNI</span><span class="bold">NEWS</span></a>
      <a href="all-time-list.html" class="nav-pair"><span class="thin">NEXT-LEVEL</span><span class="bold">ALL-TIME LIST</span></a>
      <a href="marketplace.html" class="nav-pair"><span class="thin">NIL & YAT-A-BOY</span><span class="bold">MARKETPLACE</span></a>
      <a href="current-team.html" class="nav-pair"><span class="thin">THE</span><span class="bold">CURRENT TEAM</span></a>
      <a href="partner-program.html" class="nav-pair"><span class="thin">PCD ACTION</span><span class="bold">PARTNER PROGRAM</span></a>
      <a href="faq.html" class="nav-pair"><span class="bold">FAQâ€™S</span></a>
    </div>
  </div>
</aside>

<!-- Right: filters (date range moved here) -->
<aside class="drawer drawer-right" id="drawerFilters" style="display:flex;">
  <button class="icon-btn close-btn"><i class="ri-close-line"></i></button>
  <h3>FILTERS</h3>
  <div class="drawer-content" id="filters">
    <details class="filter-group" open>
      <summary class="filter-title">By Name</summary>
      <div class="filter-options">
        <input id="filterName" placeholder="Type a nameâ€¦" style="width:100%;padding:10px;border-radius:10px;border:1px solid var(--line);background:rgba(255,255,255,.06);color:var(--ink)"/>
      </div>
    </details>
    <details class="filter-group">
      <summary class="filter-title">By Status</summary>
      <div class="filter-options" id="filterStatus">
        <label class="select-all-label"><input type="checkbox" class="select-all"> Select All</label>
        <label><input type="checkbox" value="ACTIVE 2025"> ACTIVE 2025</label>
        <label><input type="checkbox" value="ACTIVE 2024"> ACTIVE 2024</label>
        <label><input type="checkbox" value="FREE AGENT"> FREE AGENT</label>
        <label><input type="checkbox" value="INJURED"> INJURED</label>
        <label><input type="checkbox" value="RETIRED"> RETIRED</label>
        <label><input type="checkbox" value="SPONSOR"> SPONSOR</label>
      </div>
    </details>
    <details class="filter-group">
      <summary class="filter-title">By Level</summary>
      <div class="filter-options" id="filterLevels">
        <label class="select-all-label"><input type="checkbox" class="select-all"> Select All</label>
      </div>
    </details>
    <details class="filter-group">
      <summary class="filter-title">By Graduating Class</summary>
      <div class="filter-options" id="filterGradClass"></div>
    </details>
    <details class="filter-group">
      <summary class="filter-title">By Roster Year</summary>
      <div class="filter-options" id="filterRosterYear"></div>
    </details>
    <details class="filter-group">
      <summary class="filter-title">By Date Range (News Only)</summary>
      <div class="filter-options">
        <label>From<br><input type="date" id="filterFrom" style="width:100%;padding:10px;border-radius:10px;border:1px solid var(--line);background:rgba(255,255,255,.06);color:var(--ink)"></label>
        <label>To<br><input type="date" id="filterTo" style="width:100%;padding:10px;border-radius:10px;border:1px solid var(--line);background:rgba(255,255,255,.06);color:var(--ink)"></label>
      </div>
    </details>
  </div>
  <div class="drawer-footer">
    <button id="filtersReset" class="icon-btn" style="padding:10px 14px;border:1px solid var(--line);border-radius:12px"><i class="ri-restart-line"></i>&nbsp;Reset Filters</button>
  </div>
</aside>

<!-- Right: Line Scores (mobile drawer) -->
<aside class="drawer drawer-right" id="drawerLineScores" style="display:flex;">
  <button class="icon-btn close-btn"><i class="ri-close-line"></i></button>
  <h3>WEEKLY LINE SCORES</h3>
  <div class="drawer-content" id="lsDrawerBody">
    <!-- injected on load -->
  </div>
</aside>

<main class="main container">
  <div class="content-grid">
    <!-- NEWS -->
    <section class="section-card" aria-label="Active Alumni News">
      <div class="section-title big">ACTIVE ALUMNI NEWS</div>
      <div id="colNews" class="news-list" aria-live="polite">
        <p style="color:var(--muted)">Loading headlinesâ€¦</p>
      </div>
    </section>

    <!-- WEEKLY LINE SCORES (sticky on desktop/tablet) -->
    <section class="section-card">
      <div class="section-title big">WEEKLY LINE SCORES</div>
      <div class="linescores-wrap" id="colLineScores">
        <p style="color:var(--muted);padding:8px">Loading weekly line scoresâ€¦</p>
      </div>
    </section>
  </div>
</main>

<footer class="site-footer">
  <a href="https://no-errors.com/collections/all-webgems" target="_blank" rel="noopener noreferrer">
    <img src="assets/img/partners/no-errors-banner.jpg" alt="Sponsor Banner">
  </a>
</footer>

<!-- ===== APP SCRIPT ===== -->
<script type="module">
/* ---- YATSTATS â€¢ alumni-news â€¢ build 5.1.0 ---- */

/* DATA SOURCES */
const ROSTER_CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQcWJM6Q6hTdFnES_G5LUy4teCS-sJ5HdAc9F5HSY8DGE9egdGy8yUAe2ShT3tFm-CwUuCYeAYy_YiW/pub?gid=2028135390&single=true&output=csv";
/* ðŸ”§ Set this to your **published Games tab** CSV (the one you confirmed works) */
const GAMES_CSV  = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQcWJM6Q6hTdFnES_G5LUy4teCS-sJ5HdAc9F5HSY8DGE9egdGy8yUAe2ShT3tFm-CwUuCYeAYy_YiW/pub?output=csv";

/* Shorthands */
const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
const TODAY = new Date();
const todayMidnight = new Date(TODAY.getFullYear(), TODAY.getMonth(), TODAY.getDate());

/* Level sort used everywhere */
const levelOrder = {
  'MLB':13,'INTERNATIONAL':12,'TRIPLE-A':11,'AAA':11,'DOUBLE-A':10,'AA':10,'HIGH-A':9,'A+':9,
  'LOW-A':8,'A':8,'ROOKIE':7,'ROK':7,'INDY':6,'NCAA-D1':5,'NCAA-D2':4,'NCAA-D3':3,'NAIA':2,'JUCO':1
};
function defaultSort(a,b){
  const aIsSponsor = (a.status||'').toUpperCase()==='SPONSOR';
  const bIsSponsor = (b.status||'').toUpperCase()==='SPONSOR';
  if (aIsSponsor && !bIsSponsor) return -1;
  if (!aIsSponsor && bIsSponsor) return 1;
  const aIsPriority = (a.status||'').toUpperCase().includes('ACTIVE') || (a.status||'').toUpperCase()==='FREE AGENT';
  const bIsPriority = (b.status||'').toUpperCase().includes('ACTIVE') || (b.status||'').toUpperCase()==='FREE AGENT';
  if (aIsPriority && !bIsPriority) return -1;
  if (!aIsPriority && bIsPriority) return 1;
  if (aIsPriority && bIsPriority){
    const A=(a.level||'').toUpperCase().trim(), B=(b.level||'').toUpperCase().trim();
    const lA=levelOrder[A] ?? -1, lB=levelOrder[B] ?? -1;
    if (lA!==lB) return lB-lA;
    const gA=+a.grad_class||0, gB=+b.grad_class||0; if (gA!==gB) return gA-gB;
    const yA=(a.letter_years||'').split(',').filter(Boolean).length, yB=(b.letter_years||'').split(',').filter(Boolean).length;
    if (yA!==yB) return yB-yA;
    return (a.display_name||'').localeCompare(b.display_name||'');
  }
  const cA=+a.grad_class||9999, cB=+b.grad_class||9999;
  if (cA!==cB) return cA-cB;
  return (a.display_name||'').localeCompare(b.display_name||'');
}

/* CSV loader (robust) */
async function loadCSV(url){
  const res = await fetch(url, {cache:'no-store'});
  if(!res.ok) throw new Error(`HTTP ${res.status}`);
  const text = await res.text();
  const rows = text.trim().split(/\r?\n/).map(line => line.split(/,(?=(?:[^"]*"[^"]*")*[^"]*$)/).map(c=>c.replace(/^"|"$/g,'')));
  const header = rows.shift().map(h => h.trim());
  const idx = name => header.findIndex(h => h.toLowerCase()===name.toLowerCase());
  return rows.map(r=>{
    const obj={};
    header.forEach((h,i)=>obj[h]=r[i]);
    obj.__idx = idx; // keep finder
    return obj;
  });
}

/* Players (from roster CSV) */
function mapPlayers(rows){
  const idx = rows[0].__idx;
  const pick = (row, name) => row[name] ?? row[name.toLowerCase()];
  const statKeys = ['avg','obp','slg','ops','ab','h','r','rbi','2b','3b','hr','sb','bb','era','k/9','k/bb','whip','ip','er','ko','gp','w-l','saves','fip'];

  return rows.map(r=>{
    const p = {
      slug: pick(r,'slug'),
      display_name: pick(r,'display_name'),
      first: pick(r,'first'), last: pick(r,'last'),
      grad_class: pick(r,'grad_class'), letter_years: pick(r,'letter_years'),
      status: pick(r,'status'), level: pick(r,'level'),
      team: pick(r,'team'), org: pick(r,'org'), position: pick(r,'position'),
      x_handle: pick(r,'x_handle'), ig_handle: pick(r,'ig_handle'),
      last_game_1: pick(r,'last_game_1'), last_game_2: pick(r,'last_game_2'), last_game_3: pick(r,'last_game_3')
    };
    p.stats = {};
    for(const k of statKeys){
      const v = pick(r,k.toUpperCase()) ?? pick(r,k);
      if (v) p.stats[k.toUpperCase()] = v;
    }
    return p;
  });
}

/* Helpers used by line-scores */
const pad2 = n => String(n).padStart(2,'0');
const fmtMD = d => `${d.getMonth()+1}/${d.getDate()}`;
const fmtWeekHeader = (start,end)=>{
  const MONTHS=["January","February","March","April","May","June","July","August","September","October","November","December"];
  const sameMonth = start.getMonth()===end.getMonth();
  const left  = `${MONTHS[start.getMonth()]} ${start.getDate()}`;
  const right = `${sameMonth ? '' : MONTHS[end.getMonth()]+' '}${end.getDate()}`;
  return `Week of ${left} - ${right}`;
};
function lastSundayAnchor(from=new Date()){
  const d = new Date(from.getFullYear(), from.getMonth(), from.getDate());
  d.setDate(d.getDate() - d.getDay()); // back to Sunday
  return d;
}
function fourRecentWeeks(){
  const start0 = lastSundayAnchor(TODAY);
  return Array.from({length:4}, (_,i)=>{
    const start = new Date(start0); start.setDate(start0.getDate() - 7*i);
    const end   = new Date(start);  end.setDate(start.getDate() + 6);
    return { start, end };
  });
}
const fmtTime12 = (hhmm)=>{
  if (!hhmm) return 'TBD';
  const [hRaw,mRaw] = String(hhmm).split(':');
  let h = Number(hRaw||0), m = pad2(Number(mRaw||0));
  const ampm = h >= 12 ? 'PM' : 'AM'; h = (h % 12) || 12;
  return `${h}:${m} ${ampm}`;
};
function haOpp(homeAway, opponent){
  const ha = (String(homeAway||'').toUpperCase()==='AWAY') ? '@' : 'vs.';
  const opp = String(opponent||'').trim().toUpperCase();
  return `${ha} ${opp}`;
}
function formatGameLine(row){
  const d = row._dateObj;
  const md = fmtMD(d);
  const oppPart = haOpp(row.HomeAway, row.Opponent);
  const score = (row.daily_line_score||'').trim();
  const isFuture = d > todayMidnight;
  if (isFuture){
    return `${md} ${oppPart} - ${fmtTime12(row.GameTimeLocal)}`;
  }
  return `${md} ${oppPart} ${score ? `- ${score}` : `| DNP`}`;
}

/* Map Games CSV rows & parse date */
function mapGames(rows){
  return rows.map(r=>{
    const player_name   = r.player_name ?? r['player_name'];
    const daily         = r.daily_line_score ?? r['daily_line_score'];
    const gameDateLocal = r.GameDateLocal ?? r['GameDateLocal'] ?? r['Game Date Local'] ?? r['GameDate'];
    const gameTimeLocal = r.GameTimeLocal ?? r['GameTimeLocal'] ?? r['Game Time Local'] ?? r['TimeLocal'];
    const opponent      = r.Opponent ?? r['Opponent'];
    const homeAway      = r.HomeAway ?? r['HomeAway'] ?? r['Home/Away'] ?? r['HA'];

    // parse date (accept M/D or M/D/YYYY)
    let y = TODAY.getFullYear(), m=0, d=1;
    if (gameDateLocal){
      const parts = String(gameDateLocal).split(/[\/\-]/).map(s=>s.trim());
      m = Number(parts[0]||1)-1; d = Number(parts[1]||1);
      if (parts[2] && parts[2].length===4) y = Number(parts[2]);
    }
    const dt = new Date(y,m,d);

    return {
      player_name: player_name || '',
      daily_line_score: daily || '',
      Opponent: opponent || '',
      HomeAway: homeAway || '',
      GameDateLocal: gameDateLocal || '',
      GameTimeLocal: gameTimeLocal || '',
      _dateObj: dt
    };
  });
}

/* NEWS rendering */
function newsCardHTML(n){
  const img = n.image || ('https://picsum.photos/seed/' + encodeURIComponent(n.id || n.title || 'news') + '/400/560');
  const when = n.publishedAt ? new Date(n.publishedAt).toLocaleString() : '';
  const src = n.source || 'News';
  const title = n.title || 'Read more';
  const base = String(n.url || '#');
  const read = base + (base.includes('?') ? '&' : '?') + 'utm_source=yatstats&utm_medium=news';
  const shareTxt = encodeURIComponent(title + ' â€” via YATSTATS');
  const shareUrl = encodeURIComponent(base);

  return `<article class="news-card">
    <div class="news-thumb" style="background-image:url('${img}')"></div>
    <div class="news-body">
      <div class="news-title">${title}</div>
      <div class="news-meta">${src} â€¢ ${when}</div>
      ${n.player_display_name ? `<div class="news-player">${n.player_display_name}</div>`:''}
      <div class="news-actions">
        <a href="https://x.com/intent/tweet?text=${shareTxt}&url=${shareUrl}" target="_blank" aria-label="Share to X"><i class="ri-twitter-x-line"></i></a>
        <a href="https://www.facebook.com/sharer/sharer.php?u=${shareUrl}" target="_blank" aria-label="Share to Facebook"><i class="ri-facebook-circle-line"></i></a>
        <a href="mailto:?subject=${encodeURIComponent('YATSTATS: ' + title)}&body=${shareUrl}" aria-label="Share by Email"><i class="ri-mail-line"></i></a>
        <a href="${read}" target="_blank" rel="noopener" style="margin-left:auto;display:inline-flex;align-items:center;gap:6px"><i class="ri-external-link-line"></i> Read More</a>
      </div>
    </div>
  </article>`;
}
function renderNews(items){
  const box = $('#colNews');
  if (!items?.length){ box.innerHTML = `<p style="color:var(--muted)">No headlines match the filters.</p>`; return; }
  box.innerHTML = items.map(newsCardHTML).join('');
}

/* WEEKLY LINE SCORES (render into any container) */
function renderWeeklyLineScores(players, gameRows, intoEl){
  const pkey = p => (p.display_name||'').trim().toLowerCase();
  const byName = new Map(players.map(p=>[pkey(p),p]));
  const rows = gameRows
    .filter(r => r.player_name)
    .map(r => ({...r, _p: byName.get(String(r.player_name).trim().toLowerCase())}))
    .filter(r => r._p);

  const weeks = fourRecentWeeks(); // most recent first
  const htmlWeeks = weeks.map(({start,end})=>{
    const inWeek = rows.filter(r => r._dateObj >= start && r._dateObj <= end);

    const mapByPlayer = new Map();
    for (const r of inWeek){
      const key = pkey(r._p);
      if (!mapByPlayer.has(key)) mapByPlayer.set(key, []);
      mapByPlayer.get(key).push(r);
    }

    const playersInWeek = Array.from(mapByPlayer.values()).map(arr=>arr[0]._p);
    playersInWeek.sort(defaultSort);

    const blocks = playersInWeek.map(p=>{
      const lines = mapByPlayer.get(pkey(p)).slice().sort((a,b)=>b._dateObj - a._dateObj).map(formatGameLine).join('<br>');
      return `<div class="player-block">
                <div class="player-name">${(p.display_name||'').toUpperCase()}</div>
                <div class="player-lines">${lines}</div>
              </div>`;
    }).join('');

    return `<div class="week-group">
              <div class="section-title">${fmtWeekHeader(start,end)}</div>
              ${blocks || `<div style="opacity:.7;padding:6px 0 10px;">No games recorded for this week.</div>`}
            </div>`;
  }).join('');

  intoEl.innerHTML = htmlWeeks;
}

/* Filters for NEWS (name + date only are effective here) */
function readFilters(){
  return {
    name: ($('#filterName')?.value||'').trim().toLowerCase(),
    from: $('#filterFrom')?.value ? new Date($('#filterFrom').value) : null,
    to:   $('#filterTo')?.value ? new Date($('#filterTo').value)   : null
  };
}
function applyNewsFilters(allNews){
  const F = readFilters();
  const fit = n=>{
    const txt = [
      n.title, n.player_display_name, n.source, n.school, n.conference
    ].join(' ').toLowerCase();
    const nameOk = !F.name || txt.includes(F.name);
    const when = n.publishedAt ? new Date(n.publishedAt) : null;
    const fromOk = !F.from || (when && when >= F.from);
    const toOk   = !F.to   || (when && when <= F.to);
    return nameOk && fromOk && toOk;
  };
  renderNews(allNews.filter(fit).sort((a,b)=> new Date(b.publishedAt||0) - new Date(a.publishedAt||0)));
}

/* Populate filter lists (levels/classes/roster years) â€“ same as index for UI parity */
function populateLists(players){
  const levels=[...new Set(players.map(p=>p.level).filter(Boolean))]
    .sort((a,b)=>(levelOrder[b?.toUpperCase()]??-1)-(levelOrder[a?.toUpperCase()]??-1));
  $('#filterLevels').innerHTML =
    '<label class="select-all-label"><input type="checkbox" class="select-all"> Select All</label>' +
    levels.map(level=>`<label><input type="checkbox" value="${level}" disabled> ${level}</label>`).join(''); // (disabled in news for now)

  const g=[...new Set(players.map(p=>p.grad_class).filter(Boolean))].sort((a,b)=>b-a);
  $('#filterGradClass').innerHTML =
    '<label class="select-all-label"><input type="checkbox" class="select-all" disabled> Select All</label>' +
    g.map(y=>`<label><input type="checkbox" value="${y}" disabled> ${y}</label>`).join('');

  const ry=[...new Set(players.flatMap(p=>(p.letter_years||'').split(',')).map(y=>y.trim()).filter(Boolean))].sort((a,b)=>b-a);
  $('#filterRosterYear').innerHTML =
    '<label class="select-all-label"><input type="checkbox" class="select-all" disabled> Select All</label>' +
    ry.map(y=>`<label><input type="checkbox" value="${y}" disabled> ${y}</label>`).join('');
}

/* UI wiring (same patterns as index) */
function setupTheme(){
  const themeToggle=$('#theme-toggle'); if(!themeToggle) return;
  const body=document.body, icon=themeToggle.querySelector('i');
  const apply=()=>{
    const saved=localStorage.getItem('theme');
    if (saved==='light'){ body.classList.add('light-theme'); icon?.classList.replace('ri-sun-line','ri-moon-line'); }
    else { body.classList.remove('light-theme'); icon?.classList.replace('ri-moon-line','ri-sun-line'); }
  };
  themeToggle.addEventListener('click', ()=>{
    body.classList.toggle('light-theme');
    localStorage.setItem('theme', body.classList.contains('light-theme') ? 'light' : 'dark');
    apply();
  });
  apply();
}
function closeDrawers(){ document.body.classList.remove('drawer-left-open','drawer-right-open','drawer-open'); }
function setupEvents(allNews, players, gameRows){
  $('#btnMenu')?.addEventListener('click',()=>{ document.body.classList.add('drawer-left-open','drawer-open'); });
  $('#openSearch')?.addEventListener('click',()=>{ document.body.classList.add('drawer-left-open','drawer-open'); });
  $('#openFilters')?.addEventListener('click',()=>{
    $('#drawerFilters').style.display='flex';
    $('#drawerLineScores').style.display='none';
    document.body.classList.add('drawer-right-open','drawer-open');
  });
  $('#openLineScores')?.addEventListener('click',()=>{
    $('#drawerLineScores').style.display='flex';
    $('#drawerFilters').style.display='none';
    document.body.classList.add('drawer-right-open','drawer-open');
  });
  $$('.close-btn').forEach(b=>b.addEventListener('click',closeDrawers));
  $('.drawer-mask')?.addEventListener('click',closeDrawers);

  // filters
  $('#filters')?.addEventListener('change', e=>{
    if (e.target.classList.contains('select-all')){
      const on = e.target.checked;
      e.target.closest('.filter-options')?.querySelectorAll('input[type="checkbox"]:not(.select-all)').forEach(cb=>cb.checked=on);
    }
    applyNewsFilters(allNews);
  });
  $('#filterName')?.addEventListener('input', ()=>applyNewsFilters(allNews));
  $('#filterFrom')?.addEventListener('change', ()=>applyNewsFilters(allNews));
  $('#filterTo')?.addEventListener('change', ()=>applyNewsFilters(allNews));
  $('#filtersReset')?.addEventListener('click', ()=>{
    $$('#filters input').forEach(i=>{ if(i.type==='checkbox') i.checked=false; if(i.type==='date'||i.type==='text') i.value=''; });
    applyNewsFilters(allNews);
  });
  $('#filtersReset2')?.addEventListener('click', ()=>{
    $$('#filters input').forEach(i=>{ if(i.type==='checkbox') i.checked=false; if(i.type==='date'||i.type==='text') i.value=''; });
    applyNewsFilters(allNews);
  });

  // mobile drawer body content
  const lsDrawer = $('#lsDrawerBody');
  if (lsDrawer){ lsDrawer.innerHTML = '<div class="section-title">Loadingâ€¦</div>'; renderWeeklyLineScores(players, gameRows, lsDrawer); }
}

/* Load NEWS from cache (same strategy you had) */
function loadNewsFromCache(){
  try{
    const cacheRaw = localStorage.getItem('YAT_NEWS_CACHE_V1');
    const cache = cacheRaw ? JSON.parse(cacheRaw) : {};
    const items = Array.isArray(cache.items) ? cache.items : [];
    return items;
  }catch { return []; }
}

/* Boot */
(async ()=>{
  try{
    setupTheme();

    const [rosterRows, gamesRows] = await Promise.all([
      loadCSV(ROSTER_CSV),
      loadCSV(GAMES_CSV)
    ]);

    const PLAYERS = mapPlayers(rosterRows);
    PLAYERS.sort(defaultSort);
    populateLists(PLAYERS);

    const GAMES = mapGames(gamesRows);

    // NEWS
    const NEWS = loadNewsFromCache();
    applyNewsFilters(NEWS); // renders news

    // LINE SCORES (desktop/tablet column)
    const lsCol = $('#colLineScores');
    if (lsCol){ renderWeeklyLineScores(PLAYERS, GAMES, lsCol); }

    // Wire UI (after initial renders)
    setupEvents(NEWS, PLAYERS, GAMES);
  }catch(err){
    console.error('Init failed', err);
    $('#colNews').innerHTML = `<p style="color:#f99">Error loading page: ${err.message}</p>`;
  }
})();
</script>
</body>
</html>