<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Alumni News • Hamilton YATSTATS</title>

<link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Oswald:wght@300;400;500&family=Bebas+Neue&display=swap" rel="stylesheet">

<!-- Firebase (same pattern you use everywhere) -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getAuth, onAuthStateChanged, signInWithCustomToken, signInAnonymously, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
  window.firebaseAuth = { getAuth, onAuthStateChanged, signInWithCustomToken, signInAnonymously, signOut };
  try{
    const firebaseConfig = JSON.parse(window.__firebase_config || '{}');
    const app = initializeApp(firebaseConfig);
    window.auth = getAuth(app);
    onAuthStateChanged(window.auth, user => {
      document.dispatchEvent(new CustomEvent('authStateChanged', { detail: { user } }));
    });
    if (window.__initial_auth_token) { await signInWithCustomToken(window.auth, window.__initial_auth_token); }
    else { await signInAnonymously(window.auth); }
  }catch(e){ console.error('Firebase init error:', e); }
</script>

<style>
:root{
  --bg:#0c0c0c; --fg:#f2f2f2; --muted:#c4c4c4; --ink:#e8e8e8; --line:rgba(255,255,255,.10);
  --card:#151515; --pill:#222; --accent:#fff;
  --containerPad:16px; --footerH:64px;
  --hamSmall:13px; --hamBig:20px; --hamBigger:24px;
}

*{ box-sizing:border-box }
html,body{ margin:0 }
body{ background:var(--bg); color:var(--fg); font-family:Oswald,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif }

a{ color:inherit; text-decoration:none }
.container{ max-width:1400px; margin:0 auto; padding:0 var(--containerPad) }

.header{ position:sticky; top:0; z-index:60; background:#000 }
.topbar{ display:flex; align-items:center; justify-content:space-between; padding:8px 0; gap:12px }
.left-icons,.right-icons{ display:flex; align-items:center; gap:8px }
.icon-btn{ background:none; border:none; color:var(--fg); opacity:.92; display:inline-flex; align-items:center; justify-content:center; padding:0; margin:0 2px; cursor:pointer }
.icon-btn i{ font-size:20px }
.topnav{ display:flex; gap:18px; align-items:center }
.nav-pair .thin{ font:300 var(--hamSmall) Oswald; letter-spacing:.02em; color:#cfd2d6; margin-right:2px }
.nav-pair .bold{ font:400 var(--hamSmall) "Bebas Neue", sans-serif }
@media (max-width:1200px){ .topnav{ display:none !important } }

.hr-y{ border-top:1px solid var(--line) }

.schoolrow{ display:flex; align-items:center; gap:16px; padding:8px 0 }
.ham-logo{ height:clamp(50px,8vw,70px); width:auto; object-fit:contain; flex-shrink:0 }
.schooltext .small{ font:300 var(--hamSmall)/1 Oswald; letter-spacing:.02em; color:var(--muted) }
.schooltext .big1{ font:400 var(--hamBig)/1 "Bebas Neue",sans-serif }
.schooltext .big2{ font:400 var(--hamBigger)/1 "Bebas Neue",sans-serif; margin-top:-4px }

.page-title{ display:flex; align-items:center; gap:14px; padding:10px 0 6px }
.page-title h1{ margin:0; font:400 32px/1 "Bebas Neue",sans-serif; letter-spacing:.05em }

.controls{ display:flex; gap:10px; align-items:center; flex-wrap:wrap }
.date-input{ background:#111; border:1px solid var(--line); color:var(--ink); padding:10px 12px; border-radius:10px; font:500 14px Oswald }
.btn{ background:#111; border:1px solid var(--line); color:var(--fg); padding:10px 14px; border-radius:10px; font:500 14px Oswald; cursor:pointer }
.btn i{ margin-right:6px }

.main{ padding:10px 0 calc(var(--footerH) + 12px) }

.grid{
  display:grid; gap:16px;
  grid-template-columns: 1fr 1fr 1fr;
  grid-template-areas: "pro college lines";
}
#colPro{ grid-area: pro }
#colCollege{ grid-area: college }
#colLineScores{ grid-area: lines }
@media (max-width:1100px){
  .grid{
    grid-template-columns: 2fr 1fr;
    grid-template-areas:
      "pro lines"
      "college lines";
  }
}
@media (max-width:720px){
  .grid{
    grid-template-columns: 1fr;
    grid-template-areas:
      "pro"
      "college"
      "lines";
  }
}

.section-title{
  background:#1e1e1e; border:1px solid var(--line);
  padding:10px 12px; border-radius:12px; margin:0 0 10px;
  font:700 18px "Bebas Neue",sans-serif; letter-spacing:.08em;
}

/* NEWS CARDS */
.news-list{ display:flex; flex-direction:column; gap:12px }
.news-card{
  display:flex; gap:12px; align-items:stretch; background:var(--card);
  border:1px solid var(--line); border-radius:14px; padding:10px;
}
.thumb{
  width:120px; flex:0 0 120px; border-radius:10px; overflow:hidden; background:#000;
}
.thumb img{
  display:block; width:100%; height:100%; object-fit:cover; aspect-ratio:5/7;
}
.card-body{ flex:1; min-width:0; display:flex; flex-direction:column; justify-content:space-between }
.headline{ font:700 18px/1.2 "Bebas Neue",sans-serif; letter-spacing:.03em; margin:0 0 4px }
.meta{ font:300 12px/1.1 Oswald; color:var(--muted); margin-bottom:6px }
.player-line{ font:500 13px/1.2 Oswald; color:#ddd } /* this exact size/weight is reused for line-score rows */
.actions{ display:flex; gap:10px; align-items:center; margin-top:8px }
.icon-link{ display:inline-flex; align-items:center; gap:6px; font:500 13px Oswald; opacity:.9 }
.icon-link i{ font-size:17px }

.readmore{ margin-left:auto; background:#0f0f0f; border:1px solid var(--line); padding:6px 10px; border-radius:8px; font:700 13px "Bebas Neue",sans-serif; letter-spacing:.06em }

/* LINE SCORES */
.week-group{ background:#141414; border:1px solid var(--line); border-radius:14px; padding:10px; margin-bottom:12px }
.player-block{ background:#111; border:1px solid var(--line); border-radius:12px; padding:10px 12px; margin:10px 0 }
.player-name{ font:700 18px "Bebas Neue",sans-serif; letter-spacing:.08em } /* ALL CAPS, same size as section title */
.line-row{ display:flex; align-items:center; gap:10px; padding:6px 8px 4px; border-radius:10px; background:#0e0e0e; margin:6px 0 }
.date-pill{ background:var(--pill); padding:3px 8px; border-radius:999px; font:700 12px "Bebas Neue",sans-serif; letter-spacing:.08em; color:#fff }
.line-text{ font:500 13px/1.25 Oswald; color:#ddd } /* NOT BOLD, same size/weight as .news-card .player-line */
.line-text b{ font-weight:600 }

/* Drawers */
.drawer-mask{ position:fixed; inset:0; background:rgba(0,0,0,.4); opacity:0; pointer-events:none; transition:opacity .2s; z-index:90 }
.drawer{ position:fixed; top:0; bottom:0; right:0; width:min(360px,86vw); background:rgba(10,10,10,.86); backdrop-filter:blur(4px);
         color:#e8e8e8; transform:translateX(110%); transition:transform .25s; z-index:100; display:flex; flex-direction:column }
.drawer .pad{ padding:12px 16px }
.drawer h3{ margin:14px 16px 4px; font:700 18px "Bebas Neue",sans-serif; letter-spacing:.08em }
.drawer .close-btn{ position:absolute; top:10px; right:10px }
body.drawer-right-open .drawer-mask{ opacity:1; pointer-events:auto }
body.drawer-right-open .drawer{ transform:translateX(0) }
.filter-group{ border-top:1px solid var(--line); padding:10px 0 }
.filter-title{ font:700 14px "Bebas Neue",sans-serif; letter-spacing:.08em; margin-bottom:6px }
.checkbox{ display:flex; align-items:center; gap:8px; margin:5px 0; font:500 14px Oswald }
.checkbox input{ accent-color:#fff }

.site-footer{ position:fixed; left:0; right:0; bottom:0; height:var(--footerH); background:#0b0b0b; border-top:1px solid var(--line) }
.site-footer .wrap{ height:100%; display:flex; align-items:center; justify-content:center; padding:0 var(--containerPad) }
.site-footer img{ height:100%; width:100%; object-fit:contain }
</style>
</head>

<body>
<header class="header">
  <div class="container topbar">
    <div class="left-icons">
      <button class="icon-btn" id="btnMenu" aria-label="Menu"><i class="ri-menu-line"></i></button>
      <div class="page-title">
        <h1>ALUMNI NEWS</h1>
      </div>
    </div>
    <nav class="topnav" aria-label="Top Navigation">
      <a href="index.html" class="nav-pair"><span class="thin">WHERE THEY</span><span class="bold">YAT?</span></a>
      <a href="alumni-news.html" class="nav-pair"><span class="thin">ACTIVE ALUMNI</span><span class="bold">NEWS</span></a>
      <a href="all-time-list.html" class="nav-pair"><span class="thin">NEXT-LEVEL</span><span class="bold">ALL-TIME LIST</span></a>
    </nav>
    <div class="right-icons">
      <input type="date" id="fromDate" class="date-input" />
      <input type="date" id="toDate" class="date-input" />
      <button class="btn" id="btnRefresh"><i class="ri-restart-line"></i>Refresh</button>
      <button class="btn" id="btnFilters"><i class="ri-equalizer-line"></i>Filters</button>
    </div>
  </div>
  <div class="hr-y"></div>
  <div class="container schoolrow">
    <img class="ham-logo" src="assets/img/crest.png" alt="Hamilton Crest" onerror="this.src='assets/img/placeholder.png'">
    <div class="schooltext">
      <div class="small">CHANDLER, AZ</div>
      <div class="big1">HAMILTON HIGH SCHOOL</div>
      <div class="big2">ACTIVE BASEBALL ALUMNI</div>
    </div>
  </div>
  <div class="hr-y"></div>
</header>

<div class="drawer-mask"></div>
<aside class="drawer" id="drawerRight" aria-label="Filters drawer">
  <button class="icon-btn close-btn" id="closeFilters"><i class="ri-close-line"></i></button>
  <h3>FILTERS</h3>
  <div class="pad">

    <div class="filter-group">
      <div class="filter-title">By Status</div>
      <label class="checkbox"><input type="checkbox" data-filter="status" value="ACTIVE 2025"> ACTIVE 2025</label>
      <label class="checkbox"><input type="checkbox" data-filter="status" value="ACTIVE 2024"> ACTIVE 2024</label>
      <label class="checkbox"><input type="checkbox" data-filter="status" value="FREE AGENT"> FREE AGENT</label>
      <label class="checkbox"><input type="checkbox" data-filter="status" value="INJURED"> INJURED</label>
    </div>

    <div class="filter-group">
      <div class="filter-title">By Level</div>
      <label class="checkbox"><input type="checkbox" data-filter="level" value="MLB"> MLB</label>
      <label class="checkbox"><input type="checkbox" data-filter="level" value="INTERNATIONAL"> INTERNATIONAL</label>
      <label class="checkbox"><input type="checkbox" data-filter="level" value="TRIPLE-A"> TRIPLE-A</label>
      <label class="checkbox"><input type="checkbox" data-filter="level" value="DOUBLE-A"> DOUBLE-A</label>
      <label class="checkbox"><input type="checkbox" data-filter="level" value="HIGH-A"> HIGH-A</label>
      <label class="checkbox"><input type="checkbox" data-filter="level" value="LOW-A"> LOW-A</label>
      <label class="checkbox"><input type="checkbox" data-filter="level" value="INDY"> INDY</label>
      <label class="checkbox"><input type="checkbox" data-filter="level" value="NCAA-D1"> NCAA-D1</label>
      <label class="checkbox"><input type="checkbox" data-filter="level" value="NCAA-D2"> NCAA-D2</label>
      <label class="checkbox"><input type="checkbox" data-filter="level" value="NCAA-D3"> NCAA-D3</label>
      <label class="checkbox"><input type="checkbox" data-filter="level" value="NAIA"> NAIA</label>
      <label class="checkbox"><input type="checkbox" data-filter="level" value="JUCO"> JUCO</label>
    </div>

    <div class="filter-group">
      <div class="filter-title">By Graduating Class</div>
      <div id="gradList" style="display:grid;grid-template-columns:repeat(3,1fr);gap:6px"></div>
    </div>

    <div class="filter-group" style="display:flex; gap:10px; justify-content:flex-end">
      <button class="btn" id="btnResetFilters"><i class="ri-close-circle-line"></i>Reset</button>
      <button class="btn" id="btnDoneFilters"><i class="ri-check-line"></i>Done</button>
    </div>
  </div>
</aside>

<main class="main container">
  <div class="grid">

    <!-- Column 1: Pro News -->
    <section id="colPro">
      <div class="section-title" id="titlePro">ALUMNI HEADLINES (Pros)</div>
      <div class="news-list" id="listPro"><p style="color:var(--muted)">Loading…</p></div>
    </section>

    <!-- Column 2: College News -->
    <section id="colCollege">
      <div class="section-title" id="titleCollege">ALUMNI HEADLINES (College)</div>
      <div class="news-list" id="listCollege"><p style="color:var(--muted)">Loading…</p></div>
    </section>

    <!-- Column 3: Line Scores -->
    <section id="colLineScores" aria-live="polite">
      <div class="section-title" id="titleLines">ALUMNI LINE SCORES</div>
      <div id="linesWrap"><p style="color:var(--muted)">Loading line scores…</p></div>
    </section>

  </div>
</main>

<footer class="site-footer">
  <div class="wrap">
    <img src="assets/img/sponsor-1200x120.jpg" alt="Sponsor Banner">
  </div>
</footer>

<script type="module">
/* ---------- CONFIG ---------- */
const ROSTER_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQcWJM6Q6hTdFnES_G5LUy4teCS-sJ5HdAc9F5HSY8DGE9egdGy8yUAe2ShT3tFm-CwUuCYeAYy_YiW/pub?gid=2028135390&single=true&output=csv";
const NEWS_JSON_URL  = "assets/news/alumni_news.json";

/* Use your workbook ID; this gviz endpoint reads the tab by name GAMES.
   (Works with “Publish to web” ON, or if the sheet is shared to Anyone with link – Viewer) */
const SHEET_ID = "1yUNQH9NbpKwOOwH9blf5ZqQfmft796sQl1dqghXP4uA";
const GAMES_CSV_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=GAMES`;

const CACHE_VERSION = "V5";

/* ---------- HELPERS ---------- */
const $  = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
const fmtLong = d => d.toLocaleDateString(undefined,{month:"long",day:"numeric",year:"numeric"});
const fmtWeek = d => `WEEK OF ${fmtLong(d)}`;
const weekStart = d => { const x=new Date(d); const day=x.getDay(); x.setDate(x.getDate()-day); x.setHours(0,0,0,0); return x; }; // Sun
const PRO_LEVELS = ["MLB","INTERNATIONAL","TRIPLE-A","DOUBLE-A","HIGH-A","LOW-A","INDY"];
const COL_LEVELS = ["NCAA-D1","NCAA-D2","NCAA-D3","NAIA","JUCO"];
const LEVEL_ORDER = new Map([
  ["MLB",1],["INTERNATIONAL",2],["TRIPLE-A",3],["DOUBLE-A",4],["HIGH-A",5],["LOW-A",6],["INDY",7],
  ["NCAA-D1",8],["NCAA-D2",9],["NCAA-D3",10],["NAIA",11],["JUCO",12]
]);

function parseCSV(text){
  const rows = text.trim().split(/\r?\n/).map(l =>
    l.split(/,(?=(?:[^"]*"[^"]*")*[^"]*$)/).map(c=>c.replace(/^"|"$/g,''))
  );
  const header = rows.shift();
  const idx = name => header.indexOf(name);
  return { rows, idx };
}
function toDateLocal(s){
  if(!s) return null;
  const d = new Date(s);
  return isNaN(d) ? null : d;
}
function addUTM(url){ if(!url) return ""; return url + (url.includes("?")?"&":"?") + "utm_source=yatstats&utm_medium=news"; }
function rosterSort(a,b){
  const la = LEVEL_ORDER.get((a.level||"").toUpperCase()) || 99;
  const lb = LEVEL_ORDER.get((b.level||"").toUpperCase()) || 99;
  if (la !== lb) return la - lb;
  const ga = parseInt(a.grad_class||0,10) || 0;
  const gb = parseInt(b.grad_class||0,10) || 0;
  return gb - ga; // newer class first
}

/* ---------- FETCHERS ---------- */
async function fetchRoster(){
  const res = await fetch(ROSTER_CSV_URL, {cache:"no-store"});
  if(!res.ok) throw new Error("Roster CSV HTTP "+res.status);
  const {rows, idx} = parseCSV(await res.text());
  return rows.map(r=>({
    display_name:r[idx("display_name")],
    first:r[idx("first")], last:r[idx("last")],
    grad_class:r[idx("grad_class")],
    status:(r[idx("status")]||"").toUpperCase(),
    level:(r[idx("level")]||"").toUpperCase(),
    team:r[idx("team")], org:r[idx("org")],
    last_game_1:r[idx("last_game_1")], last_game_2:r[idx("last_game_2")], last_game_3:r[idx("last_game_3")]
  }));
}

async function fetchNews(){
  const res = await fetch(NEWS_JSON_URL, {cache:"no-store"});
  if(!res.ok) throw new Error("News JSON HTTP "+res.status);
  const data = await res.json();
  return Array.isArray(data) ? data : [];
}

// GAMES tab: A player_name, B daily_line_score, G GameDateLocal, I Opponent, J HomeAway
async function fetchGames(){
  try{
    const res = await fetch(GAMES_CSV_URL, {cache:"no-store"});
    if(!res.ok) throw new Error("Games CSV HTTP "+res.status);
    const {rows, idx} = parseCSV(await res.text());
    return rows.map(r=>{
      const nm = r[idx("player_name")] || r[idx("Player")] || r[0] || "";
      const date = toDateLocal(r[idx("GameDateLocal")] || r[idx("GameDate")] || "");
      const opp = r[idx("Opponent")] || "";
      const ha  = (r[idx("HomeAway")]||"").trim();
      const line= r[idx("daily_line_score")] || "";
      return { player_name:nm, date, opp, ha, line_raw:line };
    }).filter(x=>x.player_name && x.date);
  }catch(e){
    console.warn("Games fetch failed; falling back to last_game_1..3", e);
    return null;
  }
}

/* ---------- FILTERS (state) ---------- */
const F = {
  from:null, to:null,
  status:new Set(),
  level:new Set(),
  class:new Set()
};
function readDateInputs(){
  const f = $("#fromDate").value, t = $("#toDate").value;
  F.from = f ? new Date(f+"T00:00:00") : null;
  F.to   = t ? new Date(t+"T23:59:59") : null;
}

/* ---------- RENDER: NEWS ---------- */
function buildNewsCards(items){
  if(!items.length) return `<p style="color:var(--muted)">No headlines match the filters.</p>`;
  return items.map(n=>{
    const when = n.publishedAt ? new Date(n.publishedAt) : null;
    const whenStr = when ? when.toLocaleString() : "";
    const img = n.image || "assets/img/placeholder-5x7.jpg";
    const url = addUTM(n.url||"");
    const txt = encodeURIComponent(n.title||"");
    const shareX  = `https://x.com/intent/tweet?text=${txt}&url=${encodeURIComponent(url)}`;
    const shareFB = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(url)}`;
    const shareEM = `mailto:?subject=${encodeURIComponent(n.title||"")}&body=${encodeURIComponent(url)}`;
    const playerLine = n.player_display_name ? `<div class="player-line">${n.player_display_name}</div>` : "";

    return `<article class="news-card">
      <div class="thumb"><img src="${img}" alt=""></div>
      <div class="card-body">
        <div>
          <h3 class="headline">${n.title||"Read more"}</h3>
          <div class="meta">${n.source||""} • ${whenStr}</div>
          ${playerLine}
        </div>
        <div class="actions">
          <a class="icon-link" href="${shareX}" target="_blank" rel="noopener"><i class="ri-twitter-x-line"></i>Share</a>
          <a class="icon-link" href="${shareFB}" target="_blank" rel="noopener"><i class="ri-facebook-circle-line"></i>Share</a>
          <a class="icon-link" href="${shareEM}" target="_blank" rel="noopener"><i class="ri-mail-line"></i>Email</a>
          <a class="readmore" href="${url}" target="_blank" rel="noopener">READ MORE</a>
        </div>
      </div>
    </article>`;
  }).join("");
}

function filterNewsItem(n){
  // Date range
  const d = n.publishedAt ? new Date(n.publishedAt) : null;
  if (F.from && d && d < F.from) return false;
  if (F.to   && d && d > F.to)   return false;

  const st = (n.status||"").toUpperCase();
  const lv = (n.level||"").toUpperCase();
  const yr = n.grad_class ? String(n.grad_class) : "";

  if (F.status.size && !F.status.has(st)) return false;
  if (F.level.size  && !F.level.has(lv))  return false;
  if (F.class.size  && !F.class.has(yr))  return false;

  return true;
}

function renderNews(allNews){
  const pro = allNews.filter(n=> PRO_LEVELS.includes((n.level||"").toUpperCase())).filter(filterNewsItem)
                     .sort((a,b)=> new Date(b.publishedAt||0) - new Date(a.publishedAt||0));
  const col = allNews.filter(n=> COL_LEVELS.includes((n.level||"").toUpperCase())).filter(filterNewsItem)
                     .sort((a,b)=> new Date(b.publishedAt||0) - new Date(a.publishedAt||0));

  $("#listPro").innerHTML = buildNewsCards(pro);
  $("#listCollege").innerHTML = buildNewsCards(col);

  const rng = [];
  if(F.from) rng.push(F.from); if(F.to) rng.push(F.to);
  if(rng.length){
    const wk = (d=>fmtWeek(weekStart(d)))(rng[0]||new Date());
    $("#titlePro").textContent = `ALUMNI HEADLINES (Pros) — ${wk}`;
    $("#titleCollege").textContent = `ALUMNI HEADLINES (College) — ${wk}`;
  }else{
    $("#titlePro").textContent = `ALUMNI HEADLINES (Pros)`;
    $("#titleCollege").textContent = `ALUMNI HEADLINES (College)`;
  }
}

/* ---------- RENDER: LINE SCORES ---------- */
function normalizeLine(ha, opp, raw){
  const side = (ha||"").toUpperCase().startsWith("H") ? "vs." : "@";
  const oppTxt = opp ? ` ${side} ${opp}` : "";
  const line = raw ? ` - ${raw.replace(/\s*—\s*/g," ").trim()}` : " - DNP";
  return `${oppTxt}${line}`;
}

function buildLineScoresFromGames(games, rosterByName){
  // Filter by date first
  const inRange = games.filter(g=>{
    if(F.from && g.date < F.from) return false;
    if(F.to   && g.date > F.to)   return false;
    return true;
  });

  // Group -> week -> player
  const byWeek = new Map();
  for(const g of inRange){
    const wk = weekStart(g.date).toISOString();
    if(!byWeek.has(wk)) byWeek.set(wk, new Map());
    const bucket = byWeek.get(wk);
    const key = (g.player_name||"").trim().toLowerCase();
    if(!bucket.has(key)) bucket.set(key, []);
    bucket.get(key).push(g);
  }

  // Sort weeks newest first
  const weekEntries = Array.from(byWeek.entries()).sort((a,b)=> new Date(b[0]) - new Date(a[0]));

  const out = weekEntries.map(([wk, byPlayer])=>{
    // players -> first row per player for sort, then sort with rosterSort
    const players = Array.from(byPlayer.keys()).map(k=>{
      const p = rosterByName.get(k) || {display_name:k, level:"", grad_class:"0"};
      return p;
    });
    players.sort(rosterSort);

    const htmlPlayers = players.map(p=>{
      const rows = (byPlayer.get((p.display_name||"").toLowerCase())||[])
        .sort((a,b)=> b.date - a.date)
        .map(x=>{
          const d = x.date.toLocaleDateString(undefined,{month:'numeric',day:'numeric'});
          const txt = normalizeLine(x.ha, x.opp, x.line_raw);
          return `<div class="line-row">
            <span class="date-pill">${d}</span>
            <span class="line-text">${txt.replace(/\s*—\s*/g," ").trim()}</span>
          </div>`;
        }).join("");

      return `<div class="player-block">
        <div class="player-name">${(p.display_name||"").toUpperCase()}</div>
        ${rows}
      </div>`;
    }).join("");

    return `<div class="week-group">
      <div class="section-title">ALUMNI LINE SCORES — ${fmtWeek(new Date(wk))}</div>
      ${htmlPlayers || `<div style="opacity:.7;padding:8px">No line scores this week.</div>`}
    </div>`;
  }).join("");

  return out || `<p style="opacity:.7">No line scores in range.</p>`;
}

function buildLineScoresFallback(roster){
  // Use last_game_1..3 text, try to parse "M/D ..." at start
  const endYear = (F.to || new Date()).getFullYear();
  const items = [];
  for(const p of roster){
    const lines = [p.last_game_1, p.last_game_2, p.last_game_3];
    for(const ln of lines){
      if(!ln) continue;
      const m = String(ln).trim().match(/^(\d{1,2})\/(\d{1,2})\s+(.*)$/);
      if(!m) continue;
      const [,mm,dd,rest] = m;
      const d = new Date(endYear, Number(mm)-1, Number(dd));
      if(F.from && d < F.from) continue;
      if(F.to   && d > F.to)   continue;
      items.push({ player_name:p.display_name, date:d, opp:"", ha:"", line_raw:rest });
    }
  }
  // Build like from games()
  const byName = new Map(roster.map(p=>[(p.display_name||"").toLowerCase(), p]));
  return buildLineScoresFromGames(items, byName);
}

function renderLineScores(roster, games){
  const rosterByName = new Map(roster.map(p=>[(p.display_name||"").toLowerCase(), p]));

  // apply filters to roster first (affects which players appear)
  const want = p=>{
    const st = (p.status||"").toUpperCase();
    const lv = (p.level||"").toUpperCase();
    const yr = String(p.grad_class||"");
    if (F.status.size && !F.status.has(st)) return false;
    if (F.level.size  && !F.level.has(lv))  return false;
    if (F.class.size  && !F.class.has(yr))  return false;
    return true;
  };
  const filteredRoster = roster.filter(want);
  const filteredNames = new Set(filteredRoster.map(p=>(p.display_name||"").toLowerCase()));

  let html;
  if(Array.isArray(games)){
    // keep only games for filtered players
    const g2 = games.filter(g=> filteredNames.has((g.player_name||"").toLowerCase()));
    html = buildLineScoresFromGames(g2, rosterByName);
  }else{
    html = buildLineScoresFallback(filteredRoster);
  }
  $("#linesWrap").innerHTML = html;

  // Title
  const wk = F.from ? fmtWeek(weekStart(F.from)) : "RECENT WEEKS";
  $("#titleLines").textContent = `ALUMNI LINE SCORES — ${wk}`;
}

/* ---------- BOOT ---------- */
document.addEventListener("DOMContentLoaded", async ()=>{
  // Dates default: last 21 days
  const today = new Date();
  const from = new Date(today); from.setDate(from.getDate()-21);
  $("#fromDate").value = from.toISOString().slice(0,10);
  $("#toDate").value   = today.toISOString().slice(0,10);
  readDateInputs();

  // Drawer
  $("#btnFilters").addEventListener("click", ()=>{ document.body.classList.add("drawer-right-open"); });
  $("#closeFilters").addEventListener("click", ()=>{ document.body.classList.remove("drawer-right-open"); });
  $("#btnDoneFilters").addEventListener("click", ()=>{ document.body.classList.remove("drawer-right-open"); applyAll(); });
  $("#btnResetFilters").addEventListener("click", ()=>{
    F.status.clear(); F.level.clear(); F.class.clear();
    $$("#drawerRight input[type=checkbox]").forEach(cb=> cb.checked=false);
    applyAll();
  });

  // Date change
  $("#fromDate").addEventListener("change", ()=>{ readDateInputs(); applyAll(); });
  $("#toDate").addEventListener("change", ()=>{ readDateInputs(); applyAll(); });
  $("#btnRefresh").addEventListener("click", ()=> applyAll(true));

  // Build grad class list
  const years = [];
  for(let y=2013; y<=2026; y++) years.push(String(y));
  $("#gradList").innerHTML = years.reverse().map(y=>`<label class="checkbox"><input type="checkbox" data-filter="class" value="${y}"> ${y}</label>`).join("");
  $("#drawerRight").addEventListener("change", e=>{
    const cb = e.target;
    if(cb && cb.type==="checkbox" && cb.dataset.filter){
      const set = F[cb.dataset.filter];
      if(cb.checked) set.add(cb.value);
      else set.delete(cb.value);
    }
  });

  // Load data
  let roster=[], news=[], games=null;

  try{ roster = await fetchRoster(); }catch(e){ console.error(e); }
  try{ news   = await fetchNews(); }catch(e){ console.error(e); }
  try{ games  = await fetchGames(); }catch(e){ console.error(e); }

  // Store and apply
  window.__NEWS_CACHE__ = {version:CACHE_VERSION, news};
  window.__ROSTER__ = roster;
  window.__GAMES__  = games;

  function applyNews(){ renderNews(window.__NEWS_CACHE__.news); }
  function applyLines(){ renderLineScores(window.__ROSTER__, window.__GAMES__); }
  window.applyAll = async (refresh=false)=>{
    readDateInputs();
    if(refresh){
      try{ window.__NEWS_CACHE__.news = await fetchNews(); }catch(e){ console.error(e); }
      try{ window.__GAMES__ = await fetchGames(); }catch(e){ console.error(e); }
    }
    applyNews(); applyLines();
  };

  applyAll();
});
</script>
</body>
</html>