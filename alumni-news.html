<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Line Scores Module (Live)</title>
  <style>
    body { font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; color:#111; margin:1rem; background:#fafafa; }
    .week { margin-bottom:2rem; }
    .week h2 { margin:0 0 1rem; font-size:1.25rem; border-bottom:2px solid #333; padding-bottom:.25rem; }
    .player { margin-bottom:1rem; }
    .player h3 { margin:.5rem 0; font-size:1.1rem; color:#7A0019; }
    .game { margin-left:1rem; font-size:0.95rem; }
    .suffix { font-weight:bold; }
  </style>
</head>
<body>
  <div id="lineScores">Loading line scores…</div>

  <script>
    // Replace with your sheet ID
    const SHEET_URL =
      "https://docs.google.com/spreadsheets/d/1yUNQH9NbpKwOOwH9blf5ZqQfmft796sQl1dqghXP4uA/gviz/tq?tqx=out:json&sheet=STATS_SEASON_TOTALS&range=AU2:CD100";

    async function loadLineScores() {
      try {
        const res = await fetch(SHEET_URL);
        const txt = await res.text();
        const json = JSON.parse(txt.substring(47, txt.length - 2));
        const rows = json.table.rows;

        // Parse rows → player name + games
        const games = [];
        rows.forEach(r => {
          if (!r.c[0] || !r.c[0].v) return;
          const player = r.c[0].v;
          for (let i = 1; i < r.c.length; i++) {
            const val = r.c[i] ? r.c[i].v : null;
            if (!val) continue;

            // Expect val like "9/21 @ BAL | 2-3 | 2HR, 6RBI"
            // or "9/24 vs. CWS 4:05PM", etc.
            let status = "Scheduled", stats = null, time = null;
            if (val.includes("GAME IN PROGRESS")) status = "In Progress";
            else if (val.includes("DNP")) { status = "Final"; stats = null; }
            else if (val.includes("|")) { status = "Final"; stats = val.split("|").slice(1).join("|").trim(); }
            else if (val.match(/\d{1,2}:\d{2}/)) { status = "Scheduled"; time = val.match(/\d{1,2}:\d{2}\s?(AM|PM)?/)[0]; }

            const datePart = val.split(" ")[0];
            const opp = val.replace(datePart, "").split("|")[0].trim();

            games.push({
              week: "Week of September 21–27", // TODO: script this dynamically
              player,
              date: datePart,
              opp,
              status,
              stats,
              time
            });
          }
        });

        renderLineScores(games);
      } catch (err) {
        console.error("Error loading line scores:", err);
        document.getElementById("lineScores").innerHTML =
          "<p>Could not load line scores.</p>";
      }
    }

    function renderLineScores(data) {
      const container = document.getElementById("lineScores");
      container.innerHTML = "";

      // Group by week → player
      const weeks = {};
      data.forEach(g => {
        if (!weeks[g.week]) weeks[g.week] = {};
        if (!weeks[g.week][g.player]) weeks[g.week][g.player] = [];
        weeks[g.week][g.player].push(g);
      });

      for (const [week, players] of Object.entries(weeks)) {
        const weekDiv = document.createElement("div");
        weekDiv.className = "week";
        weekDiv.innerHTML = `<h2>${week}</h2>`;

        for (const [player, games] of Object.entries(players)) {
          const playerDiv = document.createElement("div");
          playerDiv.className = "player";
          playerDiv.innerHTML = `<h3>${player}</h3>`;

          games.forEach(game => {
            let suffix = "";
            if (game.status === "Final") {
              suffix = game.stats ? game.stats : "DNP";
            } else if (game.status === "In Progress") {
              suffix = "GAME IN PROGRESS";
            } else if (game.status === "Scheduled") {
              suffix = game.time;
            }
            const gameDiv = document.createElement("div");
            gameDiv.className = "game";
            gameDiv.innerHTML = `${game.date} – ${game.opp} <span class="suffix">| ${suffix}</span>`;
            playerDiv.appendChild(gameDiv);
          });

          weekDiv.appendChild(playerDiv);
        }
        container.appendChild(weekDiv);
      }
    }

    loadLineScores();
  </script>
</body>
</html>