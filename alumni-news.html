<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Alumni News â€¢ Hamilton YATSTATS</title>

<link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Oswald:wght@300;400&family=Bebas+Neue&display=swap" rel="stylesheet">

<!-- Firebase (same approach as other pages) -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getAuth, onAuthStateChanged, signInWithCustomToken, signInAnonymously, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
  window.firebaseAuth = { getAuth, onAuthStateChanged, signInWithCustomToken, signInAnonymously, signOut };
  try {
    const firebaseConfig = JSON.parse(window.__firebase_config || '{}');
    const app = initializeApp(firebaseConfig);
    window.auth = getAuth(app);
    onAuthStateChanged(window.auth, user => document.dispatchEvent(new CustomEvent('authStateChanged', { detail: { user } })));
    if (window.__initial_auth_token) await signInWithCustomToken(window.auth, window.__initial_auth_token);
    else await signInAnonymously(window.auth);
  } catch (e) {
    console.error("Firebase init error:", e);
  }
</script>

<style>
:root{
  --bg:#0c0c0c; --header:#000; --fg:#f2f2f2; --muted:#bfc4c9; --ink:#e8e8e8;
  --line:rgba(255,255,255,.10); --card:#161616; --chip:#2a2a2a;
  --hamSmall:13px; --hamBig:20px; --hamBigger:24px;
  --gutter:16px; --container:1400px;
}
@font-face{ font-family:'Indigo'; src:url('assets/fonts/Indigo.otf') format('opentype');}
*{box-sizing:border-box}
html,body{margin:0}
body{background:var(--bg);color:var(--fg);font-family:Oswald,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}

/* Header (matches flip cards) */
.header{position:sticky;top:0;z-index:60;background:var(--header);border-bottom:1px solid var(--line)}
.container{max-width:var(--container);margin:0 auto;padding:0 var(--gutter)}
.topbar{display:flex;align-items:center;justify-content:space-between;padding:10px 0;gap:12px}
.left-icons,.right-icons{display:flex;align-items:center;gap:8px}
.icon-btn{background:none;border:none;color:var(--fg);opacity:.92;display:inline-grid;place-items:center;cursor:pointer}
.icon-btn i{font-size:20px}
.topnav{display:flex;gap:18px;align-items:center}
.nav-pair .thin{font:300 var(--hamSmall) Oswald;color:#cfd2d6;letter-spacing:.02em;margin-right:2px}
.nav-pair .bold{font:400 var(--hamSmall) Indigo,"Bebas Neue",sans-serif}
@media (max-width:1200px){ .topnav{display:none!important} }
.hr-y{border-top:1px solid var(--line)}
.schoolrow{display:flex;align-items:center;gap:16px;padding:8px 0}
.ham-logo{height:clamp(50px,8vw,70px);width:auto;object-fit:contain}
.schooltext .small{font:300 var(--hamSmall)/1 Oswald;color:var(--muted)}
.schooltext .big1{font:400 var(--hamBig)/1 "Bebas Neue",sans-serif}
.schooltext .big2{font:400 var(--hamBigger)/1 "Bebas Neue",sans-serif;margin-top:-4px}
.crumbs{font:300 calc(var(--hamSmall)*.80)/1 Oswald;color:var(--muted);text-transform:uppercase;white-space:nowrap}

/* Page controls bar */
.controls{display:flex;align-items:center;gap:10px;padding:10px 0}
.date-input{appearance:none;background:#141414;border:1px solid var(--line);color:var(--ink);padding:10px 12px;border-radius:10px;font:400 14px/1 Oswald;min-width:210px}
.refresh-btn{display:inline-flex;align-items:center;gap:6px;padding:10px 12px;border-radius:10px;border:1px solid var(--line);background:#141414;color:var(--fg);cursor:pointer}
.refresh-btn i{font-size:18px}

/* Layout (3 â†’ 2 â†’ 1 columns) */
.page-grid{display:grid;grid-template-columns:2fr 2fr 1.5fr;gap:16px}
@media (max-width:1200px){
  .page-grid{grid-template-columns:2fr 1.3fr}
  /* merge pro+college into the left column on tablet */
  #colNewsPro, #colNewsCollege{grid-column:1}
  #colLineScores{grid-column:2}
}
@media (max-width:768px){
  .page-grid{grid-template-columns:1fr}
  #colNewsPro,#colNewsCollege,#colLineScores{grid-column:1}
}

/* Section shells */
.section{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:10px}
.section-title{background:#262626;border-radius:10px;padding:8px 12px;margin:6px 0 12px;font:700 16px/1 "Bebas Neue",sans-serif;letter-spacing:.06em}

/* News cards */
.news-card{display:flex;gap:12px;align-items:center;background:#121212;border:1px solid var(--line);border-radius:12px;padding:10px;margin:10px 0;text-decoration:none;color:inherit}
.news-card:hover{background:#151515}
.thumb{width:110px;flex:0 0 110px;aspect-ratio:5/7;border-radius:10px;background:#000;background-size:cover;background-position:center}
.news-meta{font:300 12px/1 Oswald;color:var(--muted)}
.news-title{font:700 15px/1.15 "Bebas Neue",sans-serif;letter-spacing:.03em}
.news-player{font:300 12px/1 Oswald;color:#d6d6d6;margin-top:2px}

/* Line Scores */
.week-group{background:#121212;border:1px solid var(--line);border-radius:12px;padding:10px;margin:12px 0}
.player-block{background:#181818;border:1px solid var(--line);border-radius:12px;padding:10px;margin:10px 0}
.player-name{font:700 16px/1 "Bebas Neue",sans-serif;letter-spacing:.06em}
.line-row{display:flex;align-items:center;gap:8px;padding:6px 8px;margin:4px 0;border-radius:10px;background:#141414}
.date-pill{display:inline-grid;place-items:center;font:700 12px/1 Oswald;color:#dcdcdc;background:#242424;border:1px solid var(--line);border-radius:20px;padding:4px 8px}
.line-text{font:400 13px/1.25 Oswald;color:#f0f0f0} /* regular weight (NOT bold) */

/* Drawer (right filters) */
.drawer-mask{position:fixed;inset:0;background:rgba(0,0,0,.35);opacity:0;pointer-events:none;transition:.2s;z-index:70}
.drawer{position:fixed;top:0;bottom:0;right:0;width:min(380px,88vw);background:rgba(12,12,12,.85);backdrop-filter:blur(4px);transform:translateX(110%);transition:transform .25s;border-left:1px solid var(--line);z-index:80;color:var(--ink)}
.drawer .head{display:flex;align-items:center;justify-content:space-between;padding:14px;border-bottom:1px solid var(--line)}
.drawer .body{padding:12px 14px;overflow:auto;height:calc(100% - 56px)}
.drawer h4{margin:18px 0 8px;font:700 16px/1 "Bebas Neue",sans-serif}
.chk{display:flex;align-items:center;gap:8px;margin:7px 0}
.chk input{accent-color:#fff}
.drawer-open .drawer-mask{opacity:1;pointer-events:auto}
.drawer-open .drawer{transform:translateX(0)}
.filter-actions{display:flex;justify-content:space-between;gap:10px;margin-top:14px}
.btn{background:#fff;color:#000;border:none;border-radius:10px;padding:10px 12px;font:700 14px "Bebas Neue",sans-serif;cursor:pointer}
.btn-ghost{background:#222;color:#eee;border:1px solid var(--line)}

/* Footer */
.site-footer{position:relative;margin-top:28px;border-top:1px solid var(--line);background:#0b0b0b}
.site-footer .wrap{max-width:var(--container);margin:0 auto;padding:18px var(--gutter);text-align:center;color:#888;font:300 12px Oswald}

/* Small helpers */
a{color:inherit} /* prevent blue links */
.hidden{display:none !important}
</style>
</head>

<body>
<header class="header">
  <div class="container topbar">
    <div class="left-icons">
      <button id="openNav" class="icon-btn" aria-label="Menu"><i class="ri-menu-line"></i></button>
      <div class="crumbs"><a href="index.html">HAMILTON</a> â–¸ ACTIVE ALUMNI <span class="hidden sm-inline">NEWS</span></div>
    </div>
    <nav class="topnav" aria-label="Top Navigation">
      <a href="index.html" class="nav-pair"><span class="thin">WHERE THEY</span><span class="bold">YAT?</span></a>
      <a href="alumni-news.html" class="nav-pair"><span class="thin">ACTIVE ALUMNI</span><span class="bold">NEWS</span></a>
      <a href="all-time-list.html" class="nav-pair"><span class="thin">NEXT-LEVEL</span><span class="bold">ALL-TIME LIST</span></a>
    </nav>
    <div class="right-icons">
      <div class="controls">
        <input id="dateFrom" class="date-input" type="date" />
        <input id="dateTo" class="date-input" type="date" />
        <button id="btnRefresh" class="refresh-btn"><i class="ri-refresh-line"></i> Refresh</button>
        <button id="openFilters" class="icon-btn" aria-label="Filters"><i class="ri-filter-3-line"></i></button>
      </div>
    </div>
  </div>
  <div class="hr-y"></div>
  <div class="container schoolrow">
    <img class="ham-logo" src="assets/img/crest-h.svg" alt="Hamilton H">
    <div class="schooltext">
      <div class="small">CHANDLER, AZ</div>
      <div class="big1">HAMILTON HIGH SCHOOL</div>
      <div class="big2">ACTIVE BASEBALL ALUMNI</div>
    </div>
  </div>
  <div class="hr-y"></div>
</header>

<!-- Right filter drawer -->
<div class="drawer-mask"></div>
<aside class="drawer" id="filterDrawer" aria-label="Filters">
  <div class="head">
    <div style="font:700 18px 'Bebas Neue', sans-serif;letter-spacing:.06em">FILTERS</div>
    <button id="closeFilters" class="icon-btn" aria-label="Close filters"><i class="ri-close-line"></i></button>
  </div>
  <div class="body">
    <label class="chk"><input id="nameQuery" type="text" placeholder="Search by nameâ€¦" style="width:100%;padding:10px;border-radius:10px;border:1px solid var(--line);background:#101010;color:#eee"></label>

    <h4>By Status</h4>
    <div id="fltStatus"></div>

    <h4>By Level</h4>
    <div id="fltLevel"></div>

    <h4>By Graduating Class</h4>
    <div id="fltClass"></div>

    <div class="filter-actions">
      <button id="btnReset" class="btn-ghost">Reset</button>
      <button id="btnDone" class="btn">Done</button>
    </div>
  </div>
</aside>

<main class="container" style="padding:16px 0 28px">
  <div class="page-grid">
    <!-- Pro News -->
    <section id="colNewsPro" class="section" aria-live="polite">
      <div id="titlePro" class="section-title">ALUMNI HEADLINES (PROS)</div>
      <div id="listPro"></div>
      <div id="emptyPro" class="news-meta" style="padding:8px 2px;display:none">No pro headlines match the filters.</div>
    </section>

    <!-- College News -->
    <section id="colNewsCollege" class="section" aria-live="polite">
      <div id="titleCol" class="section-title">ALUMNI HEADLINES (COLLEGE)</div>
      <div id="listCollege"></div>
      <div id="emptyCollege" class="news-meta" style="padding:8px 2px;display:none">No college headlines match the filters.</div>
    </section>

    <!-- Line Scores column (RIGHT) -->
    <section id="colLineScores" class="section" aria-live="polite">
      <div id="titleLines" class="section-title">ALUMNI LINE SCORES</div>
      <div id="linesWrap"><p class="news-meta" style="padding:6px">Loading line scoresâ€¦</p></div>
    </section>
  </div>
</main>

<footer class="site-footer">
  <div class="wrap">Â© Hamilton YATSTATS</div>
</footer>

<script type="module">
/* =================== CONFIG =================== */
const ROSTER_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQcWJM6Q6hTdFnES_G5LUy4teCS-sJ5HdAc9F5HSY8DGE9egdGy8yUAe2ShT3tFm-CwUuCYeAYy_YiW/pub?gid=2028135390&single=true&output=csv";
const NEWS_JSON_URL   = "assets/news/alumni_news.json";
/* ðŸ”´ REPLACE THIS with your published GAMES tab CSV url */
const GAMES_CSV_URL   = "PUT_YOUR_GAMES_TAB_PUBLISHED_CSV_URL_HERE";
/* ============================================== */

const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
const CACHE = {
  filtersKey: 'YAT_NEWS_FILTERS_V3',
  newsKey: 'YAT_NEWS_CACHE_V1',
};

const PRO_LEVELS = new Set(["MLB","INTERNATIONAL","TRIPLE-A","DOUBLE-A","HIGH-A","LOW-A","INDY","INDEPENDENT"]);
const COL_LEVELS = new Set(["NCAA-D1","NCAA-D2","NCAA-D3","NAIA","JUCO"]);
const LEVEL_ORDER = [
  "MLB","INTERNATIONAL","TRIPLE-A","DOUBLE-A","HIGH-A","LOW-A","INDY",
  "NCAA-D1","NCAA-D2","NCAA-D3","NAIA","JUCO"
];

function csvParse(text){
  const rows = [];
  let i=0, field='', row=[], inQ=false;
  const pushField=()=>{ row.push(field); field=''; };
  const pushRow=()=>{ rows.push(row); row=[]; };
  while(i<text.length){
    const c=text[i];
    if(inQ){
      if(c==='"' && text[i+1]==='"'){ field+='"'; i+=2; continue; }
      if(c==='"'){ inQ=false; i++; continue; }
      field+=c; i++; continue;
    }else{
      if(c==='"'){ inQ=true; i++; continue; }
      if(c===','){ pushField(); i++; continue; }
      if(c==='\n'){ pushField(); pushRow(); i++; continue; }
      if(c==='\r'){ i++; continue; }
      field+=c; i++; continue;
    }
  }
  pushField(); if(row.length) pushRow();
  return rows;
}
async function fetchCSV(url){
  const res = await fetch(url,{cache:'no-store'});
  if(!res.ok) throw new Error('CSV '+res.status);
  const text = await res.text();
  const rows = csvParse(text);
  const header = rows.shift().map(h=>h.trim());
  return rows.map(r=>{
    const obj={}; header.forEach((h,idx)=>obj[h]=r[idx]??''); return obj;
  });
}

/* ===== ROSTER ===== */
function canon(s){ return String(s||'').trim().toLowerCase(); }
function slugify(name){ return String(name||'').trim().toLowerCase().replace(/[^a-z0-9]+/g,'-'); }
function defaultSort(a,b){
  const la = LEVEL_ORDER.indexOf(String(a.level||'').toUpperCase());
  const lb = LEVEL_ORDER.indexOf(String(b.level||'').toUpperCase());
  if(la!==lb) return la-lb;
  const ga = Number(a.grad_class||0), gb = Number(b.grad_class||0);
  if(gb!==ga) return gb-ga;              // newer class first
  return canon(a.display_name).localeCompare(canon(b.display_name));
}
async function loadRoster(){
  const rows = await fetchCSV(ROSTER_CSV_URL);
  const players = rows.map(r=>({
    display_name:r.display_name,
    first:r.first,last:r.last,
    level:String(r.level||'').toUpperCase(),
    status:r.status, grad_class:r.grad_class,
    team:r.team, org:r.org
  })).filter(p=>p.display_name);
  const byName = new Map(players.map(p=>[canon(p.display_name), p]));
  players.sort(defaultSort);
  return { players, byName };
}

/* ===== NEWS ===== */
function readFilters(){
  try{ return JSON.parse(localStorage.getItem(CACHE.filtersKey)||'{}'); }catch{ return {}; }
}
function writeFilters(F){ localStorage.setItem(CACHE.filtersKey, JSON.stringify(F)); }
function inDateRange(iso, F){
  if(!iso) return false;
  const d = new Date(iso);
  if(F.from && d < new Date(F.from)) return false;
  if(F.to && d > new Date(F.to)) return false;
  return true;
}
function makeNewsCard(n){
  const img = n.image || `https://picsum.photos/seed/${encodeURIComponent(n.id||n.title||'news')}/500/700`;
  const when = n.publishedAt ? new Date(n.publishedAt).toLocaleString() : '';
  const url = (n.url||'#') + ((n.url||'').includes('?')?'&':'?') + 'utm_source=yatstats';
  return `<a class="news-card" href="${url}" target="_blank" rel="noopener">
    <div class="thumb" style="background-image:url('${img}')"></div>
    <div style="flex:1;min-width:0">
      <div class="news-title">${n.title||'Read more'}</div>
      <div class="news-meta">${n.source||''}${when?` â€¢ ${when}`:''}</div>
      <div class="news-player">${n.player_display_name||''}</div>
    </div>
    <i class="ri-external-link-line" aria-hidden="true" style="opacity:.6"></i>
  </a>`;
}
function applyNewsFilters(list, rosterMap, F){
  const nameFilter = canon(F.name||'');
  const want = n=>{
    if(!inDateRange(n.publishedAt,F)) return false;
    const p = rosterMap.get(canon(n.player_display_name));
    if(!p) return false;

    if(F.status && F.status.size && !F.status.has(String(p.status||'').toUpperCase())) return false;
    if(F.level && F.level.size && !F.level.has(String(p.level||'').toUpperCase())) return false;
    if(F.grad && F.grad.size && !F.grad.has(String(p.grad_class||''))) return false;
    if(nameFilter && !canon(n.player_display_name).includes(nameFilter)) return false;
    return true;
  };
  return list.filter(want);
}

/* ===== GAMES / LINE SCORES =====
   GAMES CSV columns:
   A: player_name, B: daily_line_score, G: GameDateLocal, I: Opponent, J: HomeAway
*/
function weekStart(d){ const x=new Date(d); x.setHours(0,0,0,0); x.setDate(x.getDate()-x.getDay()); return x; } // Sunday
function fmtMonthDay(d){ return d.toLocaleDateString(undefined,{month:'numeric',day:'numeric'}); }
function fmtWeekTitle(d){ return d.toLocaleDateString(undefined,{month:'long',day:'numeric',year:'numeric'}); }
function normalizeHomeAway(s){
  const t=String(s||'').trim().toLowerCase();
  if(t.startsWith('@') || t==='a' || t==='away') return '@';
  return 'vs.';
}
function buildGameLine(row){
  // Prefer provided score line B; if empty, show DNP.
  let details = String(row.daily_line_score||'').trim();
  if(!details) details = 'DNP';
  const opp = String(row.Opponent||'').trim() || 'TBD';
  const ha = normalizeHomeAway(row.HomeAway);
  const d = new Date(row.GameDateLocal||row.Date||row.game_date||'');
  const datePart = isNaN(d) ? '' : fmtMonthDay(d);
  // date first, then location and details (no dash after player name per request)
  return { date: d, html: `<div class="line-row"><span class="date-pill">${datePart}</span><span class="line-text">${ha} ${opp} ${details ? ` ${details}` : ''}</span></div>` };
}
function applyPlayerFilters(p, F){
  if(F.status && F.status.size && !F.status.has(String(p.status||'').toUpperCase())) return false;
  if(F.level && F.level.size && !F.level.has(String(p.level||'').toUpperCase())) return false;
  if(F.grad && F.grad.size && !F.grad.has(String(p.grad_class||''))) return false;
  const q = canon(F.name||'');
  if(q && !canon(p.display_name).includes(q)) return false;
  return true;
}

/* ===== UI: Filters Drawer ===== */
function renderFilterBuckets({players}){
  const uniq = (arr)=> Array.from(new Set(arr)).filter(Boolean);

  const statuses = uniq(players.map(p=> String(p.status||'').toUpperCase())).sort();
  const levels   = uniq(players.map(p=> String(p.level||'').toUpperCase())).sort((a,b)=> LEVEL_ORDER.indexOf(a)-LEVEL_ORDER.indexOf(b));
  const classes  = uniq(players.map(p=> String(p.grad_class||''))).sort((a,b)=> Number(b)-Number(a));

  const templ = (name, items)=> items.map(v=>{
    const id=`flt-${name}-${v.replace(/[^a-z0-9]+/gi,'')}`;
    return `<label class="chk"><input type="checkbox" data-bucket="${name}" value="${v}" id="${id}"><span>${v}</span></label>`;
  }).join('');

  $('#fltStatus').innerHTML = `<label class="chk"><input type="checkbox" id="chkAllStatus"><span>Select All</span></label>${templ('status',statuses)}`;
  $('#fltLevel').innerHTML  = `<label class="chk"><input type="checkbox" id="chkAllLevel"><span>Select All</span></label>${templ('level',levels)}`;
  $('#fltClass').innerHTML  = `<label class="chk"><input type="checkbox" id="chkAllGrad"><span>Select All</span></label>${templ('grad',classes)}`;
}
function collectFilterState(){
  const getSet = bucket => new Set($$(`input[type=checkbox][data-bucket=${bucket}]:checked`).map(x=>x.value));
  const F = readFilters();
  F.name = $('#nameQuery').value.trim();
  F.status = getSet('status'); F.level = getSet('level'); F.grad = getSet('grad');
  F.from = $('#dateFrom').value || null;
  F.to   = $('#dateTo').value   || null;
  writeFilters(F);
  return F;
}
function hydrateFiltersFromState(){
  const F = readFilters();
  $('#nameQuery').value = F.name||'';
  if(F.from) $('#dateFrom').value = F.from;
  if(F.to)   $('#dateTo').value = F.to;

  // tick boxes
  for(const el of $$('input[type=checkbox][data-bucket]')) el.checked = false;
  const mark = (bucket,set)=> set && set.size && $$(`input[data-bucket=${bucket}]`).forEach(ch=>{ if(set.has(ch.value)) ch.checked=true; });
  mark('status', F.status); mark('level', F.level); mark('grad', F.grad);
}

/* ===== Main render ===== */
async function main(){
  const [{players,byName}, newsRaw, gamesRows] = await Promise.all([
    loadRoster(),
    (async()=>{
      try{
        const res = await fetch(NEWS_JSON_URL,{cache:'no-store'});
        if(!res.ok) return [];
        const arr = await res.json();
        return Array.isArray(arr)?arr:[];
      }catch(e){ console.warn('News JSON', e); return []; }
    })(),
    (async()=>{
      if(!GAMES_CSV_URL || GAMES_CSV_URL.startsWith('PUT_')) return [];
      try{ return await fetchCSV(GAMES_CSV_URL); }
      catch(e){ console.warn('Games CSV', e); return []; }
    })()
  ]);

  // init UI filters
  renderFilterBuckets({players});
  hydrateFiltersFromState();

  // default date range (last 21 days) if empty
  const Fnow = readFilters();
  const today = new Date();
  if(!Fnow.to){ $('#dateTo').value = today.toISOString().slice(0,10); }
  if(!Fnow.from){ const d=new Date(today); d.setDate(d.getDate()-21); $('#dateFrom').value = d.toISOString().slice(0,10); }

  const refreshAll = ()=>{
    const F = collectFilterState();

    /* ===== NEWS render ===== */
    const addRoster = n => ({...n, roster: byName.get(canon(n.player_display_name))});
    const news = newsRaw.map(addRoster).filter(n=> n.roster); // keep only known players
    const proNews = applyNewsFilters(news, byName, F).filter(n=> PRO_LEVELS.has(n.roster.level));
    const colNews = applyNewsFilters(news, byName, F).filter(n=> COL_LEVELS.has(n.roster.level));

    proNews.sort((a,b)=> new Date(b.publishedAt||0) - new Date(a.publishedAt||0));
    colNews.sort((a,b)=> new Date(b.publishedAt||0) - new Date(a.publishedAt||0));

    $('#listPro').innerHTML = proNews.map(makeNewsCard).join('');
    $('#listCollege').innerHTML = colNews.map(makeNewsCard).join('');
    $('#emptyPro').style.display = proNews.length ? 'none':'block';
    $('#emptyCollege').style.display = colNews.length ? 'none':'block';

    const weekTitleSuffix = ()=> {
      const from = $('#dateFrom').value, to = $('#dateTo').value;
      if(from && to){
        const fd = new Date(from), td=new Date(to);
        return ` â€“ ${fd.toLocaleDateString()} â†’ ${td.toLocaleDateString()}`;
      }
      return '';
    };
    $('#titlePro').textContent = `ALUMNI HEADLINES (PROS)${weekTitleSuffix()}`;
    $('#titleCol').textContent = `ALUMNI HEADLINES (COLLEGE)${weekTitleSuffix()}`;

    /* ===== LINE SCORES render (group by week -> player) ===== */
    if(!gamesRows.length){
      $('#linesWrap').innerHTML = `<div class="news-meta" style="padding:8px">No games CSV configured yet.</div>`;
      return;
    }
    const fromD = F.from ? new Date(F.from):null;
    const toD   = F.to   ? new Date(F.to):null;

    // Normalize rows we care about
    const rows = gamesRows.map(r=>{
      return {
        player_name: r.player_name || r.Player || r.player || '',
        daily_line_score: r.daily_line_score || r.line || r.score || '',
        GameDateLocal: r.GameDateLocal || r.date || r.Date || '',
        Opponent: r.Opponent || r.opp || '',
        HomeAway: r.HomeAway || r.ha || r.location || ''
      };
    }).filter(r=>r.player_name && r.GameDateLocal);

    // Filter by date range and by filters (via player mapping)
    const rowsWithRoster = rows.map(r=>{
      const p = byName.get(canon(r.player_name));
      const d = new Date(r.GameDateLocal);
      return {...r, _player:p, _date:d};
    }).filter(r=>{
      if(!r._player) return false;
      if(fromD && r._date < fromD) return false;
      if(toD && r._date > toD) return false;
      return applyPlayerFilters(r._player, F);
    });

    // Group: week -> player
    const groups = new Map(); // weekISO -> Map(playerKey -> {player, lines[]})
    for(const r of rowsWithRoster){
      const w = weekStart(r._date).toISOString();
      if(!groups.has(w)) groups.set(w, new Map());
      const byP = groups.get(w);
      const key = canon(r._player.display_name);
      if(!byP.has(key)) byP.set(key, {player:r._player, lines:[]});
      byP.get(key).lines.push(buildGameLine(r));
    }

    // Sort weeks newest â†’ oldest
    const weekEntries = Array.from(groups.entries()).sort((a,b)=> new Date(b[0]) - new Date(a[0]));

    // Build HTML
    const weekHTML = weekEntries.map(([wISO, byP])=>{
      // player order inside week
      const orderedPlayers = Array.from(byP.values()).map(x=>x.player).sort(defaultSort);
      const playersHTML = orderedPlayers.map(p=>{
        const pack = byP.get(canon(p.display_name));
        const lines = (pack?.lines||[]).sort((a,b)=> b.date - a.date).map(x=>x.html).join('');
        return `<div class="player-block">
                  <div class="player-name">${String(p.display_name||'').toUpperCase()}</div>
                  ${lines || `<div class="news-meta" style="padding:6px 8px">DNP</div>`}
                </div>`;
      }).join('');
      return `<div class="week-group">
                <div class="section-title">ALUMNI LINE SCORES â€“ WEEK OF ${fmtWeekTitle(new Date(wISO))}</div>
                ${playersHTML || `<div class="news-meta" style="padding:8px">No line scores this week.</div>`}
              </div>`;
    }).join('');

    $('#linesWrap').innerHTML = weekHTML || `<div class="news-meta" style="padding:8px">No line scores in range.</div>`;
  };

  // Initial render
  refreshAll();

  // Wire controls
  $('#btnRefresh').addEventListener('click', refreshAll);
  $('#openFilters').addEventListener('click', ()=> document.body.classList.add('drawer-open'));
  $('#closeFilters').addEventListener('click', ()=> document.body.classList.remove('drawer-open'));
  $('#btnDone').addEventListener('click', ()=>{ refreshAll(); document.body.classList.remove('drawer-open'); });
  $('#btnReset').addEventListener('click', ()=>{
    localStorage.removeItem(CACHE.filtersKey);
    hydrateFiltersFromState();
    refreshAll();
  });
}
main().catch(e=>{
  console.error(e);
  $('#listPro').innerHTML = `<div class="news-meta" style="padding:8px">Failed to load.</div>`;
});
</script>
</body>
</html>